## Docker 命名空间：容器隔离的核心

Linux 命名空间（Namespaces）是 Linux 内核提供的一项强大特性，为容器虚拟化奠定了基础。通过命名空间，每个容器可以拥有独立的运行环境，仿佛运行在一个独立的操作系统中。这种机制确保了容器之间的相互隔离，避免彼此干扰。Docker 正是利用这一特性，通过每次启动容器时调用 `setNamespaces` 方法，完成对各种命名空间的配置，从而实现高效的资源隔离和虚拟化。

在操作系统中，资源如内核、文件系统、网络、进程号（PID）、用户号（UID）、进程间通信（IPC）等通常由所有进程共享。要实现容器化虚拟化，不仅需要限制内存、CPU、网络 IO 和存储空间等资源，还必须隔离文件系统、网络、PID、UID 和 IPC 等资源。前者相对容易通过配置实现，而后者则依赖于宿主操作系统的深层支持。随着 Linux 内核对命名空间功能的不断完善，这些需求得以实现：进程可在彼此隔离的命名空间中运行，尽管它们共享同一个内核和部分运行时环境（如系统命令和库），但彼此不可见，且各自认为自己独占系统。

以下是 Docker 利用的六大命名空间及其功能的详细说明：

### 1. MNT Namespace：文件系统隔离

MNT（Mount）命名空间为每个容器提供了独立的根文件系统和用户空间。这意味着容器内的服务可以运行在与宿主机不同的环境中。例如，在一台 Ubuntu 宿主机上，可以启动一个基于 CentOS 的容器，并在其中运行 Nginx 服务，使用的运行环境完全基于 CentOS 的系统目录，而非宿主机的 Ubuntu 环境。

这种隔离通过 `chroot` 技术实现：宿主机将容器“锁定”到一个特定目录（如 `/var/lib/containerd/io.containerd.runtime.v1.linux/moby/容器ID`），容器内的进程无法访问宿主机的资源，从而确保文件系统的独立性。

### 2. IPC Namespace：进程间通信隔离

IPC（Inter-Process Communication）命名空间允许容器内的进程共享内存、缓存等数据，但禁止跨容器访问其他容器的数据。例如，容器 A 中的进程可以自由进行 IPC 操作，但无法与容器 B 的进程通信。这种隔离确保了容器内部通信的独立性和安全性。

### 3. UTS Namespace：主机名与域名隔离

UTS（UNIX Timesharing System）命名空间为容器提供了独立的主机名（hostname）和域名（domainname）。每个容器可以拥有自己的系统标识，与宿主机及其他容器无关。例如，容器 A 可以将主机名设为 `container-a`，而宿主机和其他容器完全不受影响。这种隔离让容器在网络配置和系统标识上更具灵活性。

### 4. PID Namespace：进程号隔离

PID（Process ID）命名空间为每个容器提供了独立的进程树。在 Linux 中，PID 为 1 的进程（如 `init` 或 `systemd`）是所有其他进程的父进程。Docker 通过 PID 命名空间为每个容器创建一个独立的 PID 1 进程，用于管理其子进程。这种隔离避免了容器间进程号冲突（例如多个容器内的 PID 可能相同），并确保容器内的主进程能够正常生成和回收子进程。

### 5. Net Namespace：网络隔离

Net（Network）命名空间为每个容器提供了独立的网络环境，包括网卡、监听端口和 TCP/IP 协议栈。Docker 通过创建虚拟以太网接口（如 `vethX`）实现这一点，并为容器分配桥接 IP 地址（通常绑定到 `docker0` 网桥）。这里的 `docker0` 是 Linux 的虚拟网桥，工作在 OSI 模型的数据链路层，通过 MAC 地址划分网络并转发数据。这种设计让容器拥有类似虚拟机的网络独立性。

### 6. User Namespace：用户与权限隔离

User 命名空间解决了容器间用户和用户组的重名问题。不同容器可以拥有相同的用户名、UID 或 GID，但这些用户的权限仅在各自容器内有效。例如，容器 A 和容器 B 可以同时拥有 UID 为 1000 的用户 `test`，但容器 A 的 `test` 无法访问容器 B 的文件系统，反之亦然。这种隔离增强了安全性，确保用户权限不会跨容器干扰。

### Linux 控制组（Cgroups）：资源限制的补充

命名空间实现了资源隔离，而 Linux 控制组（Control Groups，简称 Cgroups）则负责资源限制。如果不对容器施加限制，一个容器可能因代码问题（如内存泄漏）耗尽宿主机的资源。Cgroups 允许宿主机为容器设置资源上限，包括 CPU、内存、磁盘 IO 和网络带宽等。此外，Cgroups 还支持进程优先级调整、挂起和恢复等操作，确保容器运行稳定且不会影响宿主机或其他容器。

------

### 总结

Docker 通过六大命名空间（MNT、IPC、UTS、PID、Net、User）和 Cgroups 的协同工作，实现了容器的高效隔离和资源管理。命名空间确保容器拥有独立的运行环境，而 Cgroups 提供资源限制的保障。这种组合让 Docker 能够在同一宿主机上运行多个互不干扰的容器，兼顾灵活性与安全性，成为现代容器技术的基石。
