## kubeadm é«˜å¯ç”¨éƒ¨ç½²

### â€» è½¯ç¡¬ä»¶è¦æ±‚

| Rocky8.10    | `https://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.10-x86_64-dvd1.iso` |      |
| ------------ | ------------------------------------------------------------ | ---- |
| K8S-Master01 | 192.168.0.105                                                |      |
| K8S-Master02 | 192.168.0.106                                                |      |
| K8S-Master03 | 192.168.0.107                                                |      |
| K8S-Work01   | 192.168.0.115                                                |      |
| K8S-Work02   | 192.168.0.116                                                |      |
| kubeadm      | vsersion--1.31.4                                             |      |
| kubelet      | vsersion--1.31.4                                             |      |
| kubectl      | vsersion--1.31.4                                             |      |
| VIP          | 192.168.0.40                                                 |      |

### ä¸€ã€ğŸ˜¶â€ğŸŒ«ï¸åŸºç¡€ç¯å¢ƒé…ç½®

#### 1.1ï¼‰hosts 

```bash
hostnamectl set-hostname k8s-master01
hostnamectl set-hostname k8s-work01


cat >> /etc/hosts <<EOF

192.168.0.105 k8s-master01
192.168.0.106 k8s-master02
192.168.0.107 k8s-master03
192.168.0.115 k8s-work01
192.168.0.116 k8s-work02
EOF
```

#### 1.2ï¼‰sshd

```bash
ssh-keygen -t rsa
for i in K8S-Master01 K8S-Master02 K8S-Master03 K8S-Work01 K8S-Work02; do ssh-copy-id -i .ssh/id_rsa.pub $i;done

# master01 é…ç½®å®Œæˆå å°†æ–‡ä»¶copyä¸€ä»½ç»™åˆ°å…¶ä»–masteræœºå™¨
scp ~/.ssh/id_rsa root@K8S-Master02:~/.ssh/
scp ~/.ssh/id_rsa root@K8S-Master03:~/.ssh/

#ä¼˜åŒ– sshd æœåŠ¡é…ç½®
sed -i 's@#UseDNS yes@UseDNS no@g' /etc/ssh/sshd_config
sed -i 's@^GSSAPIAuthentication yes@GSSAPIAuthentication no@g' /etc/ssh/sshd_config
#- UseDNSé€‰é¡¹:
#æ‰“å¼€çŠ¶æ€ä¸‹ï¼Œå½“å®¢æˆ·ç«¯è¯•å›¾ç™»å½•SSHæœåŠ¡å™¨æ—¶ï¼ŒæœåŠ¡å™¨ç«¯å…ˆæ ¹æ®å®¢æˆ·ç«¯çš„IPåœ°å€è¿›è¡ŒDNS PTRåå‘æŸ¥è¯¢å‡ºå®¢æˆ·ç«¯çš„ä¸»æœºåï¼Œç„¶åæ ¹æ®æŸ¥è¯¢å‡ºçš„å®¢æˆ·ç«¯ä¸»æœºåè¿›è¡ŒDNSæ­£å‘Aè®°å½•æŸ¥è¯¢ï¼ŒéªŒè¯ä¸å…¶åŸå§‹IPåœ°å€æ˜¯å¦ä¸€è‡´ï¼Œè¿™æ˜¯é˜²æ­¢å®¢æˆ·ç«¯æ¬ºéª—çš„ä¸€ç§æªæ–½ï¼Œä½†ä¸€èˆ¬æˆ‘ä»¬çš„æ˜¯åŠ¨æ€IPä¸ä¼šæœ‰PTRè®°å½•ï¼Œæ‰“å¼€è¿™ä¸ªé€‰é¡¹ä¸è¿‡æ˜¯åœ¨ç™½ç™½æµªè´¹æ—¶é—´è€Œå·²ï¼Œä¸å¦‚å°†å…¶å…³é—­ã€‚
#- GSSAPIAuthentication:
#å½“è¿™ä¸ªå‚æ•°å¼€å¯ï¼ˆ GSSAPIAuthentication  yes ï¼‰çš„æ—¶å€™ï¼Œé€šè¿‡SSHç™»é™†æœåŠ¡å™¨æ—¶å€™ä¼šæœ‰äº›ä¼šå¾ˆæ…¢ï¼è¿™æ˜¯ç”±äºæœåŠ¡å™¨ç«¯å¯ç”¨äº†GSSAPIã€‚ç™»é™†çš„æ—¶å€™å®¢æˆ·ç«¯éœ€è¦å¯¹æœåŠ¡å™¨ç«¯çš„IPåœ°å€è¿›è¡Œåè§£æï¼Œå¦‚æœæœåŠ¡å™¨çš„IPåœ°å€æ²¡æœ‰é…ç½®PTRè®°å½•ï¼Œé‚£ä¹ˆå°±å®¹æ˜“åœ¨è¿™é‡Œå¡ä½äº†ã€‚
```

#### 1.3ï¼‰basicCfg

```bash
#bash colour
cat <<EOF >>  ~/.bashrc 
PS1='[\[\e[34;1m\]\u@\[\e[0m\]\[\e[32;1m\]\H\[\e[0m\]\[\e[31;1m\] \W\[\e[0m\]]# '
EOF
source ~/.bashrc

systemctl disable --now firewalld dnsmasq

setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config

swapoff -a && sysctl -w vm.swappiness=0
sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab

sed -e 's|^mirrorlist=|#mirrorlist=|g' \
    -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
    -i.bak \
    /etc/yum.repos.d/Rocky-*.repo
dnf makecache

# -e 's|^mirrorlist=|#mirrorlist=|g'ï¼šæ³¨é‡Šæ‰æ‰€æœ‰ mirrorlist è¡Œã€‚
# -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'ï¼šå–æ¶ˆæ³¨é‡Šå¹¶æ›¿æ¢ baseurl åœ°å€ä¸ºé˜¿é‡Œäº‘é•œåƒæºåœ°å€ã€‚
# -i.bakï¼šå¯¹æ–‡ä»¶è¿›è¡ŒåŸåœ°ä¿®æ”¹ï¼ŒåŒæ—¶å¤‡ä»½ .bak æ–‡ä»¶ã€‚

yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y

#chrony
dnf install epel-release -y
sudo dnf install -y chrony
cp /etc/chrony.conf{,`date +%F`}
sudo sed -i 's/^pool.*/server ntp.aliyun.com iburst\nserver ntp1.aliyun.com iburst\nserver ntp2.aliyun.com iburst/' /etc/chrony.conf
sudo systemctl enable --now chronyd
sudo chronyc -a makestep
# éªŒè¯ï¼š  chronyc sources -v


# config limit
ulimit -SHn 65535
cat >> /etc/security/limits.conf <<EOF
* soft nofile 65536
* hard nofile 131072
* soft nproc 65535
* hard nproc 655350
* soft memlock unlimited
* hard memlock unlimited
EOF

yum update -y
```

#### 1.4ï¼‰kernel

```bash
#æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ipvsadmï¼š
yum install ipvsadm ipset sysstat conntrack libseccomp -y


#æ‰€æœ‰èŠ‚ç‚¹é…ç½®ipvsæ¨¡å—ï¼š
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
#æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºipvs.confï¼Œå¹¶é…ç½®å¼€æœºè‡ªåŠ¨åŠ è½½ï¼šåŠ å…¥ä»¥ä¸‹å†…å®¹
cat >> /etc/modules-load.d/ipvs.conf <<EOF

ip_vs
ip_vs_lc
ip_vs_wlc
ip_vs_rr
ip_vs_wrr
ip_vs_lblc
ip_vs_lblcr
ip_vs_dh
ip_vs_sh
ip_vs_fo
ip_vs_nq
ip_vs_sed
ip_vs_ftp
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF
systemctl enable --now systemd-modules-load.service


cat <<EOF > /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
fs.may_detach_mounts = 1
net.ipv4.conf.all.route_localnet = 1
vm.overcommit_memory=1
vm.panic_on_oom=0
fs.inotify.max_user_watches=89100
fs.file-max=52706963
fs.nr_open=52706963
net.netfilter.nf_conntrack_max=2310720

net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl =15
net.ipv4.tcp_max_tw_buckets = 36000
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_max_orphans = 327680
net.ipv4.tcp_orphan_retries = 3
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.ip_conntrack_max = 65536
net.ipv4.tcp_max_syn_backlog = 16384
net.ipv4.tcp_timestamps = 0
net.core.somaxconn = 16384
EOF

sysctl --system



# å¯¼å…¥ ELRepo GPG å¯†é’¥
sudo rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org

# å®‰è£… ELRepo ä»“åº“
sudo dnf install -y https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm

# æ›¿æ¢ ELRepo é•œåƒæºä¸ºé˜¿é‡Œäº‘
sudo sed -i 's/mirrors.elrepo.org/mirrors.aliyun.com\/elrepo/g' /etc/yum.repos.d/elrepo.repo

# æ¸…ç†ç¼“å­˜å¹¶é‡å»º
#sudo dnf clean all
sudo dnf makecache

# è·å–å†…æ ¸åˆ—è¡¨
sudo dnf --disablerepo=* --enablerepo=elrepo-kernel list available
# å®‰è£… 5.4 LTS å†…æ ¸ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
sudo dnf --enablerepo=elrepo-kernel install kernel-lt -y
```

  æ‰€æœ‰èŠ‚ç‚¹é…ç½®å®Œå†…æ ¸åï¼Œé‡å¯æœºå™¨ï¼Œä¹‹åæŸ¥çœ‹å†…æ ¸æ¨¡å—æ˜¯å¦å·²è‡ªåŠ¨åŠ è½½ï¼š

```bash
reboot
lsmod | grep --color=auto -e ip_vs -e nf_conntrack
```

### äºŒã€ğŸš€é«˜å¯ç”¨ç»„ä»¶å®‰è£…(master)

#### 2.1ï¼‰keepalived & haproxy install

```bash
yum install keepalived haproxy -y
cp /etc/haproxy/haproxy.cfg{,`date +%F`}

#æ‰€æœ‰èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶å†…å®¹ç›¸åŒ
cat > /etc/haproxy/haproxy.cfg <<'EOF'
global
  maxconn  2000
  ulimit-n  16384
  log  127.0.0.1 local0 err
  stats timeout 30s

defaults
  log global
  mode  http
  option  httplog
  timeout connect 5000
  timeout client  50000
  timeout server  50000
  timeout http-request 15s
  timeout http-keep-alive 15s

frontend monitor-haproxy
  bind *:33305
  mode http
  option httplog
  monitor-uri /ayouok

frontend k8s
  bind 0.0.0.0:16443
  bind 127.0.0.1:16443
  mode tcp
  option tcplog
  tcp-request inspect-delay 5s
  default_backend k8s

backend k8s
  mode tcp
  option tcplog
  option tcp-check
  balance roundrobin
  default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100
  server master01   192.168.0.105:6443  check
  server master02   192.168.0.106:6443  check
  server master03   192.168.0.107:6443  check
EOF
```

#### 2.2ï¼‰keepalived cfg

```bash
cp /etc/keepalived/keepalived.conf{,`date +%F`}

#105 cfg
cat > /etc/keepalived/keepalived.conf <<'EOF'
global_defs {
    router_id LVS_DEVEL
script_user root
    enable_script_security
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5
    weight -5
    fall 2  
rise 1
}
vrrp_instance VI_1 {
    state MASTER
    interface ens160
    mcast_src_ip 192.168.0.105
    virtual_router_id 51
    priority 101
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.40
    }
    track_script {
       chk_apiserver
    }
}	
EOF


#106 cfg
cat > /etc/keepalived/keepalived.conf <<'EOF'
global_defs {
    router_id LVS_DEVEL
script_user root
    enable_script_security
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
   interval 5
    weight -5
    fall 2  
rise 1
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens160
    mcast_src_ip 192.168.0.106
    virtual_router_id 51
    priority 100
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.40
    }
    track_script {
       chk_apiserver
    }
}
EOF


#107 cfg
cat > /etc/keepalived/keepalived.conf <<'EOF'
global_defs {
    router_id LVS_DEVEL
script_user root
    enable_script_security
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
 interval 5
    weight -5
    fall 2  
rise 1
}
vrrp_instance VI_1 {
    state BACKUP
    interface ens160
    mcast_src_ip 192.168.0.107
    virtual_router_id 51
    priority 100
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        192.168.0.40
    }
    track_script {
       chk_apiserver
    }
}
EOF


# 105ã€106ã€107
cat >/etc/keepalived/check_apiserver.sh <<'EOF'
#!/bin/bash

err=0
for k in $(seq 1 3)
do
    check_code=$(pgrep haproxy)
    if [[ $check_code == "" ]]; then
        err=$(expr $err + 1)
        sleep 1
        continue
    else
        err=0
        break
    fi
done

if [[ $err != "0" ]]; then
    echo "systemctl stop keepalived"
    /usr/bin/systemctl stop keepalived
    exit 1
else
    exit 0
fi
EOF
chmod +x /etc/keepalived/check_apiserver.sh
systemctl daemon-reload 
systemctl enable --now haproxy keepalived
```

### ä¸‰ã€Runtime ğŸ˜’(all node install)

```bash
yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum install containerd.io -y
cat > /etc/modules-load.d/containerd.conf <<EOF
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

cat > /etc/sysctl.d/99-kubernetes-cri.conf <<EOF
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
sudo sysctl --system

sudo mkdir -p /etc/containerd
containerd config default | sudo cat > /etc/containerd/config.toml

sed -i 's#SystemdCgroup = false#SystemdCgroup =true#g' /etc/containerd/config.toml
sed -i 's#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g' /etc/containerd/config.toml
sed -i 's#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g' /etc/containerd/config.toml
sed -i 's#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g' /etc/containerd/config.toml

# å¯åŠ¨Containerd
systemctl daemon-reload
systemctl enable --now containerd
```

### å››ã€ğŸ’©kubeadm

#### 4.1 å®‰è£…kubeadm

```bash
#æ³¨æ„ç‰ˆæœ¬å·çš„æ›´æ¢ï¼Œéœ€è¦å®‰è£…ä»€ä¹ˆç‰ˆæœ¬çš„k8sï¼ŒæŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹å³å¯
cat > /etc/yum.repos.d/kubernetes.repo <<EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/repodata/repomd.xml.key
EOF



# é¦–å…ˆåœ¨Master01èŠ‚ç‚¹æŸ¥çœ‹æœ€æ–°çš„Kubernetesç‰ˆæœ¬æ˜¯å¤šå°‘ï¼š
yum list kubeadm.x86_64 --showduplicates | sort -r

yum install kubeadm-1.32.* kubelet-1.32.* kubectl-1.32.* -y
systemctl enable --now kubelet

# ä¸‹è½½é•œåƒ
kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version 1.32.3

[root@K8S-Master01 ~]# kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version 1.32.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.32.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.32.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.32.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.32.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.11.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.10
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.16-0
```

![image-20250105224236996](./images/kubeadmé«˜å¯ç”¨éƒ¨ç½²/image-20250105224236996.png)

#### 4.2 Master01èŠ‚ç‚¹åˆå§‹åŒ–

```bash
kubeadm init \
  --apiserver-advertise-address 192.168.0.105 \
  --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \
  --cri-socket unix:///var/run/containerd/containerd.sock \
  --kubernetes-version v1.32.3 \
  --control-plane-endpoint 192.168.0.40:16443 \
  --pod-network-cidr 172.16.0.0/16 \
  --service-cidr 10.96.0.0/16 \
  --upload-certs \
  --apiserver-cert-extra-sans 192.168.0.105,192.168.0.106,192.168.0.107,192.168.0.40


#é…ç½®kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# ç‰ˆæœ¬éœ€è¦æ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·
#--apiserver-advertise-address 192.168.0.105: å½“å‰èŠ‚ç‚¹çš„IPï¼ˆMaster01ï¼‰
#--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers: æŒ‡å®šå®¹å™¨é•œåƒä»“åº“ã€‚
#--cri-socket unix:///var/run/containerd/containerd.sock: æŒ‡å®šCRIå¥—æ¥å­—ã€‚
#--kubernetes-version v1.31.4: æŒ‡å®šKubernetesç‰ˆæœ¬ã€‚
#--control-plane-endpoint 192.168.0.40:6443: æŒ‡å®šæ§åˆ¶å¹³é¢çš„VIPåœ°å€å’Œç«¯å£ã€‚
#--pod-network-cidr 172.16.0.0/16: æŒ‡å®šPodç½‘ç»œçš„CIDRèŒƒå›´ã€‚
#--service-cidr 10.96.0.0/16: æŒ‡å®šServiceç½‘æ®µçš„CIDRèŒƒå›´ã€‚  
#--upload-certs:  è‡ªåŠ¨ä¸Šä¼ è¯ä¹¦ä¾›å…¶ä»–MasterèŠ‚ç‚¹ä½¿ç”¨
#--apiserver-cert-extra-sans 192.168.0.105,192.168.0.106,192.168.0.107,192.168.0.40: æ‰€æœ‰MasterèŠ‚ç‚¹IPå’ŒVIP
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of control-plane nodes running the following command on each as root:

  kubeadm join 192.168.0.40:16443 --token yblol0.nkogzj5dm2w7s4s8 \
	--discovery-token-ca-cert-hash sha256:4b805f3ad2231e3ed2655ad5f2912b6bf1df9ae1f4e7c7aadde5ffcb2d0b618b \
	--control-plane --certificate-key b4dc0b3ee0ed28b8fdd659ee664c4da66da6b989c61b14e29b76373207e5d8a9

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
"kubeadm init phase upload-certs --upload-certs" to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.0.40:16443 --token yblol0.nkogzj5dm2w7s4s8 \
	--discovery-token-ca-cert-hash sha256:4b805f3ad2231e3ed2655ad5f2912b6bf1df9ae1f4e7c7aadde5ffcb2d0b618b 
```

> [!NOTE]
>
> **åœ¨åŠ å…¥åˆ°é›†ç¾¤çš„æ—¶å€™ä¼šè‡ªåŠ¨åŒæ­¥è¯ä¹¦å’Œé…ç½®æ–‡ä»¶ï¼ŒworkèŠ‚ç‚¹ä»…åŒæ­¥è¯ä¹¦ï¼Œä¸éœ€è¦æ‰‹å·¥åŒæ­¥**

#### 4.3 MasterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤

```bash
kubeadm join 192.168.0.40:16443 --token yblol0.nkogzj5dm2w7s4s8 \
	--discovery-token-ca-cert-hash sha256:4b805f3ad2231e3ed2655ad5f2912b6bf1df9ae1f4e7c7aadde5ffcb2d0b618b \
	--control-plane --certificate-key b4dc0b3ee0ed28b8fdd659ee664c4da66da6b989c61b14e29b76373207e5d8a9
```

#### 4.4 WorkèŠ‚ç‚¹åŠ å…¥é›†ç¾¤

```bash
kubeadm join 192.168.0.40:16443 --token yblol0.nkogzj5dm2w7s4s8 \
	--discovery-token-ca-cert-hash sha256:4b805f3ad2231e3ed2655ad5f2912b6bf1df9ae1f4e7c7aadde5ffcb2d0b618b
```

#### 4.5 å®‰è£…Addons å®‰è£…

æ‰€æœ‰èŠ‚ç‚¹ç¦æ­¢NetworkManagerç®¡ç†Calicoçš„ç½‘ç»œæ¥å£ï¼Œé˜²æ­¢æœ‰å†²çªæˆ–å¹²æ‰°ï¼š

```bash
cat >>/etc/NetworkManager/conf.d/calico.conf<<EOF
[keyfile]
unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali
EOF
systemctl daemon-reload
systemctl restart NetworkManager
```

Master01

```bash
git clone https://gitee.com/dukuan/k8s-ha-install.git && git checkout manual-installation-v1.32.x && cd calico/

POD_SUBNET=`cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr= | awk -F= '{print $NF}'`

sed -i "s#POD_CIDR#${POD_SUBNET}#g" calico.yaml
kubectl apply -f calico.yaml
```

metricså®‰è£…

```bash
for i in  K8S-Work01 K8S-Work02;do  scp /etc/kubernetes/pki/front-proxy-ca.crt $i:/etc/kubernetes/pki/ ;done
cd /root/k8s-ha-install/kubeadm-metrics-server
kubectl  create -f comp.yaml 


[root@K8S-Master01 kubeadm-metrics-server]# kubectl top node
NAME           CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)   
k8s-master01   668m         16%      1674Mi          44%         
k8s-master02   333m         16%      1234Mi          32%         
k8s-master03   451m         22%      1553Mi          40%         
k8s-work01     230m         11%      1114Mi          29%         
k8s-work02     317m         15%      1208Mi          31% 
```

#### 4.6 æŸ¥çœ‹é›†ç¾¤

```bash
[root@K8S-Master01 calico]# kubectl get node -owide
NAME           STATUS   ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                            KERNEL-VERSION                CONTAINER-RUNTIME
k8s-master01   Ready    control-plane   12m   v1.32.3   192.168.0.105   <none>        Rocky Linux 8.10 (Green Obsidian)   5.4.291-1.el8.elrepo.x86_64   containerd://1.6.32
k8s-master02   Ready    control-plane   11m   v1.32.3   192.168.0.106   <none>        Rocky Linux 8.10 (Green Obsidian)   5.4.291-1.el8.elrepo.x86_64   containerd://1.6.32
k8s-master03   Ready    control-plane   10m   v1.32.3   192.168.0.107   <none>        Rocky Linux 8.10 (Green Obsidian)   5.4.291-1.el8.elrepo.x86_64   containerd://1.6.32
k8s-work01     Ready    <none>          10m   v1.32.3   192.168.0.115   <none>        Rocky Linux 8.10 (Green Obsidian)   5.4.291-1.el8.elrepo.x86_64   containerd://1.6.32
k8s-work02     Ready    <none>          10m   v1.32.3   192.168.0.116   <none>        Rocky Linux 8.10 (Green Obsidian)   5.4.291-1.el8.elrepo.x86_64   containerd://1.6.32
```

## ã€ğŸ¼ã€‘æ³¨æ„äº‹é¡¹

**å°†Kube-proxyæ”¹ä¸ºipvsæ¨¡å¼ï¼Œå› ä¸ºåœ¨åˆå§‹åŒ–é›†ç¾¤çš„æ—¶å€™æ³¨é‡Šäº†ipvsé…ç½®ï¼Œæ‰€ä»¥éœ€è¦è‡ªè¡Œä¿®æ”¹ä¸€ä¸‹ï¼š**

åœ¨master01èŠ‚ç‚¹æ‰§è¡Œï¼š

```bash
kubectl edit cm kube-proxy -n kube-system

mode: ipvs
```

æ›´æ–°Kube-Proxyçš„Podï¼š

```bash
kubectl patch daemonset kube-proxy -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"date\":\"`date +'%s'`\"}}}}}" -n kube-system
```

éªŒè¯Kube-Proxyæ¨¡å¼

```bash
[root@k8s-master01]# curl 127.0.0.1:10249/proxyMode

ipvs
```




> [!CAUTION]   
>
> kubeadmå®‰è£…çš„é›†ç¾¤ï¼Œè¯ä¹¦æœ‰æ•ˆæœŸé»˜è®¤æ˜¯ä¸€å¹´ã€‚masterèŠ‚ç‚¹çš„kube-apiserverã€kube-schedulerã€kube-controller-managerã€etcdéƒ½æ˜¯ä»¥å®¹å™¨è¿è¡Œçš„ã€‚å¯ä»¥é€šè¿‡kubectl get po -n kube-systemæŸ¥çœ‹ã€‚

**å¯åŠ¨å’ŒäºŒè¿›åˆ¶ä¸åŒçš„æ˜¯:**

- kubeletçš„é…ç½®æ–‡ä»¶åœ¨/etc/sysconfig/kubeletå’Œ/var/lib/kubelet/config.yamlï¼Œä¿®æ”¹åéœ€è¦é‡å¯kubeletè¿›ç¨‹
- å…¶ä»–ç»„ä»¶çš„é…ç½®æ–‡ä»¶åœ¨/etc/kubernetes/manifestsç›®å½•ä¸‹ï¼Œæ¯”å¦‚kube-apiserver.yamlï¼Œè¯¥yamlæ–‡ä»¶æ›´æ”¹åï¼Œkubeletä¼šè‡ªåŠ¨åˆ·æ–°é…ç½®ï¼Œä¹Ÿå°±æ˜¯ä¼šé‡å¯podã€‚ä¸èƒ½å†æ¬¡åˆ›å»ºè¯¥æ–‡ä»¶

kube-proxyçš„é…ç½®åœ¨kube-systemå‘½åç©ºé—´ä¸‹çš„configmapä¸­ï¼Œå¯ä»¥é€šè¿‡ `kubectl edit cm kube-proxy -n kube-system` è¿›è¡Œæ›´æ”¹ï¼Œæ›´æ”¹å®Œæˆåï¼Œå¯ä»¥é€šè¿‡patché‡å¯kube-proxy

```bash
kubectl patch daemonset kube-proxy -p "{\"spec\":{\"template\":{\"metadata\":{\"annotations\":{\"date\":\"`date +'%s'`\"}}}}}" -n kube-system 
```

**masterèŠ‚ç‚¹è‡ªå¸¦æ±¡ç‚¹ï¼š**

Kubeadmå®‰è£…åï¼ŒmasterèŠ‚ç‚¹é»˜è®¤ä¸å…è®¸éƒ¨ç½²podï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼åˆ é™¤Taintï¼Œå³å¯éƒ¨ç½²Podï¼š

```bash
æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹
[root@K8S-Master01 ~]# kubectl describe node |grep "Taints:"
Taints:             node-role.kubernetes.io/control-plane:NoSchedule
Taints:             node-role.kubernetes.io/control-plane:NoSchedule
Taints:             node-role.kubernetes.io/control-plane:NoSchedule
Taints:             <none>
Taints:             <none>

#ç§»é™¤æ±¡ç‚¹å‘½ä»¤æ ¼å¼
kubectl taint nodes <node-name> <taint-key>:<taint-value>-

# ç§»é™¤k8s-master02 ã€k8s-master03çš„æ±¡ç‚¹
kubectl taint nodes k8s-master02 node-role.kubernetes.io/control-plane:NoSchedule-
kubectl taint nodes k8s-master03 node-role.kubernetes.io/control-plane:NoSchedule-
# éªŒè¯
[root@K8S-Master01 ~]# kubectl describe node |grep "Taints:"
Taints:             node-role.kubernetes.io/control-plane:NoSchedule
Taints:             <none>
Taints:             <none>
Taints:             <none>
Taints:             <none>

#æ‰¹é‡åˆ é™¤æ‰€æœ‰å¸¦æœ‰ node-role.kubernetes.io/control-plane æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹
kubectl taint node -l node-role.kubernetes.io/control-plane node-role.kubernetes.io/control-plane:NoSchedule-
```





