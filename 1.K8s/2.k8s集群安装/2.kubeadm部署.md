## kubeadm éƒ¨ç½² kubernetes

### â€» è½¯ç¡¬ä»¶è¦æ±‚

| Rocky8.10  | `https://download.rockylinux.org/pub/rocky/8/isos/x86_64/Rocky-8.10-x86_64-dvd1.iso` |      |
| ---------- | ------------------------------------------------------------ | ---- |
| K8S-Master | 192.168.0.105                                                |      |
| K8S-Works  | 192.168.0.106                                                |      |
| kubeadm    | vsersion--1.31.4                                             |      |
| kubelet    | vsersion--1.31.4                                             |      |
| kubectl    | vsersion--1.31.4                                             |      |

**ä¿®æ”¹ä¸»æœºåç§°**

```bash
hostnamectl set-hostname K8S-Master
hostnamectl set-hostname K8S-Works
```

### 1.åŸºç¡€ç¯å¢ƒæ­å»º

```bash
systemctl disable --now firewalld
systemctl disable --now dnsmasq

setenforce 0
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/sysconfig/selinux
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config

swapoff -a && sysctl -w vm.swappiness=0
sed -ri '/^[^#]*swap/s@^@#@' /etc/fstab

sed -e 's|^mirrorlist=|#mirrorlist=|g' \
    -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
    -i.bak \
    /etc/yum.repos.d/Rocky-*.repo
dnf makecache

# -e 's|^mirrorlist=|#mirrorlist=|g'ï¼šæ³¨é‡Šæ‰æ‰€æœ‰ mirrorlist è¡Œã€‚
# -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'ï¼šå–æ¶ˆæ³¨é‡Šå¹¶æ›¿æ¢ baseurl åœ°å€ä¸ºé˜¿é‡Œäº‘é•œåƒæºåœ°å€ã€‚
# -i.bakï¼šå¯¹æ–‡ä»¶è¿›è¡ŒåŸåœ°ä¿®æ”¹ï¼ŒåŒæ—¶å¤‡ä»½ .bak æ–‡ä»¶ã€‚

yum install wget jq psmisc vim net-tools telnet yum-utils device-mapper-persistent-data lvm2 git -y

#æ³¨æ„ç‰ˆæœ¬å·çš„æ›´æ¢ï¼Œéœ€è¦å®‰è£…ä»€ä¹ˆç‰ˆæœ¬çš„k8sï¼ŒæŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹å³å¯
cat > /etc/yum.repos.d/kubernetes.repo <<EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.31/rpm/
enabled=1
gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.31/rpm/repodata/repomd.xml.key
EOF

yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
```

### 2.å®‰è£…containerd

```bash
yum install containerd.io -y
cat > /etc/modules-load.d/containerd.conf <<EOF
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

cat > /etc/sysctl.d/99-kubernetes-cri.conf <<EOF
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF
sudo sysctl --system

sudo mkdir -p /etc/containerd
containerd config default | sudo cat > /etc/containerd/config.toml

sed -i 's#SystemdCgroup = false#SystemdCgroup =true#g' /etc/containerd/config.toml
sed -i 's#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g' /etc/containerd/config.toml
sed -i 's#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g' /etc/containerd/config.toml
sed -i 's#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g' /etc/containerd/config.toml

# å¯åŠ¨Containerd
systemctl daemon-reload
systemctl enable --now containerd
```

### 3.ğŸ’©å®‰è£…kubeadm

```bash
yum install kubeadm-1.31.* kubelet-1.31.* kubectl-1.31.* -y
systemctl enable --now kubelet

# ä¸‹è½½é•œåƒ
kubeadm config images pull --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version 1.31.4

[root@localhost ~]# kubeadm config images pull \
> --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version 1.31.4
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.31.4
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.31.4
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.31.4
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.31.4
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.11.3
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.10
[config/images] Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.15-0
```

![image-20250105224236996](./images/1.kubeadm%E9%83%A8%E7%BD%B2/image-20250105224236996.png)

#### 3.1 MasterèŠ‚ç‚¹åˆå§‹åŒ–

```bash
kubeadm init --apiserver-advertise-address 192.168.0.105 --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --cri-socket "unix:///var/run/containerd/containerd.sock" --kubernetes-version 1.31.4 
# ç‰ˆæœ¬éœ€è¦æ›¿æ¢ä¸ºå®é™…ç‰ˆæœ¬å·


Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.0.105:6443 --token su6wcn.5qw19ib5lc9vb3xm \
	--discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde 

```

#### 3.2 WorkèŠ‚ç‚¹åŠ å…¥é›†ç¾¤

```bash
kubeadm join 192.168.0.105:6443 --token su6wcn.5qw19ib5lc9vb3xm \
	--discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde
```

#### 3.3 ä¸ºMasterèŠ‚ç‚¹é…ç½®kubectl

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

#### 3.4 å®‰è£…Addons å®‰è£…

```bash
git clone https://gitee.com/dukuan/k8s-ha-install.git
cd k8s-ha-install
kubectl create -f calico.yaml
kubectl create -f krm.yaml
```

#### 3.5 æŸ¥çœ‹é›†ç¾¤

```bash
[root@K8S-Master k8s-ha-install]# kubectl get node -owide
NAME         STATUS   ROLES           AGE   VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                            KERNEL-VERSION             CONTAINER-RUNTIME
k8s-master   Ready    control-plane   32h   v1.31.4   192.168.0.105   <none>        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.el8_10.x86_64   containerd://1.6.32
k8s-works    Ready    <none>          32h   v1.31.4   192.168.0.106   <none>        Rocky Linux 8.10 (Green Obsidian)   4.18.0-553.el8_10.x86_64   containerd://1.6.32
```

### 4.ğŸš€é›†ç¾¤æ‰©å®¹

#### å…³é”®è¯´æ˜

1. **Worker èŠ‚ç‚¹**ï¼šç›´æ¥ä½¿ç”¨æ™®é€š `kubeadm join` å‘½ä»¤ã€‚
2. **Master èŠ‚ç‚¹**ï¼šå¿…é¡»åŠ  `--control-plane --certificate-key` å‚æ•°ã€‚
3. **ç«¯å£å¼€æ”¾**ï¼šç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹èƒ½è®¿é—® Master çš„ `6443` ç«¯å£ã€‚

#### 4.1 Worker èŠ‚ç‚¹åŠ å…¥

1. ç”Ÿæˆæ–°çš„ Tokenï¼ˆåœ¨ç°æœ‰ Master èŠ‚ç‚¹æ‰§è¡Œï¼‰

```bash
# ç”Ÿæˆæ–° Tokenï¼ˆæœ‰æ•ˆæœŸé»˜è®¤24å°æ—¶ï¼‰
kubeadm token create --print-join-command
kubeadm join 192.168.0.105:6443 --token wzi8kz.ig2xfa11393fm19a --discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde 
```

2. åœ¨ Worker èŠ‚ç‚¹æ‰§è¡Œä¸Šè¿°å‘½ä»¤

```bash
kubeadm join 192.168.0.105:6443 --token wzi8kz.ig2xfa11393fm19a --discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde 
```

------

#### 4.2 Master èŠ‚ç‚¹åŠ å…¥

1. ç”Ÿæˆè¯ä¹¦å¯†é’¥ï¼ˆåœ¨ç°æœ‰ Master èŠ‚ç‚¹æ‰§è¡Œï¼‰

```bash
# ç”Ÿæˆæ–°çš„è¯ä¹¦å¯†é’¥ï¼ˆç”¨äºç­¾å‘æ–° Master çš„è¯ä¹¦ï¼‰
kubeadm init phase upload-certs --upload-certs

W0313 23:31:20.843675  151933 version.go:109] could not fetch a Kubernetes version from the internet: unable to get URL "https://dl.k8s.io/release/stable-1.txt": Get "https://cdn.dl.k8s.io/release/stable-1.txt": dial tcp 146.75.113.55:443: i/o timeout (Client.Timeout exceeded while awaiting headers)
W0313 23:31:20.843849  151933 version.go:110] falling back to the local client version: v1.31.4
[upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kube-system" Namespace
[upload-certs] Using certificate key:
c41bd7777ca63bad307a468e99871fdbdf9bdd2ef3fb9d00b35e02d39d8d827e
```

2. ç”Ÿæˆ Master èŠ‚ç‚¹çš„å®Œæ•´ Join å‘½ä»¤

```bash
# ç”ŸæˆåŒ…å«è¯ä¹¦å¯†é’¥çš„ Join å‘½ä»¤ï¼ˆæœ‰æ•ˆæœŸ2å°æ—¶ï¼‰
kubeadm token create --certificate-key <ä¸Šä¸€æ­¥çš„è¯ä¹¦å¯†é’¥> --print-join-command

kubeadm token create --certificate-key c41bd7777ca63bad307a468e99871fdbdf9bdd2ef3fb9d00b35e02d39d8d827e --print-join-command
kubeadm join 192.168.0.105:6443 --token xhq1z2.5jsq35embtahsa7e --discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde --control-plane --certificate-key c41bd7777ca63bad307a468e99871fdbdf9bdd2ef3fb9d00b35e02d39d8d827e
```

3. åœ¨æ–° Master èŠ‚ç‚¹æ‰§è¡Œä¸Šè¿°å‘½ä»¤

```bash
kubeadm join 192.168.0.105:6443 \
	--token xhq1z2.5jsq35embtahsa7e \
	--discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde \
	--control-plane \
	--certificate-key c41bd7777ca63bad307a468e99871fdbdf9bdd2ef3fb9d00b35e02d39d8d827e
```

### FAQ:

#### 1.Master èŠ‚ç‚¹æ‰©å®¹å¤±è´¥

```bash
[root@K8S-Master-2 ~]# kubeadm join 192.168.0.105:6443 --token w30l7l.zsuh67t66bjgy2vs --discovery-token-ca-cert-hash sha256:c7d4d20d51f4cc24d8745c3561f40d060ba31d1bb205c9b4f02923b7457aadde --control-plane --certificate-key c41bd7777ca63bad307a468e99871fdbdf9bdd2ef3fb9d00b35e02d39d8d827e
[preflight] Running pre-flight checks
	[WARNING FileExisting-tc]: tc not found in system path

	[WARNING Hostname]: hostname "k8s-master-2" could not be reached
	[WARNING Hostname]: hostname "k8s-master-2": lookup k8s-master-2 on 8.8.8.8:53: no such host
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -o yaml'
error execution phase preflight: 
One or more conditions for hosting a new control plane instance is not satisfied.

unable to add a new control plane instance to a cluster that doesn't have a stable controlPlaneEndpoint address

Please ensure that:
* The cluster has a stable controlPlaneEndpoint address.
* The certificates that must be shared among control plane instances are provided.


To see the stack trace of this error execute with --v=5 or higher

```

**åŸå› ï¼š**

1. ç¼ºå°‘ controlPlaneEndpoint
   - å½“åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼Œè‹¥æœªé€šè¿‡ `--control-plane-endpoint` æŒ‡å®šè´Ÿè½½å‡è¡¡å™¨åœ°å€ï¼ˆå¦‚ HAProxyã€äº‘å‚å•† LBï¼‰ï¼Œkubeadm é»˜è®¤ä½¿ç”¨å•ä¸ª Master èŠ‚ç‚¹çš„ IPï¼ˆå¦‚ `192.168.0.105`ï¼‰ã€‚
   - å½“å°è¯•æ·»åŠ ç¬¬äºŒä¸ª Master èŠ‚ç‚¹æ—¶ï¼Œé›†ç¾¤æ— æ³•è¯†åˆ«å¤š Master çš„å…¥å£ï¼Œå¯¼è‡´æŠ¥é”™ã€‚
2. ä¸»æœºåè§£æé—®é¢˜
   - é”™è¯¯æç¤º `lookup k8s-master-2 on 114.114.114.114:53: no such host` è¡¨æ˜æ–° Master èŠ‚ç‚¹çš„ä¸»æœºåæ— æ³•é€šè¿‡ DNS è§£æã€‚
   - Kubernetes ä¾èµ–èŠ‚ç‚¹ä¸»æœºåçš„æ­£å‘å’Œåå‘è§£æï¼Œè‹¥æœªé…ç½®æœ¬åœ° DNS æˆ– `/etc/hosts`ï¼Œä¼šå¯¼è‡´é€šä¿¡å¤±è´¥ã€‚



```bash
#å¤‡ä»½å½“å‰ kubeadm é…ç½®
kubectl -n kube-system get cm kubeadm-config -o yaml > kubeadm-config-backup.yaml

#ç¼–è¾‘é…ç½®ï¼Œåœ¨ClusterConfigurationå­—æ®µå†…æ·»åŠ  controlPlaneEndpoint
kubectl -n kube-system edit cm kubeadm-config
    controlPlaneEndpoint: "192.168.0.40:6443"
```

æ›´æ–°è¯ä¹¦

```bash
# åˆ é™¤æ—§è¯ä¹¦
rm /etc/kubernetes/pki/apiserver.*

# é‡æ–°ç”Ÿæˆè¯ä¹¦ï¼ˆåŒ…å« controlPlaneEndpointï¼‰
kubeadm init phase certs apiserver --control-plane-endpoint 192.168.0.40:6443

# æŸ¥çœ‹apiserverçš„å®¹å™¨IDï¼Œåˆ é™¤è¿›è¡Œé‡å¯
crictl ps --name kube-apiserver
CONTAINER           IMAGE               CREATED             STATE               NAME                ATTEMPT             POD ID              POD
47bc8e8ffbe34       bdc2eadbf3662       5 hours ago         Running             kube-apiserver      11                  46fe167c5b5fe       kube-apiserver-k8s-master

#åˆ é™¤è¿è¡Œapi-serverçš„pod
[root@K8S-Master examples]# sudo crictl rm -f 47bc8e8ffbe34
47bc8e8ffbe34
47bc8e8ffbe34

# é‡æ–°åˆ›å»ºkube-apiserver
systemctl restart kubelet
```



