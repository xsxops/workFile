# K8Sè°ƒåº¦èµ„æº-å·¥ä½œè´Ÿè½½

## selectorå£°æ˜

`selector` æ˜¯ Kubernetes ä¸­ç”¨äºç­›é€‰å’ŒåŒ¹é…ç‰¹å®šèµ„æºï¼ˆå¦‚ Podï¼‰çš„æœºåˆ¶ã€‚å®ƒé€šè¿‡æ ‡ç­¾ï¼ˆlabelsï¼‰å¯¹èµ„æºè¿›è¡Œè¿‡æ»¤ï¼Œä»¥ä¾¿å…¶ä»– Kubernetes å¯¹è±¡ï¼ˆå¦‚ Deploymentã€Serviceã€PodDisruptionBudget ç­‰ï¼‰èƒ½å¤Ÿæ‰¾åˆ°å¹¶å…³è”åˆ°ç›®æ ‡èµ„æºã€‚ å®ƒæ”¯æŒä¸¤ç§æ–¹å¼ï¼š`matchLabels` å’Œ `matchExpressions`ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„è¯¦ç»†è¯´æ˜

### 1. matchLabels

`matchLabels` æ˜¯åŸºäºæ ‡ç­¾çš„ç®€å•ç­›é€‰æ–¹å¼ï¼Œç”¨äºåŒ¹é…èµ„æºçš„æ ‡ç­¾é”®å€¼å¯¹ã€‚

**å‚æ•°è¯´æ˜**

- **é”®å€¼å¯¹åŒ¹é…**ï¼š`matchLabels` æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œé”®æ˜¯æ ‡ç­¾çš„é”®åï¼Œå€¼æ˜¯æ ‡ç­¾çš„å€¼ã€‚
- **é€»è¾‘**ï¼š`matchLabels` ä¼šç­›é€‰å‡ºåŒæ—¶æ»¡è¶³æ‰€æœ‰é”®å€¼å¯¹çš„èµ„æºã€‚

```yaml
selector:
  matchLabels:
    app: webserver
    tier: frontend
```

ä¸Šè¿°é…ç½®ä¼šåŒ¹é…æ‰€æœ‰åŒæ—¶å…·æœ‰ `app: webserver` å’Œ `tier: frontend` æ ‡ç­¾çš„ Podã€‚

### 2. matchExpressions

`matchExpressions` æ˜¯ä¸€ç§æ›´çµæ´»çš„ç­›é€‰æ–¹å¼ï¼Œæ”¯æŒåŸºäºæ ‡ç­¾çš„é€»è¾‘è¿ç®—ç¬¦ï¼ˆå¦‚ `In`, `NotIn`, `Exists`, `DoesNotExist` ç­‰ï¼‰ã€‚

**å‚æ•°è¯´æ˜**

- **operator**ï¼šé€»è¾‘è¿ç®—ç¬¦ï¼Œç”¨äºå®šä¹‰åŒ¹é…è§„åˆ™ã€‚
- **field**ï¼šç­›é€‰çš„å­—æ®µï¼Œå¯ä»¥æ˜¯èµ„æºçš„æ ‡ç­¾é”®ï¼ˆé»˜è®¤ï¼‰æˆ–å…¶ä»–å­—æ®µã€‚
- **values**ï¼šç”¨äºä¸ `field` è¿›è¡Œæ¯”è¾ƒçš„å€¼åˆ—è¡¨ã€‚

**operator ç±»å‹**

ä»¥ä¸‹æ˜¯ `matchExpressions` æ”¯æŒçš„ä¸»è¦æ“ä½œç¬¦ï¼š

| **Operator**     | **æè¿°**                     | **ç¤ºä¾‹**                                                  |
| ---------------- | ---------------------------- | --------------------------------------------------------- |
| **In**           | é”®çš„å€¼åœ¨ç»™å®šçš„åˆ—è¡¨ä¸­ã€‚       | `app: webserver` ä¸” `app` çš„å€¼åœ¨ `[nginx, apache]` ä¸­ã€‚   |
| **NotIn**        | é”®çš„å€¼ä¸åœ¨ç»™å®šçš„åˆ—è¡¨ä¸­ã€‚     | `app: webserver` ä¸” `app` çš„å€¼ä¸åœ¨ `[nginx, apache]` ä¸­ã€‚ |
| **Exists**       | é”®å­˜åœ¨ï¼Œä½†ä¸å…³å¿ƒå€¼ã€‚         | `app` æ ‡ç­¾å­˜åœ¨ï¼Œä¸ç®¡å€¼æ˜¯ä»€ä¹ˆã€‚                            |
| **DoesNotExist** | é”®ä¸å­˜åœ¨ã€‚                   | `app` æ ‡ç­¾ä¸å­˜åœ¨ã€‚                                        |
| **Gt**           | é”®çš„å€¼å¤§äºç»™å®šçš„æ•°å€¼ã€‚       | `metrics.cpu` çš„å€¼å¤§äº `5`ã€‚                              |
| **Lt**           | é”®çš„å€¼å°äºç»™å®šçš„æ•°å€¼ã€‚       | `metrics.cpu` çš„å€¼å°äº `5`ã€‚                              |
| **Gte**          | é”®çš„å€¼å¤§äºæˆ–ç­‰äºç»™å®šçš„æ•°å€¼ã€‚ | `metrics.cpu` çš„å€¼å¤§äºç­‰äº `5`ã€‚                          |
| **Lte**          | é”®çš„å€¼å°äºæˆ–ç­‰äºç»™å®šçš„æ•°å€¼ã€‚ | `metrics.cpu` çš„å€¼å°äºç­‰äº `5`ã€‚                          |

**ç¤ºä¾‹**

```yaml
selector:
  matchExpressions:
    - {key: app, operator: In, values: [nginx, apache]}
    - {key: tier, operator: Exists, values: []}
```

### 3.Selector çš„æ³¨æ„äº‹é¡¹

1. **å”¯ä¸€æ€§**ï¼š
   - å¦‚æœå¤šä¸ªèµ„æºï¼ˆå¦‚ Deploymentã€Serviceï¼‰ä½¿ç”¨ç›¸åŒçš„ `selector`ï¼Œå®ƒä»¬å¯èƒ½ä¼šäº’ç›¸å¹²æ‰°ã€‚
   - å»ºè®®ä¸ºä¸åŒçš„èµ„æºä½¿ç”¨ä¸åŒçš„æ ‡ç­¾ï¼Œé¿å…å†²çªã€‚
2. **çµæ´»æ€§**ï¼š
   - ä½¿ç”¨ `matchExpressions` æ—¶ï¼Œå¯ä»¥å®ç°æ›´å¤æ‚çš„é€»è¾‘ï¼Œä½†ä¹Ÿå¯èƒ½å¢åŠ é…ç½®çš„å¤æ‚æ€§ã€‚
   - æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„åŒ¹é…æ–¹å¼ã€‚
3. **æ€§èƒ½**ï¼š
   - è¿‡äºå¤æ‚çš„ `selector` å¯èƒ½ä¼šå½±å“ Kubernetes é›†ç¾¤çš„æ€§èƒ½ã€‚
   - å»ºè®®å°½é‡ä½¿ç”¨ç®€å•çš„åŒ¹é…è§„åˆ™ã€‚

## 1) Replication Controller å’Œ ReplicaSet

â€‹	åœ¨ Kubernetes ä¸­ï¼Œ**Replication Controller** å’Œ **ReplicaSet** éƒ½æ˜¯ç”¨äºç¡®ä¿ç³»ç»Ÿä¸­æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬åœ¨ä»»ä½•æ—¶åˆ»éƒ½èƒ½ä¿æŒè¿è¡Œçš„æ§åˆ¶å™¨ã€‚å®ƒä»¬æœ‰ç›¸ä¼¼çš„åŠŸèƒ½ï¼Œä½†æœ‰ä¸€äº›å…³é”®çš„å·®å¼‚ï¼Œç‰¹åˆ«æ˜¯åœ¨ Kubernetes çš„ç‰ˆæœ¬æ¼”è¿›è¿‡ç¨‹ä¸­ã€‚

### 1.1 Replication Controller

â€‹	Replication Controller æ˜¯ Kubernetes æ—©æœŸçš„ Pod å‰¯æœ¬ç®¡ç†å·¥å…·ï¼Œä¸»è¦ç”¨äºç¡®ä¿æŒ‡å®šæ•°é‡çš„ Pod å‰¯æœ¬åœ¨é›†ç¾¤ä¸­å§‹ç»ˆè¿è¡Œã€‚å®ƒèƒ½å¤Ÿåœ¨ Pod å‡ºç°æ•…éšœæ—¶åˆ›å»ºæ–°çš„å‰¯æœ¬ï¼Œä»¥ä¿è¯æ‰€éœ€çš„å‰¯æœ¬æ•°ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- ç¡®ä¿ Pod çš„å‰¯æœ¬æ•°å§‹ç»ˆä¸æœŸæœ›å€¼ä¸€è‡´ã€‚
- å¦‚æœæŸäº› Pod åœæ­¢è¿è¡Œæˆ–è¢«åˆ é™¤ï¼ŒReplication Controller ä¼šè‡ªåŠ¨å¯åŠ¨æ–°çš„ Pod æ¥æ¢å¤å‰¯æœ¬æ•°ã€‚

#### å®šä¹‰ä¸€ä¸ª Replication Controller çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
apiVersion: v1  # æŒ‡å®š API ç‰ˆæœ¬ï¼Œv1 æ˜¯ç¨³å®šç‰ˆæœ¬
kind: ReplicationController  # èµ„æºç±»å‹ä¸º ReplicationController
metadata:
  name: nginx  # ReplicationController çš„åç§°
spec:
  replicas: 3  # è®¾ç½® Pod å‰¯æœ¬æ•°ä¸º 3
  selector:  # æ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºåŒ¹é… Pod
    app: nginx  # é€‰æ‹©æ ‡ç­¾ä¸º app=nginx çš„ Pod
  template:  # Pod æ¨¡æ¿ï¼Œå®šä¹‰å°†è¦åˆ›å»ºçš„ Pod çš„è¯¦ç»†ä¿¡æ¯
    metadata:
      name: nginx  # Pod çš„åç§°
      labels:  # æ ‡ç­¾ï¼Œç”¨äºåŒ¹é…å’Œé€‰æ‹© Pod
        app: nginx  # æ ‡ç­¾ app=nginx
    spec:  # Pod çš„è§„æ ¼ï¼ˆåŒ…å«å®¹å™¨çš„é…ç½®ç­‰ï¼‰
      containers:  # å®¹å™¨å®šä¹‰
      - name: nginx  # å®¹å™¨åç§°
        image: nginx  # å®¹å™¨ä½¿ç”¨çš„é•œåƒ
        ports:  # å®¹å™¨æš´éœ²çš„ç«¯å£
        - containerPort: 80  # å®¹å™¨çš„ç«¯å£å·ä¸º 80
```

### 1.2 ReplicaSet

â€‹	ReplicaSet æ˜¯ Kubernetes åœ¨ 1.2 ç‰ˆæœ¬ä¸­å¼•å…¥çš„ä¸€ä¸ªæ–°èµ„æºï¼ŒåŸºæœ¬ä¸Šæ˜¯ Replication Controller çš„å‡çº§ç‰ˆã€‚å®ƒæä¾›äº†ä¸ Replication Controller ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†æ”¯æŒæ›´å¤šçš„æ ‡ç­¾é€‰æ‹©å™¨ï¼ˆlabel selectorï¼‰ã€‚ReplicaSet å¼•å…¥äº† **`Set-based selectors`**ï¼ˆé›†åˆé€‰æ‹©å™¨ï¼‰ï¼Œå¯ä»¥æ›´çµæ´»åœ°é€‰æ‹©ä¸€ç»„ Podï¼Œè€Œä¸ä»…ä»…å±€é™äºç®€å•çš„æ ‡ç­¾åŒ¹é…ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒReplicaSet å¸¸å¸¸ä¸ Deployment é…åˆä½¿ç”¨æ¥è‡ªåŠ¨ç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚è™½ç„¶ ReplicaSet å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä½†é€šå¸¸æ¨èä½¿ç”¨ Deploymentï¼Œå› ä¸º Deployment æä¾›äº†æ›´å¤šçš„åŠŸèƒ½ï¼Œå¦‚ç‰ˆæœ¬å›æ»šã€æ»šåŠ¨æ›´æ–°ç­‰ã€‚

**ä¸»è¦åŠŸèƒ½ï¼š**

- ç¡®ä¿ Pod çš„å‰¯æœ¬æ•°å§‹ç»ˆä¸æœŸæœ›å€¼ä¸€è‡´ã€‚
- æä¾›æ›´å¼ºå¤§çš„æ ‡ç­¾é€‰æ‹©å™¨æ”¯æŒã€‚
- æ”¯æŒ Pod çš„æ»šåŠ¨æ›´æ–°ä¸ç®¡ç†ï¼Œé€šå¸¸ä¸ **Deployment** æ§åˆ¶å™¨é…åˆä½¿ç”¨ã€‚

### å¯¹æ¯”ï¼šReplication Controller ä¸ ReplicaSet

| ç‰¹æ€§                    | Replication Controller                               | ReplicaSet                                                   |
| ----------------------- | ---------------------------------------------------- | ------------------------------------------------------------ |
| **å®šä¹‰æ–¹å¼**            | è¾ƒè€çš„æ§åˆ¶å™¨ï¼Œä¸»è¦é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹© Podã€‚           | æ›´æ–°ç‰ˆæ§åˆ¶å™¨ï¼Œæ”¯æŒæ›´å¼ºå¤§çš„æ ‡ç­¾é€‰æ‹©å™¨ï¼Œæ”¯æŒé›†åˆé€‰æ‹©å™¨ã€‚       |
| **é€‰æ‹©å™¨**              | ä»…æ”¯æŒ **`Equality-based selector`**ï¼ˆç­‰å€¼é€‰æ‹©å™¨ï¼‰ã€‚ | æ”¯æŒ **`Set-based selector`**ï¼ˆé›†åˆé€‰æ‹©å™¨ï¼‰ï¼Œæä¾›æ›´å¤šçµæ´»æ€§ã€‚ |
| **æ¨èä½¿ç”¨åœºæ™¯**        | ä»…ç”¨äºå‘åå…¼å®¹ã€‚                                     | æ›´ç°ä»£çš„èµ„æºç®¡ç†ï¼Œæ¨èç”¨äºæ–°åº”ç”¨ã€‚                           |
| **å¸¸è§ç”¨æ³•**            | é€‚ç”¨äºç®€å•çš„å‰¯æœ¬ç®¡ç†åœºæ™¯ã€‚                           | ç”¨äºæ›´å¤æ‚çš„ç®¡ç†åœºæ™¯ï¼Œå°¤å…¶æ˜¯ä¸ Deployment ä¸€èµ·ä½¿ç”¨ã€‚         |
| **Deployment é…åˆä½¿ç”¨** | ä¸ç›´æ¥æ”¯æŒã€‚                                         | æ˜¯ Deployment æ§åˆ¶å™¨çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ã€‚                         |

#### å®šä¹‰ä¸€ä¸ª ReplicaSet çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
apiVersion: apps/v1  # æŒ‡å®š API ç‰ˆæœ¬ï¼Œé€‚ç”¨äº ReplicaSet
kind: ReplicaSet  # èµ„æºç±»å‹ä¸º ReplicaSet
metadata:
  name: frontend  # ReplicaSet çš„åç§°
  labels:
    app: guestbook  # æ ‡ç­¾ï¼Œapp=guestbook ç”¨äºé€‰æ‹©è¯¥ ReplicaSet å…³è”çš„ Pod
    tier: frontend  # æ ‡ç­¾ï¼Œtier=frontend ç”¨äºåŒºåˆ† Pod çš„å±‚æ¬¡
spec:
  replicas: 3  # è®¾ç½® Pod å‰¯æœ¬æ•°ä¸º 3
  selector:  # æ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©ä¸è¯¥ ReplicaSet ç›¸å…³çš„ Pod
    matchLabels:  # åŸºäºæ ‡ç­¾çš„é€‰æ‹©å™¨ï¼ŒåŒ¹é…æ ‡ç­¾ä¸º tier=frontend çš„ Pod
      tier: frontend
    matchExpressions:  # æ›´å¤æ‚çš„é€‰æ‹©å™¨ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶
      - {key: tier, operator: In, values: [frontend]}  # é€‰æ‹©æ ‡ç­¾ key=tier ä¸”å€¼ä¸º frontend çš„ Pod
  template:  # Pod æ¨¡æ¿ï¼Œå®šä¹‰æ–°åˆ›å»º Pod çš„è§„èŒƒ
    metadata:
      labels:
        app: guestbook  # æ ‡ç­¾ app=guestbookï¼Œç¡®ä¿ä¸ ReplicaSet é€‰æ‹©å™¨åŒ¹é…
        tier: frontend  # æ ‡ç­¾ tier=frontendï¼Œç¡®ä¿ä¸ ReplicaSet é€‰æ‹©å™¨åŒ¹é…
    spec:  # Pod çš„è§„æ ¼
      containers:  # å®¹å™¨å®šä¹‰
      - name: php-redis  # å®¹å™¨åç§°
        image: gcr.io/google_samples/gb-frontend:v3  # ä½¿ç”¨çš„å®¹å™¨é•œåƒ
        resources:  # èµ„æºè¯·æ±‚
          requests:
            cpu: 100m  # è¯·æ±‚ CPU èµ„æº 100 æ¯«æ ¸
            memory: 100Mi  # è¯·æ±‚å†…å­˜èµ„æº 100 MiB
        env:  # ç¯å¢ƒå˜é‡
        - name: GET_HOSTS_FROM
          value: dns  # ç¯å¢ƒå˜é‡è®¾ç½®ï¼ŒæŒ‡å®šä» DNS è·å–ä¸»æœºä¿¡æ¯
      ports:
        - containerPort: 80  # å®¹å™¨å¼€æ”¾çš„ç«¯å£å·
```

#### Deployment ä½¿ç”¨ ReplicaSet

å½“æˆ‘ä»¬ä½¿ç”¨ **Deployment** æ—¶ï¼ŒDeployment ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª **ReplicaSet** æ¥ç®¡ç† Pod å‰¯æœ¬ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ª Deployment çš„ YAML æ–‡ä»¶ç¤ºä¾‹ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ReplicaSet æ¥ç®¡ç† Pod å‰¯æœ¬ã€‚

```yaml
apiVersion: apps/v1
kind: Deployment  # å®šä¹‰ä¸º Deployment ç±»å‹
metadata:
  name: nginx-deployment  # Deployment çš„åç§°
spec:
  replicas: 3  # è®¾ç½®æœŸæœ›çš„ Pod å‰¯æœ¬æ•°ä¸º 3
  selector:  # é€‰æ‹©å™¨ç”¨äºåŒ¹é… Pod
    matchLabels:
      app: nginx  # åŒ¹é…æ ‡ç­¾ä¸º app: nginx çš„ Pod
  template:  # Pod æ¨¡æ¿
    metadata:
      labels:
        app: nginx  # æ ‡ç­¾å¿…é¡»ä¸é€‰æ‹©å™¨åŒ¹é…
    spec:
      containers:
        - name: nginx  # å®¹å™¨åç§°
          image: nginx:latest  # ä½¿ç”¨æœ€æ–°çš„ nginx é•œåƒ
          ports:
            - containerPort: 80  # å®¹å™¨æš´éœ²ç«¯å£ 80
```

## 2) æ— çŠ¶æ€åº”ç”¨ç®¡ç† Deployment

### 2.1 ä»€ä¹ˆæ˜¯ Deploymentï¼Ÿ

**Deployment** æ˜¯ Kubernetes ä¸­ç”¨äºç®¡ç†æ— çŠ¶æ€åº”ç”¨çš„å·¥ä½œè´Ÿè½½çš„ APIã€‚ä¸»è¦ç”¨äºç®¡ç†æ— çŠ¶æ€çš„åº”ç”¨ç¨‹åºï¼Œå®ƒæä¾›äº†ä¸€ç§å£°æ˜å¼çš„æ–¹å¼æ¥æè¿°åº”ç”¨çš„æœŸæœ›çŠ¶æ€ï¼Œç¡®ä¿éƒ¨ç½²è¿‡ç¨‹ä¸­çš„å¹³æ»‘è¿‡æ¸¡å’Œå›æ»šã€‚

**ä¸»è¦ç‰¹ç‚¹ï¼š**

- é€‚ç”¨äºæ— çŠ¶æ€æœåŠ¡ï¼ˆStateless Servicesï¼‰ã€‚
- æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰å’Œå›æ»šï¼ˆRollbackï¼‰ã€‚
- è‡ªåŠ¨ç®¡ç† ReplicaSet å’Œ Podã€‚
- ç¡®ä¿åº”ç”¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¿æŒå¯ç”¨ã€‚

### 2.2 Deployment çš„ YAML é…ç½®è§£é‡Š

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå…¸å‹çš„ Deployment YAML é…ç½®æ–‡ä»¶ï¼š

```yaml
apiVersion: apps/v1              # æŒ‡å®šä½¿ç”¨ apps/v1 API ç‰ˆæœ¬
kind: Deployment                 # å®šä¹‰è¿™æ˜¯ä¸€ä¸ª Deployment
metadata:
  name: nginx-deployment         # Deployment çš„åç§°
  labels:
    app: nginx                   # ä¸º Deployment æ·»åŠ æ ‡ç­¾ï¼Œæ–¹ä¾¿ç®¡ç†
spec:
  replicas: 3                    # æŒ‡å®šè¦åˆ›å»º 3 ä¸ªå‰¯æœ¬
  selector:                      # å®šä¹‰é€‰æ‹©å™¨ï¼Œç”¨äºç­›é€‰ç®¡ç†çš„ Pod
    matchLabels:                 # ä½¿ç”¨åŸºäºæ ‡ç­¾çš„é€‰æ‹©å™¨
      app: nginx                 # é€‰æ‹©æ‰€æœ‰æ ‡ç­¾ app=nginx çš„ Pod
  template:                      # å®šä¹‰ Pod çš„æ¨¡æ¿
    metadata:
      labels:
        app: nginx               # ä¸º Pod æ·»åŠ æ ‡ç­¾ï¼Œç¡®ä¿ä¸ selector åŒ¹é…
    spec:
      containers:
      - name: nginx               # å®¹å™¨åç§°
        image: m.daocloud.io/docker.io/library/nginx:1.16      # ä½¿ç”¨çš„ Docker é•œåƒ
        ports:
        - containerPort: 80        # æš´éœ²å®¹å™¨çš„ 80 ç«¯å£
```

### 2.3 Deployment åŸºç¡€æ“ä½œ

#### 2.3.1 åˆ›å»º Deployment

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»º Deploymentï¼š

```bash
root@k8s-master:~/yaml# kubectl create -f dp-nginx.yaml
deployment.apps/nginx-deployment created
```

**æŸ¥çœ‹ Deployment çŠ¶æ€**

ä½¿ç”¨ `kubectl get` å’Œ `kubectl describe` æŸ¥çœ‹ Deployment çš„çŠ¶æ€ï¼š

```bash
root@k8s-master:~/yaml# kubectl get deploy
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   3/3     3            3           48m
root@k8s-master:~/yaml# kubectl get po
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-86876b6586-pq2gj   1/1     Running   0          4m46s
nginx-deployment-86876b6586-z2d2q   1/1     Running   0          10m
nginx-deployment-86876b6586-zwqzg   1/1     Running   0          2m8s


#å„åˆ—è¯´æ˜ï¼š
- READY: 		å°±ç»ªçš„ Pod æ•°é‡ / æ€»å‰¯æœ¬æ•°ã€‚
- UP-TO-DATE:	å·²æ›´æ–°åˆ°æœŸæœ›çŠ¶æ€çš„å‰¯æœ¬æ•°ã€‚
- AVAILABLE: 	å¯ç”¨çš„ Pod æ•°é‡ã€‚
- AGE: 			Deployment çš„è¿è¡Œæ—¶é—´ã€‚
```

**æŸ¥çœ‹æ­¤ Deployment å½“å‰å¯¹åº”çš„ ReplicaSetï¼š**

```bash
root@k8s-master:~# kubectl get rs -l app=nginx
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-86876b6586   3         3         3       15h

root@k8s-master:~# kubectl get po -l app=nginx
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-86876b6586-76kzl   1/1     Running   0          11h
nginx-deployment-86876b6586-h9qkh   1/1     Running   0          11h
nginx-deployment-86876b6586-rq8w9   1/1     Running   0          11h


#â¢ DESIREDï¼šåº”ç”¨ç¨‹åºå‰¯æœ¬æ•°ï¼›
#â¢ CURRENTï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„å‰¯æœ¬æ•°ï¼›
```

â€‹	å½“ Deployment æœ‰è¿‡æ›´æ–°ï¼Œå¯¹åº”çš„ RS å¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œå¯ä»¥é€šè¿‡-o yaml è·å–å½“å‰å¯¹åº”çš„ RSæ˜¯å“ªä¸ªï¼Œå…¶ä½™çš„ RS ä¸ºä¿ç•™çš„å†å²ç‰ˆæœ¬ï¼Œç”¨äºå›æ»šç­‰æ“ä½œã€‚æŸ¥çœ‹æ­¤ Deployment åˆ›å»ºçš„ Podï¼Œå¯ä»¥çœ‹åˆ° Pod çš„ hash å€¼ 86876b6586å’Œä¸Šè¿° Deployment å¯¹åº”çš„ ReplicaSet çš„ hash å€¼ä¸€è‡´ï¼š

#### 2.3.2 Deployment æ›´æ–°

> [!CAUTION]
>
> å½“ä¸”ä»…å½“ Deployment çš„ Pod æ¨¡æ¿ï¼ˆå³.spec.templateï¼‰æ›´æ”¹æ—¶ï¼Œæ‰ä¼šè§¦å‘ Deployment
> æ›´æ–°ï¼Œä¾‹å¦‚æ›´æ”¹å†…å­˜ã€CPU é…ç½®æˆ–è€…å®¹å™¨çš„ imageã€‚

å‡å¦‚æ›´æ–° Nginx Pod çš„ image ä½¿ç”¨ m.daocloud.io/docker.io/library/nginx:latestï¼Œå¹¶ä½¿ç”¨ --record è®°å½•å½“å‰æ›´æ”¹çš„å‚æ•°ï¼ŒåæœŸå›æ»šæ—¶å¯ä»¥æŸ¥çœ‹åˆ°å¯¹åº”çš„ä¿¡æ¯ï¼š

```bash
root@k8s-master:~# kubectl set image deployment/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:latest --record
deployment.apps/nginx-deployment image updated
```

**æŸ¥çœ‹æ›´æ–°è¿‡åçš„é•œåƒä¿¡æ¯**

```bash
root@k8s-master:~# kubectl get deploy nginx-deployment -o yaml |grep image:
      - image: m.daocloud.io/docker.io/library/nginx:latest
```

**æŸ¥çœ‹èµ„æºå†å²çš„ç‰ˆæœ¬**

```bash
root@k8s-master:~# kubectl rollout history deployment/nginx-deployment
deployment.apps/nginx-deployment 
REVISION  CHANGE-CAUSE
2         <none>
3         kubectl set image deployment/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:latest --record=true
```

**ğŸš¨æ³¨æ„**

**<span style="color:red">å¦‚æœä½¿ç”¨set å‘½ä»¤è¿›è¡Œèµ„æºæ›´æ–°ï¼Œåç»­å¦‚æœæƒ³é€šè¿‡åŸyamlæ–‡ä»¶è¿›è¡Œä¿®æ”¹æ›´æ–°é‚£ä¹ˆå°±éœ€è¦å…ˆå°†èµ„æºå¯¼å‡ºæˆä¸ºyamlæ–‡ä»¶ç„¶ååœ¨è¿›è¡Œç¼–è¾‘ä¿®æ”¹</span>**

**å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬**ï¼š

```bash
kubectl rollout undo deployment/nginx-deployment
```

#### 2.3.3 Deployment æ‰©å®¹

**å‘½ä»¤æ‰©å®¹**

```bash
kubectl scale deployment <deployment_name> --replicas=<desired_number_of_replicas>
```

**ç¼–è¾‘ Deployment**

é€šè¿‡ `kubectl edit` å‘½ä»¤ï¼Œç›´æ¥ç¼–è¾‘ç°æœ‰ Deployment çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥ä¿®æ”¹ `spec.replicas` æ•°é‡æ¥å®ç°æ‰©å®¹ã€‚ç¼–è¾‘åï¼ŒKubernetes ä¼šè‡ªåŠ¨æ›´æ–° Pods çš„æ•°é‡

```bash
kubectl edit deployment <deployment_name>
```

**ä¿®æ”¹ YAML æ–‡ä»¶å¹¶åº”ç”¨**

```bash
kubectl apply -f <deployment_yaml_file>
```

#### 2.3.4 æš‚åœå’Œæ¢å¤ Deployment æ›´æ–°

ä¸Šè¿°æ¼”ç¤ºçš„å‡ä¸ºæ›´æ”¹æŸä¸€å¤„çš„é…ç½®ï¼Œæ›´æ”¹åç«‹å³è§¦å‘æ›´æ–°ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯èƒ½éœ€è¦é’ˆå¯¹ä¸€ä¸ªèµ„æºæ–‡ä»¶æ›´æ”¹å¤šå¤„åœ°æ–¹ï¼Œè€Œå¹¶ä¸éœ€è¦å¤šæ¬¡è§¦å‘æ›´æ–°ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ Deployment æš‚åœåŠŸèƒ½ï¼Œä¸´æ—¶ç¦ç”¨æ›´æ–°æ“ä½œï¼Œå¯¹ Deployment è¿›è¡Œå¤šæ¬¡ä¿®æ”¹ååœ¨è¿›è¡Œæ›´æ–°ã€‚ä½¿ç”¨ kubectl rollout pause å‘½ä»¤å³å¯æš‚åœ Deployment æ›´æ–°ï¼š

åœ¨è¿›è¡Œå¤šæ¬¡é…ç½®æ›´æ”¹æ—¶ï¼Œå¯ä»¥æš‚åœæ›´æ–°ï¼Œå®Œæˆåå†æ¢å¤ï¼š

```bash
kubectl rollout pause deployment/nginx-deployment
```

ç„¶åå¯¹ Deployment è¿›è¡Œç›¸å…³æ›´æ–°æ“ä½œï¼Œæ¯”å¦‚å…ˆæ›´æ–°é•œåƒï¼Œç„¶åå¯¹å…¶èµ„æºè¿›è¡Œé™åˆ¶ï¼ˆå¦‚æœä½¿ç”¨çš„æ˜¯ kubectl edit å‘½ä»¤ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œå¤šæ¬¡ä¿®æ”¹ï¼Œæ— éœ€æš‚åœæ›´æ–°ï¼Œkubectlset å‘½ä»¤ä¸€èˆ¬ä¼šé›†æˆåœ¨CICD æµæ°´çº¿ä¸­ï¼‰ï¼š

```bash
# kubectl set image deployment.v1.apps/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:1.91
deployment.apps/nginx-deployment image updated

# kubectl set resources deployment.v1.apps/nginx-deployment -c=nginx --limits=cpu=200m,memory=512Mi
deployment.apps/nginx-deployment resource requirements updated
```

é€šè¿‡ rollout history å¯ä»¥çœ‹åˆ°æ²¡æœ‰æ–°çš„æ›´æ–°ï¼š

```bash
root@k8s-master:~# kubectl rollout history deployment/nginx-deployment
deployment.apps/nginx-deployment 
REVISION  CHANGE-CAUSE
2         <none>
3         kubectl set image deployment/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:latest --record=true
```

**è¿›è¡Œå®Œæœ€åä¸€å¤„é…ç½®æ›´æ”¹åï¼Œä½¿ç”¨ kubectl rollout resume æ¢å¤ Deployment æ›´æ–°ï¼š**

```bash
kubectl rollout resume deployment/nginx-deployment

#æ¢å¤çŠ¶æ€åå¯ä»¥çœ‹åˆ°è‡ªåŠ¨æŠŠå‰é¢åšçš„ä¸¤æ¬¡å˜æ›´è¿›è¡Œäº†æ›´æ–°
root@k8s-master:~# kubectl rollout history deployment/nginx-deployment
deployment.apps/nginx-deployment 
REVISION  CHANGE-CAUSE
2         <none>
3         kubectl set image deployment/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:latest --record=true
4         kubectl set image deployment/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:latest --record=true
```

å¯ä»¥çœ‹åˆ°å·²ç»å‘ç”Ÿäº†å˜æ›´
```bash
root@k8s-master:~# kubectl get deploy nginx-deployment -o yaml |grep image:
      - image: m.daocloud.io/docker.io/library/nginx:1.91

root@k8s-master:~# kubectl describe deploy nginx-deployment
Name:                   nginx-deployment
Namespace:              default
CreationTimestamp:      Wed, 19 Feb 2025 08:41:33 +0000
Labels:                 app=nginx
Annotations:            deployment.kubernetes.io/revision: 4
                        kubernetes.io/change-cause: kubectl set image deployment/nginx-deployment nginx=m.daocloud.io/docker.io/library/nginx:latest --record=true
Selector:               app=nginx
Replicas:               3 desired | 1 updated | 4 total | 3 available | 1 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=nginx
  Containers:
   nginx:
    Image:      m.daocloud.io/docker.io/library/nginx:1.91
    Port:       80/TCP
    Host Port:  0/TCP
    Limits:
      cpu:        200m
      memory:     512Mi
```

### 2.4 æ›´æ–° Deployment çš„æ³¨æ„äº‹é¡¹

#### å†å²ç‰ˆæœ¬æ¸…ç†ç­–ç•¥

åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒKubernetes ä¼šä¿ç•™ 10 ä¸ªæ—§çš„ ReplicaSetï¼Œå¤šä½™çš„ ReplicaSet ä¼šåœ¨åå°è¢«åƒåœ¾å›æ”¶ã€‚å¯ä»¥é€šè¿‡ `.spec.revisionHistoryLimit` è®¾ç½®ä¿ç•™çš„å†å²ç‰ˆæœ¬æ•°é‡ã€‚å¦‚æœå°†å…¶è®¾ç½®ä¸º `0`ï¼Œåˆ™ä¸ä¿ç•™ä»»ä½•å†å²ç‰ˆæœ¬ã€‚è¿™å¯¹äºæ§åˆ¶å†å²ç‰ˆæœ¬çš„å­˜å‚¨å’Œæ¸…ç†éå¸¸æœ‰ç”¨ï¼Œé¿å…é›†ç¾¤ä¸­ç§¯ç´¯è¿‡å¤šçš„å†å²å‰¯æœ¬ã€‚

#### æ›´æ–°ç­–ç•¥

Kubernetes æä¾›äº†ä¸¤ç§æ›´æ–°ç­–ç•¥ï¼š

1. **Recreateï¼ˆé‡å»ºç­–ç•¥ï¼‰**
    `.spec.strategy.type == Recreate` è¡¨ç¤ºåœ¨æ›´æ–°æ—¶ï¼Œå…ˆåˆ é™¤æ—§çš„ Podï¼Œå†åˆ›å»ºæ–°çš„ Podã€‚è¿™ç§æ–¹å¼é€‚ç”¨äºéœ€è¦ç¡®ä¿æ—§ Pod å®Œå…¨æ¶ˆå¤±åå†å¯åŠ¨æ–° Pod çš„åœºæ™¯ã€‚è¿™ç§ç­–ç•¥é€‚åˆä¸€äº›å¯¹æ›´æ–°è¿‡ç¨‹ä¸­æ²¡æœ‰ Pod å¯ç”¨è¦æ±‚è¾ƒä½çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨äºæ— çŠ¶æ€æœåŠ¡æˆ–èµ„æºå……è¶³çš„ç¯å¢ƒã€‚

2. **RollingUpdateï¼ˆæ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼‰**
    `.spec.strategy.type == RollingUpdate` è¡¨ç¤ºé€æ­¥æ›¿æ¢æ—§çš„ Podsï¼Œåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸ä¼šåœæœºã€‚æ»šåŠ¨æ›´æ–°é€šè¿‡æ§åˆ¶æ›´æ–°æ­¥é•¿å’Œä¸å¯ç”¨ Pod æ•°é‡æ¥é€æ­¥æ›¿æ¢æ—§çš„ Podï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­åº”ç”¨å§‹ç»ˆæœ‰å¯ç”¨çš„ Podã€‚

   å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶æ»šåŠ¨æ›´æ–°çš„è¡Œä¸ºï¼š

   - **`.spec.strategy.rollingUpdate.maxUnavailable`**
      æŒ‡å®šåœ¨æ›´æ–°è¿‡ç¨‹ä¸­æœ€å¤§ä¸å¯ç”¨çš„ Pod æ•°é‡ã€‚å¯ä»¥è®¾ç½®ä¸ºæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œé»˜è®¤å€¼æ˜¯ `25%`ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè®¾ç½®ä¸º `25%`ï¼Œè¡¨ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­æœ€å¤šæœ‰ 25% çš„ Pod å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚è‹¥è®¾ç½® `maxUnavailable` ä¸º 0ï¼Œåˆ™è¡¨ç¤ºæ›´æ–°è¿‡ç¨‹ä¸­ä¸ä¼šæœ‰ä»»ä½• Pod å˜ä¸ºä¸å¯ç”¨ã€‚
   - **`.spec.strategy.rollingUpdate.maxSurge`**
      æŒ‡å®šåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå…è®¸è¶…å‡ºæœŸæœ› Pod æ•°é‡çš„æœ€å¤§æ•°é‡ã€‚å¯ä»¥è®¾ç½®ä¸ºæ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼Œé»˜è®¤å€¼æ˜¯ `25%`ã€‚å¦‚æœè®¾ç½®ä¸º `25%`ï¼Œè¡¨ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šå…è®¸ Pod æ•°é‡æ¯”æœŸæœ›æ•°é‡å¤šå‡º 25%ã€‚è¿™ä¸ªå‚æ•°æœ‰åŠ©äºåœ¨æ›´æ–°æ—¶ä¿æŒè¶³å¤Ÿçš„ Pod æ¥å¤„ç†æµé‡ï¼Œé¿å…æœåŠ¡ä¸­æ–­ã€‚

   > **æ³¨æ„**ï¼šå¦‚æœå°† `maxUnavailable` è®¾ç½®ä¸º `0`ï¼Œè¡¨ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸èƒ½æœ‰ Pod å˜ä¸ºä¸å¯ç”¨ï¼Œé‚£ä¹ˆ `maxSurge` å¿…é¡»å¤§äº 0ã€‚å› ä¸ºå¦‚æœæ²¡æœ‰ `maxSurge`ï¼Œå°±æ— æ³•ä¸ºæ›´æ–°è¿‡ç¨‹ä¸­çš„ä¸å¯ç”¨ Pod åˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£ï¼Œä»è€Œæ— æ³•é¡ºåˆ©å®Œæˆæ›´æ–°ã€‚

**æ»šåŠ¨æ›´æ–°**

```yaml
spec:
  replicas: 3  # æœŸæœ›çš„ Pod å‰¯æœ¬æ•°
  revisionHistoryLimit: 5  # ä¿ç•™ 5 ä¸ªå†å²ç‰ˆæœ¬
  strategy:
    type: RollingUpdate  # ä½¿ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥
    rollingUpdate:
      maxSurge: 25%  # å…è®¸è¶…å‡ºæœŸæœ›æ•°é‡çš„ Pod æœ€å¤§ä¸º 25%
      maxUnavailable: 25%  # æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šå…è®¸ 25% çš„ Pod ä¸å¯ç”¨
      timeoutSeconds: 600  # æ»šåŠ¨æ›´æ–°æ¯æ¬¡å°è¯•çš„æœ€å¤§æ—¶é—´ï¼Œå•ä½ç§’ï¼Œé»˜è®¤ä¸º 600 ç§’
      partition: 2  # åªæ›´æ–°ç‰¹å®šç‰ˆæœ¬çš„ Podï¼Œæ§åˆ¶ä»å“ªäº›å‰¯æœ¬å¼€å§‹æ›´æ–°ï¼ˆä»…é€‚ç”¨äºå¤šç‰ˆæœ¬éƒ¨ç½²åœºæ™¯ï¼‰
  minReadySeconds: 10  # æ–°åˆ›å»ºçš„ Pod åœ¨è¢«è®¤ä¸ºå¯ç”¨ä¹‹å‰ï¼Œå¿…é¡»ä¿æŒå°±ç»ªçŠ¶æ€çš„æœ€å°æ—¶é—´ï¼Œå•ä½ä¸ºç§’
  progressDeadlineSeconds: 600  # æ›´æ–°è¿‡ç¨‹çš„æœ€é•¿å…è®¸æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼Œè‹¥è¶…è¿‡æ­¤æ—¶é—´æ›´æ–°æœªå®Œæˆï¼Œåˆ™è§¦å‘å›æ»š
```

 **é‡å»ºç­–ç•¥ (Recreate)**

```yaml
spec:
  replicas: 3  # æœŸæœ›çš„ Pod å‰¯æœ¬æ•°
  revisionHistoryLimit: 3  # ä¿ç•™ 3 ä¸ªå†å²ç‰ˆæœ¬
  strategy:
    type: Recreate  # ä½¿ç”¨é‡å»ºç­–ç•¥
```

#### ä¸ºä»€ä¹ˆ `maxUnavailable` å’Œ `maxSurge` ä¸èƒ½åŒæ—¶ä¸º 0ï¼Ÿ

å¦‚æœå°† `maxUnavailable` è®¾ç½®ä¸º 0ï¼Œè¡¨ç¤ºåœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ‰€æœ‰ Pod å¿…é¡»å§‹ç»ˆä¿æŒå¯ç”¨ã€‚å¦‚æœå°† `maxSurge` è®¾ç½®ä¸º 0ï¼Œåˆ™æ„å‘³ç€åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸èƒ½è¶…å‡ºæœŸæœ› Pod æ•°é‡çš„èŒƒå›´ï¼Œè¿™å°†å¯¼è‡´æ²¡æœ‰é¢å¤– Pod ç”¨æ¥æ›¿æ¢ä¸å¯ç”¨çš„ Podï¼Œæ— æ³•ä¿è¯æ›´æ–°çš„é¡ºåˆ©è¿›è¡Œã€‚å› æ­¤ï¼Œ`maxUnavailable` å’Œ `maxSurge` ä¸èƒ½åŒæ—¶ä¸º 0ï¼Œé¿å…æ›´æ–°æ— æ³•è¿›è¡Œã€‚

#### å…¶ä»–ç›¸å…³å‚æ•°

é™¤äº† `maxUnavailable` å’Œ `maxSurge`ï¼Œä»¥ä¸‹å‚æ•°åœ¨æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¹Ÿèµ·åˆ°äº†é‡è¦ä½œç”¨ï¼š

- **`spec.minReadySeconds`**
   æŒ‡å®šæ–°åˆ›å»ºçš„ Pod åœ¨è¢«è®¤ä¸ºå¯ç”¨ä¹‹å‰ï¼Œå¿…é¡»ä¿æŒå°±ç»ªçŠ¶æ€çš„æœ€å°æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚é»˜è®¤å€¼ä¸º `0` ç§’ã€‚è¿™ä¸ªå‚æ•°æœ‰åŠ©äºç¡®ä¿æ–° Pod å®Œå…¨åˆå§‹åŒ–å¹¶å‡†å¤‡å¥½æ¥æ”¶æµé‡ï¼Œé¿å…è¿‡æ—©æ¥æ”¶æµé‡å¯¼è‡´æœåŠ¡ä¸ç¨³å®šã€‚
- **`spec.progressDeadlineSeconds`**
   æŒ‡å®šæ›´æ–°è¿‡ç¨‹ä¸­å…è®¸çš„æœ€é•¿æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ï¼Œå¦‚æœåœ¨æ­¤æ—¶é—´å†…æ›´æ–°è¿›ç¨‹æœªè¾¾åˆ°é¢„æœŸçš„çŠ¶æ€ï¼Œæ›´æ–°ä¼šè¢«è§†ä¸ºå¤±è´¥å¹¶è§¦å‘å›æ»šã€‚é»˜è®¤å€¼ä¸º `600` ç§’ã€‚è¯¥å‚æ•°å¸®åŠ©é˜²æ­¢æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿæ­»é”æˆ–å¡ä½çš„æƒ…å†µã€‚
- **`spec.revisionHistoryLimit`**
   æ§åˆ¶å†å²ç‰ˆæœ¬çš„ ReplicaSet æ•°é‡ã€‚Kubernetes ä¼šä¿ç•™æœ€è¿‘ `n` ä¸ªå†å²ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º 10ï¼Œè®¾ç½®ä¸º 0 æ—¶ä¸ä¿ç•™ä»»ä½•å†å²ç‰ˆæœ¬ã€‚è¯¥å‚æ•°å¸®åŠ©ç®¡ç†æ—§ç‰ˆæœ¬çš„æ¸…ç†ã€‚
- **`spec.paused`**
   å¦‚æœè®¾ç½®ä¸º `true`ï¼ŒKubernetes å°†æš‚åœå½“å‰çš„æ»šåŠ¨æ›´æ–°ï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨æ¢å¤ã€‚è¿™åœ¨éœ€è¦æ§åˆ¶æ›´æ–°æ­¥ä¼æˆ–é¿å…è‡ªåŠ¨æ›´æ–°çš„åœºæ™¯ä¸­éå¸¸æœ‰ç”¨ã€‚

#### æ»šåŠ¨æ›´æ–°è¡Œä¸ºæ€»ç»“

- **æ»šåŠ¨æ›´æ–°çš„ä¼˜åŠ¿**ï¼šæ»šåŠ¨æ›´æ–°ç›¸æ¯”äºç›´æ¥é‡å»ºæ‰€æœ‰ Podï¼Œèƒ½å¤Ÿä¿è¯åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆæœ‰ä¸€éƒ¨åˆ† Pod å¯ç”¨ï¼Œä»è€Œæœ€å°åŒ–æœåŠ¡ä¸­æ–­çš„æ—¶é—´ã€‚å®ƒæ˜¯é«˜å¯ç”¨æ€§çš„å…³é”®ç­–ç•¥ä¹‹ä¸€ã€‚
- **æ›´æ–°æµç¨‹**ï¼šKubernetes ä¼šé€æ­¥åˆ›å»ºæ–° Podï¼Œå¹¶åœ¨æ–° Pod å¯åŠ¨æˆåŠŸååˆ é™¤æ—§ Podï¼Œç›´è‡³æ‰€æœ‰ Pod æ›´æ–°å®Œæˆã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œ`maxUnavailable` å’Œ `maxSurge` å…±åŒå†³å®šäº†æ›´æ–°çš„é€Ÿåº¦å’Œå®¹å¿çš„å¯ç”¨æ€§æŸå¤±ã€‚

#### å®é™…åº”ç”¨ä¸­çš„æ³¨æ„äº‹é¡¹

- **æ€§èƒ½å’Œå¯ç”¨æ€§æƒè¡¡**ï¼šæ ¹æ®åº”ç”¨éœ€æ±‚ï¼Œåˆç†è®¾ç½® `maxUnavailable` å’Œ `maxSurge`ï¼š
  - å¦‚æœè¦æ±‚æœåŠ¡é«˜å¯ç”¨ï¼Œåº”è¯¥å°† `maxUnavailable` è®¾ç½®ä¸ºè¾ƒä½çš„å€¼ï¼ˆå¦‚ `0` æˆ–å°‘é‡ï¼‰ï¼Œç¡®ä¿åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¿æŒè¶³å¤Ÿçš„å¯ç”¨ Podã€‚
  - å¦‚æœå¯ä»¥å®¹å¿éƒ¨åˆ† Pod çŸ­æ—¶é—´ä¸å¯ç”¨ï¼Œå¯ä»¥é€‚å½“å¢åŠ  `maxUnavailable`ï¼ŒåŒæ—¶é…ç½® `maxSurge` æ¥åŠ å¿«æ›´æ–°è¿‡ç¨‹ã€‚
- **èµ„æºé™åˆ¶**ï¼šå¦‚æœé›†ç¾¤èµ„æºæœ‰é™ï¼Œè®¾ç½®è¿‡é«˜çš„ `maxSurge` å¯èƒ½å¯¼è‡´èµ„æºè¶…è½½ï¼Œå½±å“å…¶ä»–æœåŠ¡çš„ç¨³å®šæ€§ã€‚å› æ­¤ï¼Œåº”è¯¥æ ¹æ®é›†ç¾¤èµ„æºçŠ¶å†µå’ŒæœåŠ¡éœ€æ±‚è°ƒæ•´è¿™äº›å‚æ•°ã€‚



## 3) æ— çŠ¶æ€åº”ç”¨ï¼ˆDeploymentï¼‰ä¸æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStatefulSetï¼‰å¯¹æ¯”

| ç‰¹æ€§             | æ— çŠ¶æ€åº”ç”¨ï¼ˆDeploymentï¼‰                                     | æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStatefulSetï¼‰                                    |
| ---------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **ç½‘ç»œèº«ä»½**     | æ— éœ€æŒä¹…çš„ç½‘ç»œèº«ä»½ï¼ŒPod å¯ä»¥éšæ—¶åˆ›å»ºæˆ–åˆ é™¤ã€‚Pod ä¸ä¾èµ–äºå›ºå®šçš„ DNS åç§°ã€‚ | éœ€è¦æŒä¹…çš„ç½‘ç»œèº«ä»½ï¼ŒPod åç§°å”¯ä¸€ä¸”å¯é¢„æµ‹ï¼ŒåŸºäº `{statefulset-name}-{index}` æ ¼å¼ã€‚ |
| **å­˜å‚¨**         | é€šå¸¸ä¸éœ€è¦æŒä¹…å­˜å‚¨ï¼Œæˆ–è€…ä½¿ç”¨å…±äº«å­˜å‚¨ã€‚Pod çš„æ•°æ®å¯ä»¥ä¸¢å¤±ã€‚   | éœ€è¦æŒä¹…å­˜å‚¨ï¼Œæ¯ä¸ª Pod ä¼šç»‘å®šä¸€ä¸ªæŒä¹…åŒ–å­˜å‚¨å·ï¼ˆPVCï¼‰ï¼Œå³ä½¿ Pod è¢«é”€æ¯ï¼Œæ•°æ®ä»ç„¶å­˜åœ¨ã€‚ |
| **æ‰©ç¼©**         | æ”¯æŒå¿«é€Ÿæ‰©ç¼©ï¼Œé€‚åˆæ°´å¹³æ‰©å±•ã€‚Pod å¯ä»¥åœ¨ä»»æ„æ—¶é—´åˆ›å»ºæˆ–åˆ é™¤ã€‚   | æ‰©ç¼©æœ‰åºï¼ŒPod åˆ›å»ºå’Œåˆ é™¤æœ‰ä¸¥æ ¼é¡ºåºï¼Œé€šå¸¸ç”¨äºé›†ç¾¤æ‰©å±•ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ |
| **æ›´æ–°ç­–ç•¥**     | æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œæ—§ Pod åˆ é™¤æ–° Pod åˆ›å»ºï¼Œæ›´æ–°é€Ÿåº¦è¾ƒå¿«ã€‚         | æœ‰åºæ›´æ–°ï¼Œç¡®ä¿æ¯ä¸ª Pod çš„çŠ¶æ€ä¸€è‡´æ€§ï¼ŒPod æ›´æ–°æ—¶ä¼šæŒ‰ç…§é¡ºåºè¿›è¡Œï¼Œç¡®ä¿ä¾èµ–æ€§ä¸ç ´åã€‚ |
| **å…¸å‹åº”ç”¨**     | Web æœåŠ¡å™¨ã€å¾®æœåŠ¡ã€API æœåŠ¡ç­‰æ— çŠ¶æ€æœåŠ¡ã€‚                   | æ•°æ®åº“ï¼ˆå¦‚ MySQLã€Cassandraï¼‰ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Kafkaï¼‰ã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰éœ€è¦æŒä¹…åŒ–æ•°æ®çš„æœåŠ¡ã€‚ |
| **Pod åˆ›å»ºé¡ºåº** | Pod å¯ä»¥æ— åºåˆ›å»ºï¼ŒKubernetes ä¼šéšæœºé€‰æ‹©ç©ºé—²èŠ‚ç‚¹è°ƒåº¦ Podã€‚    | Pod åˆ›å»ºæœ‰åºï¼ŒæŒ‰ç…§é¡ºåºåˆ›å»ºï¼Œä» `0` å¼€å§‹é€æ­¥åˆ›å»ºï¼Œä¿è¯æ¯ä¸ª Pod çš„çŠ¶æ€ä¾èµ–å…³ç³»ã€‚ |
| **Pod åˆ é™¤é¡ºåº** | Pod å¯ä»¥æ— åºåˆ é™¤ï¼ŒKubernetes ä¼šéšæœºé€‰æ‹©ç»ˆæ­¢ Podã€‚            | Pod åˆ é™¤æœ‰åºï¼ŒæŒ‰ç…§é€†åºåˆ é™¤ï¼Œå³å…ˆåˆ é™¤æœ€ååˆ›å»ºçš„ Podï¼Œååˆ é™¤æœ€æ—©åˆ›å»ºçš„ Podã€‚ |
| **è‡ªæˆ‘ä¿®å¤èƒ½åŠ›** | æ”¯æŒè‡ªæˆ‘ä¿®å¤ï¼Œå¤±è´¥ Pod ä¼šè‡ªåŠ¨é‡å¯ï¼Œå¹¶ä¼šé‡æ–°åˆ›å»ºå‰¯æœ¬ã€‚        | åŒæ ·æ”¯æŒè‡ªæˆ‘ä¿®å¤ï¼Œå¤±è´¥ Pod ä¼šè‡ªåŠ¨é‡å¯ï¼Œä½†ä¼šåœ¨å›ºå®šé¡ºåºä¸­æ¢å¤ã€‚æ¯ä¸ª Pod çš„åå­—å’Œå­˜å‚¨ä¸é›†ç¾¤çŠ¶æ€ç»‘å®šã€‚ |
| **èµ„æºç®¡ç†**     | é€šå¸¸ä¸éœ€è¦ç‰¹åˆ«çš„èµ„æºç®¡ç†ã€‚Kubernetes å¤„ç†å‰¯æœ¬å’Œè´Ÿè½½å‡è¡¡ã€‚    | éœ€è¦æŒä¹…åŒ–èµ„æºç®¡ç†ï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±ï¼Œèµ„æºä¼šæ ¹æ®æ¯ä¸ª Pod çš„çŠ¶æ€æ¥é…ç½®ã€‚ |
| **DNS è§£æ**     | Pod åç§°å¹¶ä¸éœ€è¦ä¿æŒä¸€è‡´ï¼Œå› æ­¤ DNS åœ°å€é€šå¸¸ä¸å¯é¢„æµ‹ã€‚        | Pod åç§°å’Œ DNS åœ°å€æ˜¯å¯é¢„æµ‹çš„ï¼Œæ ¼å¼ä¸º `{statefulset-name}-{index}.{headless-service-name}`ã€‚ |
| **å¯æ‰©å±•æ€§**     | é€‚ç”¨äºé«˜åº¦å¯æ‰©å±•çš„åº”ç”¨ï¼ŒPod å¯ä»¥æ ¹æ®éœ€æ±‚å¿«é€Ÿå¢åŠ æˆ–å‡å°‘ã€‚     | é€šå¸¸ç”¨äºæ‰©å±•æœ‰åºé›†ç¾¤ï¼Œç¡®ä¿èŠ‚ç‚¹å’Œå­˜å‚¨ä¹‹é—´çš„ä¸€è‡´æ€§å’Œé¡ºåºã€‚     |

## 4)  æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†StatefulSet

### 4.1 ä»€ä¹ˆæ˜¯StatefulSetï¼Ÿ

`StatefulSet` æ˜¯ Kubernetes ä¸­ç”¨äºç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„ API å¯¹è±¡ã€‚ä¸æ— çŠ¶æ€åº”ç”¨ï¼ˆå¦‚ä½¿ç”¨ `Deployment` æ§åˆ¶å™¨ï¼‰ä¸åŒï¼Œ`StatefulSet` ä¸»è¦ç”¨äºé‚£äº›æ¯ä¸ª Pod éƒ½æœ‰å”¯ä¸€èº«ä»½æ ‡è¯†ä¸”éœ€è¦ç¨³å®šå­˜å‚¨çš„åº”ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œæ•°æ®åº“ï¼ˆå¦‚ MySQLã€Cassandraï¼‰ã€ç¼“å­˜æœåŠ¡ï¼ˆå¦‚ Redisï¼‰å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰ã€‚

`StatefulSet` ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š

- **ç¨³å®šçš„ Pod åç§°**ï¼šæ¯ä¸ª Pod éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„åå­—ï¼Œå¯ä»¥ä¿è¯åœ¨ Pod é‡å¯æ—¶ï¼Œèƒ½å¤Ÿæ ¹æ®åå­—æ‰¾åˆ°å¯¹åº”çš„å­˜å‚¨ã€ç½‘ç»œç­‰èµ„æºã€‚
- **æŒä¹…åŒ–å­˜å‚¨**ï¼šæ¯ä¸ª Pod éƒ½æœ‰ä¸€ä¸ªæŒä¹…åŒ–çš„å­˜å‚¨å·ï¼ˆPVCï¼‰ï¼Œå³ä½¿ Pod è¢«åˆ é™¤æˆ–é‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæ•°æ®ä¾ç„¶ä¿æŒã€‚
- **ç¨³å®šçš„ç½‘ç»œæ ‡è¯†**ï¼šPod å¯ä»¥ä½¿ç”¨å›ºå®šçš„ DNS åç§°æ¥ä¸å…¶ä»–æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚

### 4.2 Headless Service

**Headless Service** æ˜¯ StatefulSet çš„å…³é”®ç»„æˆéƒ¨åˆ†ï¼Œå®ƒä¸ºæ¯ä¸ª Pod åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ DNS åç§°ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®å„ä¸ª Pod è€Œä¸æ˜¯è´Ÿè½½å‡è¡¡å™¨çš„ IP åœ°å€ã€‚

**Headless Service çš„å®šä¹‰ï¼š**

ä¸€ä¸ª Headless Service æ²¡æœ‰ cluster IP åœ°å€ï¼Œå®ƒåªæä¾› DNS è§£ææœåŠ¡æ¥å®ç°ä¸å„ä¸ª Pod çš„ç›´æ¥é€šä¿¡ã€‚Headless Service çš„å®šä¹‰æ–¹æ³•æ˜¯é€šè¿‡è®¾ç½® `spec.clusterIP: None` æ¥ç¦ç”¨é›†ç¾¤ IPã€‚

ç¤ºä¾‹ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-statefulset-service
spec:
  clusterIP: None  # å…³é”®ç‚¹ï¼Œç¦ç”¨ Cluster IP
  selector:
    app: my-statefulset
  ports:
    - port: 8080
      name: http
```

### 4.3 StatefulSet çš„ YAML é…ç½®è§£é‡Š

StatefulSet çš„èµ„æºæ–‡ä»¶å®šä¹‰æ–¹å¼ä¸å…¶ä»– Kubernetes èµ„æºç±»ä¼¼ï¼Œé€šè¿‡ YAML æ–‡ä»¶æ¥æè¿°ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ StatefulSet ç¤ºä¾‹ã€‚

`vim sts-web.yaml`

```yaml
# å®šä¹‰ä¸€ä¸ª Headless Service
apiVersion: v1  # ä½¿ç”¨ v1 ç‰ˆæœ¬çš„ Kubernetes API
kind: Service  # æœåŠ¡ç±»å‹ä¸º Service
metadata:
  name: nginx-headless  # å®šä¹‰æœåŠ¡çš„åç§°ä¸º nginx-headless
  labels:
    app: nginx-headless  # æ ‡ç­¾ï¼Œæ–¹ä¾¿åç»­åŒ¹é…
spec:
  ports:
    - port: 80  # æœåŠ¡æš´éœ²çš„ç«¯å£ä¸º 80
      name: web  # ç»™è¿™ä¸ªç«¯å£å–åä¸º web
  clusterIP: None  # è®¾ç½®ä¸º Noneï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª Headless Serviceï¼ˆæ²¡æœ‰ Cluster IPï¼‰
  selector:
    app: nginx-sts  # é€‰æ‹©å™¨ï¼Œé€‰æ‹©æ ‡ç­¾ä¸º app: nginx-sts çš„ Pod æ¥å…³è”æœåŠ¡

---
# å®šä¹‰ StatefulSet èµ„æº
apiVersion: apps/v1  # ä½¿ç”¨ apps/v1 ç‰ˆæœ¬çš„ StatefulSet API
kind: StatefulSet  # èµ„æºç±»å‹ä¸º StatefulSet
metadata:
  name: web  # å®šä¹‰ StatefulSet çš„åç§°ä¸º web
spec:
  serviceName: "nginx-headless"  # æŒ‡å®šä½¿ç”¨çš„ Service åç§°ä¸º nginx-headlessï¼ˆHeadless Serviceï¼‰
  replicas: 2  # è®¾ç½®å‰¯æœ¬æ•°ä¸º 2ï¼Œè¡¨ç¤ºä¼šåˆ›å»º 2 ä¸ª Pod
  selector:
    matchLabels:
      app: nginx-sts  # StatefulSet ä½¿ç”¨è¿™ä¸ª selector æ¥åŒ¹é…å…·æœ‰æ ‡ç­¾ app: nginx-sts çš„ Pod
  template:
    metadata:
      labels:
        app: nginx-sts  # ä¸º Pod æ·»åŠ æ ‡ç­¾ app: nginx-sts
    spec:
      containers:
        - name: nginx  # å®¹å™¨åç§°ä¸º nginx
          image: m.daocloud.io/docker.io/library/nginx:latest  # ä½¿ç”¨ m.daocloud.io/docker.io/library/nginx:latest é•œåƒ
          ports:
            - containerPort: 80  # å®¹å™¨å†…çš„ç«¯å£ä¸º 80
              name: web  # ç»™å®¹å™¨ç«¯å£å–åä¸º web
#          volumeMounts:
#            - name: nginx-data  # æŒ‚è½½åä¸º nginx-data çš„å·
#              mountPath: /usr/share/nginx/html  # æŒ‚è½½åˆ°å®¹å™¨å†…æŒ‡å®šçš„ç›®å½•ï¼Œç”¨äºå­˜å‚¨é™æ€å†…å®¹
#  volumeClaimTemplates:
#    - metadata:
#        name: nginx-data  # æŒä¹…åŒ–å­˜å‚¨å·çš„åå­—
#      spec:
#        accessModes:
#          - ReadWriteOnce  # æŒ‡å®šè®¿é—®æ¨¡å¼ï¼ŒPod åªèƒ½ä»¥è¯»å†™æ¨¡å¼è®¿é—®å·
#        resources:
#          requests:
#            storage: 1Gi  # ä¸ºæ¯ä¸ª Pod è¯·æ±‚ 1Gi çš„å­˜å‚¨ç©ºé—´
```

### 4.4 åˆ›å»º StatefulSet

**åˆ›å»ºsts-web**

```bash
root@k8s-master:~/yaml# kubectl apply -f sts-web.yaml
service/nginx-headless created
statefulset.apps/web created
```

**æŸ¥çœ‹stsç»“æœçŠ¶æ€**

```bash
root@k8s-master:~/yaml# kubectl get sts
NAME   READY   AGE
web    2/2     18s

#å¯ä»¥çœ‹åˆ°å·²ç»åˆ›å»ºå¹¶æˆåŠŸè¿è¡Œ
```

**æŸ¥çœ‹SVCæ˜¯å¦åˆ›å»ºæˆåŠŸ**

- æœåŠ¡ç±»å‹æœ¬è´¨ä¸Šæ˜¯ `ClusterIP`ï¼Œä½†é€šè¿‡è®¾ç½® `clusterIP: None`ï¼Œå®ƒå˜æˆäº†ä¸€ä¸ª Headless æœåŠ¡ã€‚
- è¿™ç§æ–¹å¼ä¸æä¾›å•ä¸€çš„è´Ÿè½½å‡è¡¡ IPï¼Œè€Œæ˜¯è®©æ¯ä¸ª Pod å…·æœ‰è‡ªå·±çš„ DNS åç§°ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—®æ¯ä¸ª Podã€‚
- åœ¨ `kubectl get svc` ä¸­æŸ¥çœ‹æ—¶ï¼Œ`nginx-headless` ä¼šæ˜¾ç¤ºä¸º `ClusterIP`ï¼Œä½†æ³¨æ„å®ƒçš„ `ClusterIP` è¢«è®¾ç½®ä¸º `None`

é€šè¿‡è®¾ç½® `ClusterIP: None`ï¼ŒæœåŠ¡ä¸ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªå•ä¸€çš„ IP åœ°å€ï¼Œè€Œæ˜¯ç›´æ¥æš´éœ² Pod çš„ DNS åç§°ã€‚Kubernetes ä¼šä¸ºæ¯ä¸ª Pod åˆ›å»ºä¸€ä¸ª DNS è®°å½•ï¼Œç±»ä¼¼äºï¼š`web-0.nginx-headless.default.svc.cluster.local`ï¼Œ`web-1.nginx-headless.default.svc.cluster.local`ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡è¿™äº› DNS åç§°æ¥è®¿é—®æ¯ä¸ª Podã€‚

```bash
root@k8s-master:~/yaml# kubectl get svc
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
kubernetes       ClusterIP   10.96.0.1    <none>        443/TCP   7d21h
nginx-headless   ClusterIP   None         <none>        80/TCP    24s
```

è®¿é—®headlessæ—¶éœ€æ³¨æ„ï¼ŒåŒä¸€å‘½åç©ºé—´å†…å¯ä»¥çœç•¥å‘½åç©ºé—´åç§°ï¼Œä½†æ˜¯ä¸åŒå‘½åç©ºé—´å°½é‡é¿å…è¿™ç§è®¿é—®æ¨¡å¼ä»¥è§„é¿ç½‘ç»œäº¤å‰é£é™©

```bash
[root@k8s-master yaml]# kubectl exec -it web-0 -- sh
/ # curl  -I web-1.nginx-headless
HTTP/1.1 200 OK
Server: nginx/1.27.4
Date: Thu, 20 Feb 2025 08:50:09 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Wed, 05 Feb 2025 14:46:11 GMT
Connection: keep-alive
ETag: "67a379b3-267"
Accept-Ranges: bytes
```

**æ ¹æ®æ ‡ç­¾æŸ¥çœ‹stsåˆ›å»ºçš„po**

```bash
root@k8s-master:~/yaml# kubectl get po -l app=nginx-sts
NAME    READY   STATUS    RESTARTS   AGE
web-0   1/1     Running   0          88s
web-1   1/1     Running   0          83s
```



### 4.5 StatefulSet åˆ›å»º Pod æµç¨‹

**StatefulSet ç®¡ç†çš„ Pod éƒ¨ç½²å’Œæ‰©å±•è§„åˆ™å¦‚ä¸‹ï¼š**

- å¯¹äºå…·æœ‰Nä¸ªå‰¯æœ¬çš„StatefulSetï¼Œå°†æŒ‰é¡ºåºä»0åˆ°N-1å¼€å§‹åˆ›å»ºPodï¼›
- å½“åˆ é™¤Podæ—¶ï¼Œå°†æŒ‰ç…§N-1åˆ°0çš„åé¡ºåºç»ˆæ­¢ï¼›
- åœ¨ç¼©æ”¾Podä¹‹å‰ï¼Œå¿…é¡»ä¿è¯å½“å‰çš„Podæ˜¯Runningï¼ˆè¿è¡Œä¸­ï¼‰æˆ–è€…Readyï¼ˆå°±ç»ªï¼‰ï¼›
- åœ¨ç»ˆæ­¢Podä¹‹å‰ï¼Œå®ƒæ‰€æœ‰çš„ç»§ä»»è€…å¿…é¡»æ˜¯å®Œå…¨å…³é—­çŠ¶æ€ã€‚

> [!CAUTION]
>
> â€‹	`StatefulSet` çš„ `pod.Spec.TerminationGracePeriodSeconds`ï¼ˆç»ˆæ­¢ Pod çš„ç­‰å¾…æ—¶é—´ï¼‰ä¸åº”è¯¥æŒ‡å®š  ä¸º 0ï¼Œè®¾ç½®ä¸º 0 å¯¹ `StatefulSet` çš„ Pod æ˜¯æå…¶ä¸å®‰å…¨çš„åšæ³•ï¼Œä¼˜é›…åœ°åˆ é™¤ StatefulSet çš„ Pod æ˜¯éå¸¸  æœ‰å¿…è¦çš„ï¼Œè€Œä¸”æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥ç¡®ä¿åœ¨ Kubelet ä» APIServer åˆ é™¤ä¹‹å‰ï¼Œè®© Pod æ­£å¸¸å…³é—­ã€‚
> â€‹	å½“åˆ›å»ºä¸Šé¢çš„ Nginx å®ä¾‹æ—¶ï¼ŒPod å°†æŒ‰ web-0ã€web-1ã€web-2 çš„é¡ºåºéƒ¨ç½² 3 ä¸ª Podã€‚åœ¨ web0 å¤„äº Running æˆ–è€… Ready ä¹‹å‰ï¼Œweb-1 ä¸ä¼šè¢«éƒ¨ç½²ï¼Œç›¸åŒçš„ï¼Œweb-2 åœ¨ web-1 æœªå¤„äº Running  å’Œ Ready ä¹‹å‰ä¹Ÿä¸ä¼šè¢«éƒ¨ç½²ã€‚å¦‚æœåœ¨ web-1 å¤„äº Running å’Œ Ready çŠ¶æ€æ—¶ï¼Œweb-0 å˜æˆ Failed  ï¼ˆå¤±è´¥ï¼‰çŠ¶æ€ï¼Œé‚£ä¹ˆ web-2 å°†ä¸ä¼šè¢«å¯åŠ¨ï¼Œç›´åˆ° web-0 æ¢å¤ä¸º Running å’Œ Ready çŠ¶æ€ã€‚
> â€‹	å¦‚æœç”¨æˆ·å°† StatefulSet çš„ `replicas` è®¾ç½®ä¸º 1ï¼Œé‚£ä¹ˆ web-2 å°†é¦–å…ˆè¢«ç»ˆæ­¢ï¼Œåœ¨å®Œå…¨å…³é—­å¹¶åˆ é™¤  web-2 ä¹‹å‰ï¼Œä¸ä¼šåˆ é™¤ web-1ã€‚å¦‚æœ web-2 ç»ˆæ­¢å¹¶ä¸”å®Œå…¨å…³é—­åï¼Œweb-0 çªç„¶å¤±è´¥ï¼Œé‚£ä¹ˆåœ¨ web0 æœªæ¢å¤æˆ Running æˆ–è€… Ready æ—¶ï¼Œweb-1 ä¸ä¼šè¢«åˆ é™¤ã€‚



### 4.6 StatefulSet æ‰©å®¹å’Œç¼©å®¹

å’Œ Deployment ç±»ä¼¼ï¼Œå¯ä»¥é€šè¿‡æ›´æ–° replicas å­—æ®µæ‰©å®¹/ç¼©å®¹ StatefulSetï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ kubectl scaleã€kubectl edit å’Œ kubectl patch æ¥æ‰©å®¹/ç¼©å®¹ä¸€ä¸ª StatefulSetã€‚

**kubectl scaleæ‰©å®¹å‘½ä»¤ï¼š**

```bash
[root@k8s-master yaml]# kubectl scale statefulset web --replicas=4
statefulset.apps/web scaled

[root@k8s-master yaml]# kubectl get po -l app=nginx-sts
NAME    READY   STATUS    RESTARTS   AGE
web-0   1/1     Running   0          56m
web-1   1/1     Running   0          55m
web-2   1/1     Running   0          51s
web-3   1/1     Running   0          49s

```

**kubectl scaleç¼©å®¹å‘½ä»¤ï¼š**

æ‰©å®¹å’Œç¼©å®¹è¿‡ç¨‹ä¸­ï¼ŒStatefulSet ä¼šä¿æŒ Pod çš„é¡ºåºç¼–å·ï¼Œå¹¶æŒ‰é¡ºåºåˆ›å»ºæˆ–åˆ é™¤ Podã€‚

```bash
[root@k8s-master yaml]# kubectl scale statefulset web --replicas=2
statefulset.apps/web scaled

root@k8s-master:~# kubectl get po -l app=nginx-sts -w
NAME    READY   STATUS    RESTARTS   AGE
web-0   1/1     Running   0          57m
web-1   1/1     Running   0          56m
web-2   1/1     Running   0          107s
web-3   1/1     Running   0          105s
web-3   1/1     Terminating   0          117s
web-3   1/1     Terminating   0          118s
web-3   0/1     Terminating   0          118s
web-3   0/1     Terminating   0          118s
web-3   0/1     Terminating   0          118s
web-3   0/1     Terminating   0          118s
web-2   1/1     Terminating   0          2m
web-2   1/1     Terminating   0          2m1s
web-2   0/1     Terminating   0          2m1s
web-2   0/1     Terminating   0          2m1s
web-2   0/1     Terminating   0          2m1s
web-2   0/1     Terminating   0          2m1s

[root@k8s-master yaml]# kubectl get po -l app=nginx-sts
NAME    READY   STATUS    RESTARTS   AGE
web-0   1/1     Running   0          58m
web-1   1/1     Running   0          57m
```



### 4.7 StatefulSet æ›´æ–°ç­–ç•¥

StatefulSet æ‹¥æœ‰ä¸¤ç§æ›´æ–°ç­–ç•¥ï¼Œåˆ†åˆ«ä¸º`RollingUpdate`å’Œ `OnDelete`ç­–ç•¥

**RollingUpdateç­–ç•¥è¯´æ˜(é»˜è®¤)ï¼š**

`RollingUpdate` ä¼šæŒ‰é¡ºåºé€ä¸ªæ›´æ–° Podã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½® `partition` æ¥æ§åˆ¶ä»å“ªä¸ª Pod å¼€å§‹æ›´æ–°ã€‚`partition` è®¾ç½®çš„æ˜¯ **ä¸ä¼šè¢«æ›´æ–°çš„ Pod** æ•°é‡ã€‚å› æ­¤ï¼Œ`partition + 1` ä¼šæ˜¯å¼€å§‹æ›´æ–°çš„ç¬¬ä¸€ä¸ª Podã€‚å³ `partition` æ˜¯å·²æ›´æ–° Pod çš„æ•°é‡ï¼Œæ‰€ä»¥ **partition è¶Šå¤§ï¼Œè¶Šé åçš„ Pod æ‰ä¼šæ›´æ–°**ã€‚

**ä¸¾ä¾‹è¯´æ˜**ï¼š

å‡è®¾æˆ‘ä»¬æœ‰ 6 ä¸ª Podï¼Œåç§°åˆ†åˆ«ä¸º `web-0` åˆ° `web-5`ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½® `partition: 3`ï¼Œé‚£ä¹ˆåœ¨æ›´æ–°æ—¶ï¼Œ`web-0` åˆ° `web-2` ä¸ä¼šæ›´æ–°ï¼Œè€Œä» `web-3` å¼€å§‹é€ä¸ªæ›´æ–°ã€‚æ›´æ–°é¡ºåºæ˜¯ä» `web-3`ã€`web-4`ã€`web-5` å¼€å§‹ã€‚

```yaml
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 3  # ä» web-3 å¼€å§‹æ›´æ–°
```

 **OnDelete ç­–ç•¥è¯´æ˜**

`OnDelete` ç­–ç•¥æ„å‘³ç€åªæœ‰å½“ Pod è¢«åˆ é™¤åï¼ŒStatefulSet æ‰ä¼šåˆ›å»ºæ–°çš„ Podã€‚å› æ­¤ï¼Œä½ éœ€è¦æ‰‹åŠ¨åˆ é™¤å·²å­˜åœ¨çš„ Podï¼Œç³»ç»Ÿæ‰ä¼šé‡æ–°åˆ›å»ºå¹¶æ›´æ–°å®ƒã€‚

**ä¸¾ä¾‹è¯´æ˜**ï¼š

å¦‚æœæˆ‘ä»¬æœ‰ `web-0` åˆ° `web-5` è¿™å…­ä¸ª Podï¼Œå½“ä½ åˆ é™¤ `web-0` åï¼Œç³»ç»Ÿä¼šåˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£å®ƒï¼Œç›´åˆ°æ‰€æœ‰ Pod éƒ½è¢«æ›´æ–°ã€‚

```yaml
spec:
  updateStrategy:
    type: OnDelete  # åªæœ‰åˆ é™¤åæ‰ä¼šåˆ›å»ºæ–°çš„ Pod
```

**RollingUpdateå®éªŒéªŒè¯ç°åº¦å‘å¸ƒ**

```bash
#æŸ¥çœ‹é»˜è®¤çš„æ›´æ–°ç­–ç•¥
[root@k8s-master ~]# kubectl get sts web -o yaml | grep -A 3 "updateStrategy"
  updateStrategy:
    rollingUpdate:
      partition: 0				   # ä¸º0 å°±æ˜¯ä»web-0 å¼€å§‹è¿›è¡Œæ›´æ–°
    type: RollingUpdate            #é»˜è®¤æ›´æ–°ç­–ç•¥ä¸ºæ»šåŠ¨æ›´æ–°

#ä¿®æ”¹partition: ä¸º2
kubectl edit sts web
kubectl get sts web -o yaml | grep -A 3 "updateStrategy"
  updateStrategy:
    rollingUpdate:
      partition: 2
    type: RollingUpdate


#æŸ¥çœ‹å½“å‰é•œåƒä½¿ç”¨çš„æ˜¯alpine
[root@k8s-master ~]# kubectl get po -o yaml |grep image:
    - image: m.daocloud.io/docker.io/library/nginx:alpine
      image: m.daocloud.io/docker.io/library/nginx:alpine
    - image: m.daocloud.io/docker.io/library/nginx:alpine
      image: m.daocloud.io/docker.io/library/nginx:alpine
    - image: m.daocloud.io/docker.io/library/nginx:alpine
      image: m.daocloud.io/docker.io/library/nginx:alpine
    - image: m.daocloud.io/docker.io/library/nginx:alpine
      image: m.daocloud.io/docker.io/library/nginx:alpine


#é•œåƒç‰ˆæœ¬æ›´æ”¹ä¸º m.daocloud.io/docker.io/library/nginx:1.16å¹¶è¿›è¡ŒéªŒè¯
kubectl edit sts web

for i in 0 1 2 3; do   echo "web-$i"; kubectl get po web-$i -o jsonpath='{.spec.containers[*].image}';echo ""; done
web-0
m.daocloud.io/docker.io/library/nginx:alpine
web-1
m.daocloud.io/docker.io/library/nginx:alpine
web-2
m.daocloud.io/docker.io/library/nginx:1.16       # å¯ä»¥çœ‹åˆ°ä» web-2å¼€å§‹è¿›è¡Œäº†æ›´æ–°
web-3
m.daocloud.io/docker.io/library/nginx:1.16

# é€šè¿‡è¿™ç§æ›´æ–°æ–¹å¼å¯ä»¥å®ç°åˆ†é˜¶æ®µæ›´æ–°ï¼Œç±»ä¼¼äºç°åº¦/é‡‘ä¸é›€å‘å¸ƒã€‚
```

**OnDelete å®éªŒéªŒè¯**

ä½¿ç”¨ `OnDelete` æ›´æ–°ç­–ç•¥æ—¶ï¼ŒStatefulSet ä¸ä¼šè‡ªåŠ¨æ›´æ–° Podã€‚ä½ éœ€è¦æ‰‹åŠ¨åˆ é™¤éœ€è¦å‡çº§çš„ Podï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºå¹¶æ›´æ–°å®ƒä»¬ã€‚ä»¥ä¸‹æ˜¯å®éªŒæ­¥éª¤ï¼š

```bash
#æ£€æŸ¥å½“å‰æ›´æ–°ç­–ç•¥ç¡®ä¿ StatefulSet çš„æ›´æ–°ç­–ç•¥è®¾ç½®ä¸º OnDeleteï¼š
[root@k8s-master ~]# kubectl get sts web -o yaml | grep -A 1 "updateStrategy"
  updateStrategy:
    type: OnDelete				# ç¡®ä¿ç±»å‹ä¸º OnDelete


#æ£€æŸ¥å½“å‰è¿è¡Œçš„ Pod åŠå…¶ä½¿ç”¨çš„é•œåƒç‰ˆæœ¬ï¼š
[root@k8s-master ~]# kubectl get pods -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
web-0	m.daocloud.io/docker.io/library/nginx:1.16
web-1	m.daocloud.io/docker.io/library/nginx:1.16
web-2	m.daocloud.io/docker.io/library/nginx:1.16
web-3	m.daocloud.io/docker.io/library/nginx:1.16


#ä¿®æ”¹é•œåƒç‰ˆæœ¬æ›´æ–° StatefulSet ä½¿ç”¨çš„é•œåƒç‰ˆæœ¬ï¼ˆä¾‹å¦‚ï¼Œä» nginx:1.16æ›´æ–°åˆ° nginx:alpine ï¼‰ï¼š
kubectl edit sts web

#éªŒè¯æ˜¯å¦æœ‰è‡ªåŠ¨æ›´æ–°
[root@k8s-master ~]# kubectl get pods -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
web-0	m.daocloud.io/docker.io/library/nginx:1.16
web-1	m.daocloud.io/docker.io/library/nginx:1.16
web-2	m.daocloud.io/docker.io/library/nginx:1.16
web-3	m.daocloud.io/docker.io/library/nginx:1.16


#é€‰æ‹©ä¸€ä¸ªéœ€è¦æ›´æ–°çš„ Pod è¿›è¡Œæ‰‹å·¥åˆ é™¤éªŒè¯ï¼š
kubectl delete pod web-2
è¿™å°†åˆ é™¤ web-2ï¼Œéšå StatefulSet ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„ web-2 Podï¼Œä½¿ç”¨çš„æ˜¯æ›´æ–°åçš„é•œåƒç‰ˆæœ¬ã€‚


#æ£€æŸ¥é‡æ–°åˆ›å»ºçš„ Pod çš„é•œåƒç‰ˆæœ¬æ˜¯å¦å·²æ›´æ–°ï¼š
[root@k8s-master ~]# kubectl get pods 
NAME    READY   STATUS    RESTARTS   AGE
web-0   1/1     Running   0          8m26s
web-1   1/1     Running   0          8m29s
web-2   1/1     Running   0          5s
web-3   1/1     Running   0          33m
[root@k8s-master ~]# kubectl get pods -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}'
web-0	m.daocloud.io/docker.io/library/nginx:1.16
web-1	m.daocloud.io/docker.io/library/nginx:1.16
web-2	m.daocloud.io/docker.io/library/nginx:alpine         #å¯ä»¥çœ‹åˆ°é•œåƒå·²ç»å‘ç”Ÿäº†æ”¹å˜
web-3	m.daocloud.io/docker.io/library/nginx:1.16
```

### 4.8 åˆ é™¤ StatefulSet

åˆ é™¤StatefulSetæœ‰ä¸¤ç§æ–¹å¼ï¼Œå³çº§è”åˆ é™¤å’Œéçº§è”åˆ é™¤ã€‚ä½¿ç”¨éçº§è”æ–¹å¼åˆ é™¤ StatefulSetæ—¶ï¼ŒStatefulSet çš„ Pod ä¸ä¼šè¢«åˆ é™¤ï¼›ä½¿ç”¨çº§è”åˆ é™¤æ—¶ï¼ŒStatefulSet å’Œå®ƒçš„ Pod éƒ½ä¼šè¢«åˆ é™¤ã€‚

**éçº§è”åˆ é™¤**

åœ¨è¿›è¡Œéçº§è”åˆ é™¤æ—¶ï¼Œä»…åˆ é™¤ StatefulSet å¯¹è±¡ï¼Œè€Œä¿ç•™å…¶å…³è”çš„ Podã€‚åªéœ€æä¾›--cascade=false å‚æ•°å³å¯å®ç°

```bash
kubectl delete sts web --cascade=orphan
```

æ­¤å‘½ä»¤ä¼šåˆ é™¤ `web` StatefulSetï¼Œä½†ä¿ç•™æ‰€æœ‰å…³è”çš„ Podã€‚Pod å°†ç»§ç»­è¿è¡Œä¸”å—æ§åˆ¶å™¨ç®¡ç†ã€‚

**çº§è”åˆ é™¤**

åœ¨çº§è”åˆ é™¤æ—¶ï¼ŒStatefulSet åŠå…¶æ‰€æœ‰å…³è”çš„ Pod éƒ½ä¼šè¢«åˆ é™¤ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ é™¤ StatefulSet ä½¿ç”¨çš„æ˜¯çº§è”åˆ é™¤ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š

```bash
kubectl delete sts web
```

ä¹Ÿå¯ä»¥é€šè¿‡åˆ›å»ºçš„yamlæ–‡ä»¶è¿›è¡Œåˆ é™¤

```bash
[root@k8s-master yaml]# kubectl delete -f  sts-web.yaml
service "nginx-headless" deleted
statefulset.apps "web" deleted

#å¯ä»¥çœ‹åˆ°é€šè¿‡yamlæ–‡ä»¶åˆ›å»ºçš„svcå’Œsts,po éƒ½å·²è¢«åˆ é™¤
[root@k8s-master yaml]# kubectl get po,svcï¼Œsts
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   8d
```

æ­¤å‘½ä»¤ä¼šåˆ é™¤ `web` StatefulSet åŠå…¶æ‰€æœ‰å…³è”çš„ Podï¼Œç¡®ä¿é›†ç¾¤çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚

é€šè¿‡ä»¥ä¸Šä¸¤ç§åˆ é™¤ç­–ç•¥ï¼Œä½ å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©æ˜¯ä»…åˆ é™¤ StatefulSet è¿˜æ˜¯åŒæ—¶åˆ é™¤ StatefulSet ä¸å…¶å…³è”çš„ Podã€‚



## 5) å®ˆæŠ¤è¿›ç¨‹é›† DaemonSet

### 5.1 ä»€ä¹ˆæ˜¯ DaemonSetï¼Ÿ

DaemonSet æ˜¯ Kubernetes ä¸­çš„ä¸€ç§æ§åˆ¶å™¨ï¼Œç”¨äºç¡®ä¿åœ¨é›†ç¾¤ä¸­æ»¡è¶³åŒ¹é…è§„åˆ™çš„çš„æ¯ä¸ªï¼ˆæˆ–ç‰¹å®šï¼‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªç›¸åŒçš„ Pod å‰¯æœ¬ã€‚è¿™äº› Pod é€šå¸¸ç”¨äºé›†ç¾¤èŒƒå›´å†…çš„ä»»åŠ¡ï¼Œä¾‹å¦‚ï¼š

- **æ—¥å¿—æ”¶é›†**ï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ”¶é›†æ—¥å¿—å¹¶å°†å…¶å‘é€åˆ°é›†ä¸­å¼æ—¥å¿—ç³»ç»Ÿã€‚
- **ç›‘æ§ä»£ç†**ï¼šè¿è¡Œç›‘æ§å·¥å…·ä»¥æ”¶é›†èŠ‚ç‚¹å’Œåº”ç”¨çš„æ€§èƒ½æŒ‡æ ‡ã€‚
- **ç½‘ç»œæ’ä»¶**ï¼šç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œç½‘ç»œç›¸å…³çš„å®ˆæŠ¤è¿›ç¨‹ã€‚

DaemonSet ä¸ Deployment æ§åˆ¶å™¨ä¸åŒï¼ŒDeployment ä¸“æ³¨äºè·¨å¤šä¸ªèŠ‚ç‚¹è¿è¡Œç‰¹å®šæ•°é‡çš„ Pod å‰¯æœ¬ï¼Œè€Œ DaemonSet ç¡®ä¿åœ¨æ¯ä¸ªæ»¡è¶³åŒ¹é…è§„åˆ™ï¼ˆæˆ–ç‰¹å®šï¼‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod å‰¯æœ¬ã€‚ç‰¹å®šèŠ‚ç‚¹çš„é€‰æ‹©å¯ä»¥é€šè¿‡ä»¥ä¸‹æ¡ä»¶è¿›è¡Œé…ç½®ï¼š

- **Node Selector**ï¼šåŸºäºèŠ‚ç‚¹æ ‡ç­¾è¿›è¡Œé€‰æ‹©ã€‚
- **Node Affinity**ï¼šåŸºäºèŠ‚ç‚¹çš„äº²å’Œæ€§è§„åˆ™è¿›è¡Œé€‰æ‹©ï¼ŒåŒ…æ‹¬å¼ºåˆ¶è¦æ±‚å’Œä¼˜å…ˆè¦æ±‚ã€‚
- **Pod Affinity**ï¼šåŸºäº Pod çš„äº²å’Œæ€§è§„åˆ™è¿›è¡Œé€‰æ‹©ï¼Œå†³å®š Pod æ˜¯å¦ä¸å…¶ä»– Pod å…±å­˜äºåŒä¸€èŠ‚ç‚¹ã€‚

DaemonSet çš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

- **è‡ªåŠ¨éƒ¨ç½²åˆ°æ–°èŠ‚ç‚¹**ï¼šå½“é›†ç¾¤ä¸­æœ‰æ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼ŒDaemonSet ä¼šè‡ªåŠ¨åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡ŒæŒ‡å®šçš„ Pod å‰¯æœ¬ã€‚
- **æ”¯æŒç‰¹å®šèŠ‚ç‚¹**ï¼šå¯ä»¥é€šè¿‡èŠ‚ç‚¹é€‰æ‹©å™¨æˆ–èŠ‚ç‚¹äº²å’Œæ€§æŒ‡å®š DaemonSet ä»…åœ¨æŸäº›èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚
- **ç‹¬ç«‹ç®¡ç†å’Œæ›´æ–°**ï¼šå¯ä»¥ç‹¬ç«‹ç®¡ç†å’Œæ›´æ–°é›†ç¾¤ä¸­çš„ç³»ç»ŸæœåŠ¡ï¼Œè€Œä¸å½±å“åº”ç”¨å±‚çš„æœåŠ¡ã€‚

### 5.3 DaemonSetçš„ YAML é…ç½®è§£é‡Š

```yaml
apiVersion: apps/v1        # å¿…é€‰ï¼ŒæŒ‡å®šä½¿ç”¨çš„APIç‰ˆæœ¬ï¼Œè¡¨ç¤ºä½¿ç”¨apps/v1ç‰ˆæœ¬çš„DaemonSet
kind: DaemonSet            # å¿…é€‰ï¼Œèµ„æºç±»å‹æ˜¯DaemonSetï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªDaemonSetèµ„æº
metadata:                  # å¿…é€‰ï¼Œèµ„æºçš„å…ƒæ•°æ®éƒ¨åˆ†ï¼ŒåŒ…å«æ ‡ç­¾å’Œåç§°ç­‰ä¿¡æ¯
  labels:                  # å¯é€‰ï¼Œæ ‡ç­¾ï¼Œç”¨äºæ ‡è¯†å’Œé€‰æ‹©è¯¥DaemonSet
    app: nginx             # å¯é€‰ï¼Œæ ‡ç­¾é”®å€¼å¯¹ï¼Œè¡¨ç¤ºè¿™ä¸ªDaemonSetç®¡ç†çš„åº”ç”¨æ˜¯nginx
  name: nginx              # å¿…é€‰ï¼ŒDaemonSetçš„åç§°ï¼Œç”¨äºå”¯ä¸€æ ‡è¯†è¿™ä¸ªDaemonSet
spec:                      # å¿…é€‰ï¼ŒDaemonSetçš„è§„èŒƒéƒ¨åˆ†ï¼Œå®šä¹‰DaemonSetçš„æœŸæœ›çŠ¶æ€
  selector:                # å¿…é€‰ï¼Œé€‰æ‹©å™¨ï¼Œç”¨äºé€‰æ‹©å“ªäº›Podsç”±è¯¥DaemonSetç®¡ç†
    matchLabels:           # å¿…é€‰ï¼Œä½¿ç”¨æ ‡ç­¾åŒ¹é…æ¥é€‰æ‹©ç›¸å…³çš„Pods
      app: nginx           # å¿…é€‰ï¼Œé€‰æ‹©æ ‡ç­¾ä¸ºapp: nginxçš„Pods
  template:                # å¿…é€‰ï¼ŒPodæ¨¡æ¿ï¼Œç”¨äºåˆ›å»ºPod
    metadata:              # å¿…é€‰ï¼ŒPodçš„å…ƒæ•°æ®éƒ¨åˆ†
      labels:              # å¿…é€‰ï¼ŒPodçš„æ ‡ç­¾ï¼Œæ ‡è¯†Podå±äºnginxåº”ç”¨
        app: nginx         # å¿…é€‰ï¼ŒPodçš„æ ‡ç­¾ï¼Œæ ‡è¯†Podå±äºnginxåº”ç”¨
    spec:                  # å¿…é€‰ï¼ŒPodçš„è§„æ ¼éƒ¨åˆ†ï¼Œå®šä¹‰Podå†…å®¹å™¨çš„é…ç½®
      containers:          # å¿…é€‰ï¼ŒPodä¸­çš„å®¹å™¨åˆ—è¡¨ï¼ŒDaemonSetè‡³å°‘éœ€è¦ä¸€ä¸ªå®¹å™¨
        - image: m.daocloud.io/docker.io/library/nginx:alpine  # å¿…é€‰ï¼Œå®¹å™¨é•œåƒï¼ŒæŒ‡å®šnginxçš„ç‰ˆæœ¬
          imagePullPolicy: IfNotPresent  # å¯é€‰ï¼Œé•œåƒæ‹‰å–ç­–ç•¥ï¼Œåªæœ‰æœ¬åœ°æ²¡æœ‰è¯¥é•œåƒæ—¶æ‰æ‹‰å–
          name: nginx             # å¿…é€‰ï¼Œå®¹å™¨çš„åç§°ï¼ŒæŒ‡å®šå®¹å™¨çš„åç§°ä¸ºnginx
```

### 5.4 åˆ›å»ºDaemonSet

```bash
[root@k8s-master yaml]# kubectl apply -f ds-nginx.yaml 
daemonset.apps/nginx created

#æŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºäº†ä¸¤ä¸ªpoï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æŒ‡å®šå‰¯æœ¬æ•°é‡
[root@k8s-master yaml]# kubectl get po -owide
NAME          READY   STATUS    RESTARTS   AGE   IP               NODE        NOMINATED NODE   READINESS GATES
nginx-45pqp   1/1     Running   0          17s   172.16.84.175    k8s-work2   <none>           <none>
nginx-hkh9w   1/1     Running   0          17s   172.16.182.235   k8s-work1   <none>           <none>

#æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦æœ‰è®¾ç½®æ±¡ç‚¹ï¼Œå‘ç°masterèŠ‚ç‚¹æœ‰æ±¡ç‚¹ï¼Œæ‰€ä»¥ä¸Šé¢æ²¡æœ‰éƒ¨ç½²po
[root@k8s-master yaml]# kubectl get nodes -o custom-columns="NODE:.metadata.name,TAINTS:.spec.taints"
NODE         TAINTS
k8s-master   [map[effect:NoSchedule key:node-role.kubernetes.io/control-plane]]
k8s-work1    <none>
k8s-work2    <none>
```

### 5.5 æ±¡ç‚¹è®¾ç½®

**æŸ¥çœ‹æ±¡ç‚¹**

```bash
[root@k8s-master yaml]# kubectl get nodes -o custom-columns="NODE:.metadata.name,TAINTS:.spec.taints"
NODE         TAINTS
k8s-master   [map[effect:NoSchedule key:node-role.kubernetes.io/control-plane]]
k8s-work1    <none>
k8s-work2    <none>

#-o custom-columns="NODE:.metadata.name,TAINTS:.spec.taints"ï¼šä½¿ç”¨è‡ªå®šä¹‰åˆ—è¾“å‡ºï¼Œæ˜¾ç¤ºèŠ‚ç‚¹çš„åç§°å’Œè¯¥èŠ‚ç‚¹çš„æ±¡ç‚¹
# k8s-master èŠ‚ç‚¹æœ‰æ±¡ç‚¹ï¼Œé˜»æ­¢æ™®é€š Pod è¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œé€šå¸¸æ˜¯ä¸ºäº†ç¡®ä¿æ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸ä¼šè¢«åº”ç”¨ç¨‹åº Pod å ç”¨ã€‚
# k8s-work1 å’Œ k8s-work2 èŠ‚ç‚¹æ²¡æœ‰æ±¡ç‚¹ï¼Œè¡¨ç¤ºå®ƒä»¬å¯ä»¥æ¥æ”¶ä»»ä½• Podï¼Œé™¤éæœ‰å…¶ä»–èµ„æºé™åˆ¶ã€‚
```

**å¢åŠ æ±¡ç‚¹**

```bash
#å‘½ä»¤æ ¼å¼
kubectl taint nodes <node-name> <key>=<value>:<effect>
#	<node-name>: èŠ‚ç‚¹çš„åç§°ã€‚
#	<key>: æ±¡ç‚¹çš„é”®ã€‚
#	<value>: æ±¡ç‚¹çš„å€¼ã€‚
#	<effect>: æ±¡ç‚¹çš„æ•ˆæœï¼Œå¯ä»¥æ˜¯ NoSchedule, PreferNoSchedule, æˆ– NoExecute


# é”®ä¸º forbidï¼Œå€¼ä¸º trueï¼Œå¹¶ä¸”æ•ˆæœä¸º NoScheduleã€‚è¿™æ„å‘³ç€é™¤é Pod å®¹å¿è¿™ä¸ªæ±¡ç‚¹ï¼Œå¦åˆ™å®ƒä¸ä¼šè¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹
kubectl taint nodes k8s-work1 forbid=true:NoSchedule
```

**åˆ é™¤æ±¡ç‚¹**

```bash
kubectl taint nodes k8s-work1 forbid-
```

### 5.6 æ›´æ–°å’Œå›æ»š DaemonSet

å¦‚æœæ·»åŠ äº†æ–°èŠ‚ç‚¹æˆ–ä¿®æ”¹äº†èŠ‚ç‚¹æ ‡ç­¾ï¼ˆLabelï¼‰ï¼ŒDaemonSet å°†ç«‹åˆ»å‘æ–°åŒ¹é…ä¸Šçš„èŠ‚ç‚¹æ·»åŠ Podï¼ŒåŒæ—¶åˆ é™¤ä¸èƒ½åŒ¹é…çš„èŠ‚ç‚¹ä¸Šçš„ Podã€‚
åœ¨ Kubernetes 1.6 ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œå¯ä»¥åœ¨ DaemonSet ä¸Šæ‰§è¡Œæ»šåŠ¨æ›´æ–°ï¼ŒDaemonSet æ›´æ–°ç­–ç•¥å’Œ StatefulSet ç±»ä¼¼ï¼Œä¹Ÿæœ‰ OnDelete å’Œ RollingUpdate ä¸¤ç§æ–¹å¼ã€‚
æŸ¥çœ‹ DaemonSet æ›´æ–°ç­–ç•¥æ–¹å¼ï¼š

```bash
[root@k8s-master yaml]# kubectl get ds ds-nginx -o go-template='{{.spec.updateStrategy.type}}{{"\n"}}'
RollingUpdate
```

å‘½ä»¤å¼æ›´æ–°ï¼Œå’Œä¹‹å‰ Deploymentã€StatefulSet æ–¹å¼ä¸€è‡´

```bash
kubectl edit ds/<daemonset-name>
kubectl patch ds/<daemonset-name> -p=<strategic-merge-patch>
kubectl set image ds/<daemonset-name><container-name>= <container-newimage> --record=true
```

æŸ¥çœ‹æ›´æ–°çŠ¶æ€

```bash
kubectl rollout status ds/<daemonset-name>
```

åˆ—å‡ºæ‰€æœ‰ä¿®è®¢ç‰ˆæœ¬

```bash
kubectl rollout history daemonset <daemonset-name>
```


å›æ»šåˆ°æŒ‡å®š revision

```bash
kubectl rollout undo daemonset <daemonset-name> --to-revision=<revision>
```


DaemonSet çš„æ›´æ–°å’Œå›æ»šä¸ Deployment ç±»ä¼¼



---

## 6) CronJob æ“ä½œæ–‡æ¡£

### 6.1 åˆ›å»º CronJob

CronJob ç”¨äºåœ¨ Kubernetes ä¸­æ‰§è¡Œå®šæœŸä»»åŠ¡ï¼Œå®ƒå…è®¸æ‚¨æŒ‰ç…§ä¸€å®šçš„æ—¶é—´è¡¨æ‰§è¡Œ Jobsã€‚æ¯ä¸ª CronJob å®šä¹‰äº†ä¸€ä¸ªæ—¶é—´è¡¨ï¼Œå¹¶ä¸”ä¼šå‘¨æœŸæ€§åœ°åˆ›å»º Job æ‰§è¡Œä»»åŠ¡ã€‚

#### ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ª CronJob

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª CronJob çš„ YAML æ–‡ä»¶ï¼Œå®šä¹‰æ‰§è¡Œå‘¨æœŸã€ä»»åŠ¡å†…å®¹ç­‰ä¿¡æ¯ã€‚

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: example-cronjob
spec:
  schedule: "*/5 * * * *"  # æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: busybox
              image: busybox
              command:
                - "/bin/sh"
                - "-c"
                - "echo Hello World; sleep 30"
          restartPolicy: OnFailure
```

#### åˆ›å»º CronJob

ä½¿ç”¨ `kubectl create` å‘½ä»¤æ¥åˆ›å»º CronJobï¼š

```bash
kubectl create -f cronjob-example.yaml
cronjob.batch/example-cronjob created
```

### 6.2 æŸ¥çœ‹ CronJob çŠ¶æ€

#### æŸ¥çœ‹ CronJob

å¯ä»¥ä½¿ç”¨ `kubectl get cronjob` æŸ¥çœ‹ CronJob çš„åŸºæœ¬ä¿¡æ¯ï¼š

```bash
kubectl get cronjob
NAME               SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
example-cronjob    */5 * * * * False     0        10s             1m
```

- **SCHEDULE**ï¼šCronJob çš„æ—¶é—´è°ƒåº¦è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä»»åŠ¡çš„æ‰§è¡Œé¢‘ç‡ã€‚
- **SUSPEND**ï¼šæ˜¯å¦æš‚åœ CronJobï¼Œ`False` è¡¨ç¤º CronJob æ­£åœ¨è¿è¡Œã€‚
- **ACTIVE**ï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„ Job æ•°é‡ã€‚
- **LAST SCHEDULE**ï¼šä¸Šæ¬¡æ‰§è¡Œçš„æ—¶é—´ã€‚
- **AGE**ï¼šCronJob åˆ›å»ºçš„æ—¶é—´ã€‚

#### æŸ¥çœ‹ CronJob çš„å†å² Jobs

CronJob ä¼šå®šæœŸåˆ›å»º Jobï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ä¸ CronJob ç›¸å…³çš„å†å² Jobï¼š

```bash
kubectl get jobs --selector=job-name=example-cronjob
```

#### æŸ¥çœ‹ç‰¹å®š Job è¯¦æƒ…

```bash
kubectl describe job <job-name>
```

### 6.3 æ›´æ–° CronJob

å¦‚æœæ‚¨éœ€è¦æ›´æ–° CronJob çš„é…ç½®ï¼ˆä¾‹å¦‚æ›´æ”¹æ‰§è¡Œé¢‘ç‡æˆ–ä¿®æ”¹å®¹å™¨çš„é•œåƒï¼‰ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹ CronJob çš„ YAML æ–‡ä»¶ï¼Œç„¶åé‡æ–°åº”ç”¨ï¼š

#### æ›´æ–° CronJob

```bash
kubectl apply -f cronjob-example.yaml
```

å¦‚æœåªä¿®æ”¹äº† CronJob çš„æ—¶é—´è°ƒåº¦æˆ–å…¶ä»–é…ç½®ï¼Œä¸éœ€è¦åˆ é™¤ CronJobï¼Œè€Œæ˜¯é€šè¿‡ `kubectl apply` æ›´æ–°å®ƒã€‚

### 6.4 æš‚åœå’Œæ¢å¤ CronJob

#### æš‚åœ CronJob

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æš‚åœ CronJobï¼Œä½¿å®ƒä¸å†åˆ›å»ºæ–°çš„ Jobï¼š

```bash
kubectl patch cronjob example-cronjob -p '{"spec":{"suspend":true}}'
```

#### æ¢å¤ CronJob

æ¢å¤ CronJob çš„æ‰§è¡Œï¼š

```bash
kubectl patch cronjob example-cronjob -p '{"spec":{"suspend":false}}'
```

### 6.5 åˆ é™¤ CronJob

#### åˆ é™¤ CronJob

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ é™¤ CronJobï¼Œè¿™ä¹Ÿä¼šåˆ é™¤ä¸è¯¥ CronJob ç›¸å…³çš„æ‰€æœ‰å†å² Jobï¼š

```bash
kubectl delete cronjob example-cronjob
```

### 6.6 é…ç½® CronJob

#### CronJob æ—¶é—´è¡¨

CronJob ä½¿ç”¨æ ‡å‡†çš„ cron è¡¨è¾¾å¼æ¥å®šä¹‰è°ƒåº¦è®¡åˆ’ã€‚ä»¥ä¸‹æ˜¯å¸¸è§çš„ cron è¡¨è¾¾å¼å’Œå«ä¹‰ï¼š

| Cron è¡¨è¾¾å¼   | å«ä¹‰                         |
| ------------- | ---------------------------- |
| `*/5 * * * *` | æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡            |
| `0 * * * *`   | æ¯å°æ—¶çš„ç¬¬ 0 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡    |
| `0 0 * * *`   | æ¯å¤©åˆå¤œ 12 ç‚¹æ‰§è¡Œä¸€æ¬¡       |
| `0 0 1 * *`   | æ¯ä¸ªæœˆçš„ç¬¬ä¸€å¤©åˆå¤œ 12 ç‚¹æ‰§è¡Œ |
| `0 0 * * 0`   | æ¯å‘¨æ—¥åˆå¤œ 12 ç‚¹æ‰§è¡Œä¸€æ¬¡     |

#### é…ç½® Job çš„é‡è¯•å’Œå¤±è´¥ç­–ç•¥

CronJob åˆ›å»ºçš„ Job å¯ä»¥é…ç½®å¤±è´¥é‡è¯•ç­–ç•¥ï¼š

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: retry-cronjob
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      backoffLimit: 4  # Job å¤±è´¥åçš„é‡è¯•æ¬¡æ•°ï¼Œæœ€å¤šé‡è¯• 4 æ¬¡
      template:
        spec:
          containers:
            - name: busybox
              image: busybox
              command:
                - "/bin/sh"
                - "-c"
                - "exit 1"  # å¼ºåˆ¶å¤±è´¥çš„å‘½ä»¤
          restartPolicy: OnFailure
```

- **backoffLimit**ï¼šå¦‚æœ Job å¤±è´¥ï¼Œå®ƒä¼šé‡æ–°å°è¯•ï¼Œæœ€å¤šé‡è¯•å¤šå°‘æ¬¡ï¼Œé»˜è®¤ä¸º 6 æ¬¡ã€‚
- **restartPolicy**ï¼šæŒ‡å®šå®¹å™¨å¤±è´¥åçš„é‡å¯ç­–ç•¥ï¼Œ`OnFailure` è¡¨ç¤ºä»…åœ¨å®¹å™¨å¤±è´¥æ—¶æ‰é‡å¯ã€‚

#### é…ç½® Job çš„èµ„æºé™åˆ¶

æ‚¨å¯ä»¥ä¸º CronJob å®šä¹‰èµ„æºè¯·æ±‚å’Œé™åˆ¶ï¼š

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: resource-cronjob
spec:
  schedule: "*/5 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: busybox
              image: busybox
              command:
                - "/bin/sh"
                - "-c"
                - "echo Hello World"
              resources:
                requests:
                  memory: "64Mi"
                  cpu: "250m"
                limits:
                  memory: "128Mi"
                  cpu: "500m"
          restartPolicy: OnFailure
```

- **resources.requests**ï¼šå®¹å™¨éœ€è¦çš„æœ€å°èµ„æºã€‚
- **resources.limits**ï¼šå®¹å™¨çš„æœ€å¤§èµ„æºé™åˆ¶ã€‚

### 6.7 CronJob çš„å¹¶å‘æ§åˆ¶

CronJob åœ¨è°ƒåº¦æ—¶å¯èƒ½ä¼šå‘ç”Ÿå¹¶å‘æ‰§è¡Œçš„æƒ…å†µã€‚å¦‚æœä¸€ä¸ª Job æ²¡æœ‰åœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦å‘¨æœŸä¹‹å‰å®Œæˆï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤šä¸ª Job åŒæ—¶è¿è¡Œã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ç­–ç•¥æ¥æ§åˆ¶å¹¶å‘æ‰§è¡Œè¡Œä¸ºï¼š

#### æ§åˆ¶å¹¶å‘ç­–ç•¥

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob-with-concurrency
spec:
  schedule: "*/5 * * * *"
  concurrencyPolicy: Forbid  # é¿å…å¤šä¸ª Job åŒæ—¶æ‰§è¡Œ
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: busybox
              image: busybox
              command:
                - "/bin/sh"
                - "-c"
                - "echo Hello World; sleep 30"
          restartPolicy: OnFailure
```

- **concurrencyPolicy**ï¼š
  - **Allow**ï¼ˆé»˜è®¤ï¼‰ï¼šå…è®¸ CronJob ä»»åŠ¡å¹¶å‘æ‰§è¡Œã€‚
  - **Forbid**ï¼šä¸å…è®¸ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡è¿˜æœªå®Œæˆï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡å°†è¢«è·³è¿‡ã€‚
  - **Replace**ï¼šå¦‚æœä¸Šä¸€ä¸ªä»»åŠ¡è¿˜æœªå®Œæˆï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡ä¼šæ›¿æ¢å®ƒã€‚

### 6.8 CronJob é…ç½®æ€»ç»“

- **è°ƒåº¦é¢‘ç‡**ï¼šé€šè¿‡ `schedule` å±æ€§å®šä¹‰ cron è¡¨è¾¾å¼ï¼ŒæŒ‡å®š CronJob çš„æ‰§è¡Œé¢‘ç‡ã€‚
- **é‡è¯•ç­–ç•¥**ï¼šé€šè¿‡ `backoffLimit` æ§åˆ¶ä»»åŠ¡å¤±è´¥åçš„é‡è¯•æ¬¡æ•°ã€‚
- **èµ„æºé™åˆ¶**ï¼šé€šè¿‡ `resources.requests` å’Œ `resources.limits` é…ç½®èµ„æºè¯·æ±‚å’Œé™åˆ¶ã€‚
- **å¹¶å‘æ§åˆ¶**ï¼šä½¿ç”¨ `concurrencyPolicy` æ§åˆ¶ä»»åŠ¡æ˜¯å¦å…è®¸å¹¶å‘æ‰§è¡Œã€‚

---

# æ£€æŸ¥èµ„æºè°ƒåº¦

### **æ£€æŸ¥é›†ç¾¤ä¸­èµ„æºçš„è°ƒåº¦è§„åˆ™æ˜¯å¦ä¸ºå•èŠ‚ç‚¹**

```bash
while read workLoad resourceName nameSpaces; do
    echo "å·¥ä½œè´Ÿè½½ç±»å‹ï¼š$workLoad èµ„æºåç§°ï¼š$resourceName å‘½åç©ºé—´ï¼š$nameSpaces"
    kubectl get $workLoad $resourceName -n "$nameSpaces" -o yaml |
    awk '/^\s*affinity:/, /containers:/ { if ($0 ~ /^\s*affinity:/ || $0 !~ /^\s*containers:/) print }'
done < list
```

### **æ£€æŸ¥æ˜¯å¦åœ¨k8sä¸­éƒ¨ç½²æ•°æ®åº“ï¼š**

```bash
while read workLoad resourceName nameSpaces; do
    echo "å·¥ä½œè´Ÿè½½ç±»å‹ï¼š$workLoad èµ„æºåç§°ï¼š$resourceName å‘½åç©ºé—´ï¼š$nameSpaces"
    kubectl get $workLoad $resourceName -n "$nameSpaces" -o yaml | grep image: | egrep -i "mysql|PostgreSQL|Oracle|SQLite|Redis|Memcached|MongoDB" && \
    (echo "å·¥ä½œè´Ÿè½½ç±»å‹ï¼š$workLoad èµ„æºåç§°ï¼š$resourceName å‘½åç©ºé—´ï¼š$nameSpaces" >> result && kubectl get $workLoad $resourceName -n "$nameSpaces" -o yaml | grep image: | egrep -i "mysql|PostgreSQL|Oracle|SQLite|Redis|Memcached|MongoDB" >> result) || echo "æ²¡æœ‰åŒ¹é…çš„é•œåƒ"
done < list
```



