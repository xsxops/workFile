# æ±¡ç‚¹å’Œå®¹å¿åº¦

**èŠ‚ç‚¹äº²å’Œæ€§** æ˜¯ Pod çš„ä¸€ç§å±æ€§ï¼Œå®ƒä½¿ Pod è¢«å¸å¼•åˆ°ä¸€ç±»ç‰¹å®šçš„èŠ‚ç‚¹ï¼ˆè¿™å¯èƒ½å‡ºäºä¸€ç§åå¥½ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¡¬æ€§è¦æ±‚ï¼‰ã€‚ **æ±¡ç‚¹ï¼ˆTaintï¼‰** åˆ™ç›¸åâ€”â€”å®ƒä½¿èŠ‚ç‚¹èƒ½å¤Ÿæ’æ–¥ä¸€ç±»ç‰¹å®šçš„ Podã€‚

**å®¹å¿åº¦ï¼ˆTolerationï¼‰** æ˜¯åº”ç”¨äº Pod ä¸Šçš„ã€‚å®¹å¿åº¦å…è®¸è°ƒåº¦å™¨è°ƒåº¦å¸¦æœ‰å¯¹åº”æ±¡ç‚¹çš„ Podã€‚ å®¹å¿åº¦å…è®¸è°ƒåº¦ä½†å¹¶ä¸ä¿è¯è°ƒåº¦ï¼šä½œä¸ºå…¶åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œ è°ƒåº¦å™¨ä¹Ÿä¼šè¯„ä¼°å…¶ä»–å‚æ•°ã€‚

æ±¡ç‚¹å’Œå®¹å¿åº¦ï¼ˆTolerationï¼‰ç›¸äº’é…åˆï¼Œå¯ä»¥ç”¨æ¥é¿å… Pod è¢«åˆ†é…åˆ°ä¸åˆé€‚çš„èŠ‚ç‚¹ä¸Šã€‚ æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å¯ä»¥åº”ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªæ±¡ç‚¹ï¼Œè¿™è¡¨ç¤ºå¯¹äºé‚£äº›ä¸èƒ½å®¹å¿è¿™äº›æ±¡ç‚¹çš„ Podï¼Œ æ˜¯ä¸ä¼šè¢«è¯¥èŠ‚ç‚¹æ¥å—çš„ã€‚

## æ¦‚å¿µ

ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤ `kubectl taint` ç»™èŠ‚ç‚¹å¢åŠ ä¸€ä¸ªæ±¡ç‚¹ã€‚æ¯”å¦‚ï¼š

```bash
kubectl taint nodes node1 key1=value1:NoSchedule
```

ç»™èŠ‚ç‚¹ `node1` å¢åŠ ä¸€ä¸ªæ±¡ç‚¹ï¼Œå®ƒçš„é”®åæ˜¯ `key1`ï¼Œé”®å€¼æ˜¯ `value1`ï¼Œæ•ˆæœæ˜¯ `NoSchedule`ã€‚ è¿™è¡¨ç¤ºåªæœ‰æ‹¥æœ‰å’Œè¿™ä¸ªæ±¡ç‚¹ç›¸åŒ¹é…çš„å®¹å¿åº¦çš„ Pod æ‰èƒ½å¤Ÿè¢«åˆ†é…åˆ° `node1` è¿™ä¸ªèŠ‚ç‚¹ã€‚

è‹¥è¦ç§»é™¤ä¸Šè¿°å‘½ä»¤æ‰€æ·»åŠ çš„æ±¡ç‚¹ï¼Œä½ å¯ä»¥æ‰§è¡Œï¼š

```shell
kubectl taint nodes node1 key1=value1:NoSchedule-
```

ä½ å¯ä»¥åœ¨ Pod è§„çº¦ä¸­ä¸º Pod è®¾ç½®å®¹å¿åº¦ã€‚ ä¸‹é¢ä¸¤ä¸ªå®¹å¿åº¦å‡ä¸ä¸Šé¢ä¾‹å­ä¸­ä½¿ç”¨ `kubectl taint` å‘½ä»¤åˆ›å»ºçš„æ±¡ç‚¹ç›¸åŒ¹é…ï¼Œ å› æ­¤å¦‚æœä¸€ä¸ª Pod æ‹¥æœ‰å…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå®¹å¿åº¦ï¼Œéƒ½èƒ½å¤Ÿè¢«è°ƒåº¦åˆ° `node1`ï¼š

```yaml
tolerations:
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoSchedule"
```

```yaml
  tolerations:
- key: "key1"
  operator: "Exists"
  effect: "NoSchedule"
```

é»˜è®¤çš„ Kubernetes è°ƒåº¦å™¨åœ¨é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ¥è¿è¡Œç‰¹å®šçš„ Pod æ—¶ä¼šè€ƒè™‘æ±¡ç‚¹å’Œå®¹å¿åº¦ã€‚ ç„¶è€Œï¼Œå¦‚æœä½ æ‰‹åŠ¨ä¸ºä¸€ä¸ª Pod æŒ‡å®šäº† `.spec.nodeName`ï¼Œé‚£ä¹ˆé€‰èŠ‚ç‚¹æ“ä½œä¼šç»•è¿‡è°ƒåº¦å™¨ï¼› è¿™ä¸ª Pod å°†ä¼šç»‘å®šåˆ°ä½ æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šï¼Œå³ä½¿ä½ é€‰æ‹©çš„èŠ‚ç‚¹ä¸Šæœ‰ `NoSchedule` çš„æ±¡ç‚¹ã€‚ å¦‚æœè¿™ç§æƒ…å†µå‘ç”Ÿï¼Œä¸”èŠ‚ç‚¹ä¸Šè¿˜è®¾ç½®äº† `NoExecute` çš„æ±¡ç‚¹ï¼Œkubelet ä¼šå°† Pod é©±é€å‡ºå»ï¼Œé™¤éæœ‰é€‚å½“çš„å®¹å¿åº¦è®¾ç½®ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå®šä¹‰äº†ä¸€äº›å®¹å¿åº¦çš„ Pod çš„ä¾‹å­ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
  - name: nginx
    image: nginx
    imagePullPolicy: IfNotPresent
  tolerations:
  - key: "example-key"
    operator: "Exists"
    effect: "NoSchedule"
```

`operator` çš„é»˜è®¤å€¼æ˜¯ `Equal`ã€‚

ä¸€ä¸ªå®¹å¿åº¦å’Œä¸€ä¸ªæ±¡ç‚¹ç›¸â€œåŒ¹é…â€æ˜¯æŒ‡å®ƒä»¬æœ‰ä¸€æ ·çš„é”®åå’Œæ•ˆæœï¼Œå¹¶ä¸”ï¼š

- å¦‚æœ `operator` æ˜¯ `Exists`ï¼ˆæ­¤æ—¶å®¹å¿åº¦ä¸èƒ½æŒ‡å®š `value`ï¼‰
- å¦‚æœ `operator` æ˜¯ `Equal`ï¼Œåˆ™å®ƒä»¬çš„å€¼åº”è¯¥ç›¸ç­‰ã€‚

> **[è¯´æ˜]**
>
> å­˜åœ¨ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼š
>
> å¦‚æœ `key` ä¸ºç©ºï¼Œé‚£ä¹ˆ `operator` å¿…é¡»æ˜¯ `Exists`ï¼ŒåŒ¹é…æ‰€æœ‰ key å’Œ valueã€‚ æ³¨æ„ï¼ŒåŒæ—¶ `effect` ä»ç„¶éœ€è¦åŒ¹é…ã€‚
>
> å¦‚æœ `effect` ä¸ºç©ºï¼Œåˆ™å¯ä»¥ä¸æ‰€æœ‰é”®å `key1` çš„æ•ˆæœç›¸åŒ¹é…ã€‚



ä¸Šè¿°ä¾‹å­ä¸­ `effect` ä½¿ç”¨çš„å€¼ä¸º `NoSchedule`ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¦å¤–ä¸€ä¸ªå€¼ `PreferNoSchedule`ã€‚

`effect` å­—æ®µçš„å…è®¸å€¼åŒ…æ‹¬ï¼š

- `NoExecute`

  è¿™ä¼šå½±å“å·²åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Podï¼Œå…·ä½“å½±å“å¦‚ä¸‹ï¼šå¦‚æœ Pod ä¸èƒ½å®¹å¿è¿™ç±»æ±¡ç‚¹ï¼Œä¼šé©¬ä¸Šè¢«é©±é€ã€‚å¦‚æœ Pod èƒ½å¤Ÿå®¹å¿è¿™ç±»æ±¡ç‚¹ï¼Œä½†æ˜¯åœ¨å®¹å¿åº¦å®šä¹‰ä¸­æ²¡æœ‰æŒ‡å®š `tolerationSeconds`ï¼Œ åˆ™ Pod è¿˜ä¼šä¸€ç›´åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œã€‚å¦‚æœ Pod èƒ½å¤Ÿå®¹å¿è¿™ç±»æ±¡ç‚¹ï¼Œè€Œä¸”æŒ‡å®šäº† `tolerationSeconds`ï¼Œ åˆ™ Pod è¿˜èƒ½åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸Šç»§ç»­è¿è¡Œè¿™ä¸ªæŒ‡å®šçš„æ—¶é—´é•¿åº¦ã€‚ è¿™æ®µæ—¶é—´è¿‡å»åï¼ŒèŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸæ§åˆ¶å™¨ä»èŠ‚ç‚¹é©±é™¤è¿™äº› Podã€‚

- `NoSchedule`

  é™¤éå…·æœ‰åŒ¹é…çš„å®¹å¿åº¦è§„çº¦ï¼Œå¦åˆ™æ–°çš„ Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°å¸¦æœ‰æ±¡ç‚¹çš„èŠ‚ç‚¹ä¸Šã€‚ å½“å‰æ­£åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod **ä¸ä¼š**è¢«é©±é€ã€‚

- `PreferNoSchedule`

  `PreferNoSchedule` æ˜¯â€œåå¥½â€æˆ–â€œè½¯æ€§â€çš„ `NoSchedule`ã€‚ æ§åˆ¶å¹³é¢å°†**å°è¯•**é¿å…å°†ä¸èƒ½å®¹å¿æ±¡ç‚¹çš„ Pod è°ƒåº¦åˆ°çš„èŠ‚ç‚¹ä¸Šï¼Œä½†ä¸èƒ½ä¿è¯å®Œå…¨é¿å…ã€‚

ä½ å¯ä»¥ç»™ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ å¤šä¸ªæ±¡ç‚¹ï¼Œä¹Ÿå¯ä»¥ç»™ä¸€ä¸ª Pod æ·»åŠ å¤šä¸ªå®¹å¿åº¦è®¾ç½®ã€‚ Kubernetes å¤„ç†å¤šä¸ªæ±¡ç‚¹å’Œå®¹å¿åº¦çš„è¿‡ç¨‹å°±åƒä¸€ä¸ªè¿‡æ»¤å™¨ï¼šä»ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰æ±¡ç‚¹å¼€å§‹éå†ï¼Œ è¿‡æ»¤æ‰é‚£äº› Pod ä¸­å­˜åœ¨ä¸ä¹‹ç›¸åŒ¹é…çš„å®¹å¿åº¦çš„æ±¡ç‚¹ã€‚ä½™ä¸‹æœªè¢«è¿‡æ»¤çš„æ±¡ç‚¹çš„ effect å€¼å†³å®šäº† Pod æ˜¯å¦ä¼šè¢«åˆ†é…åˆ°è¯¥èŠ‚ç‚¹ã€‚éœ€è¦æ³¨æ„ä»¥ä¸‹æƒ…å†µï¼š

- å¦‚æœæœªè¢«å¿½ç•¥çš„æ±¡ç‚¹ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ª effect å€¼ä¸º `NoSchedule` çš„æ±¡ç‚¹ï¼Œ åˆ™ Kubernetes ä¸ä¼šå°† Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚
- å¦‚æœæœªè¢«å¿½ç•¥çš„æ±¡ç‚¹ä¸­ä¸å­˜åœ¨ effect å€¼ä¸º `NoSchedule` çš„æ±¡ç‚¹ï¼Œ ä½†æ˜¯å­˜åœ¨è‡³å°‘ä¸€ä¸ª effect å€¼ä¸º `PreferNoSchedule` çš„æ±¡ç‚¹ï¼Œ åˆ™ Kubernetes ä¼š**å°è¯•**ä¸å°† Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ã€‚
- å¦‚æœæœªè¢«å¿½ç•¥çš„æ±¡ç‚¹ä¸­å­˜åœ¨è‡³å°‘ä¸€ä¸ª effect å€¼ä¸º `NoExecute` çš„æ±¡ç‚¹ï¼Œ åˆ™ Kubernetes ä¸ä¼šå°† Pod è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼ˆå¦‚æœ Pod è¿˜æœªåœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œï¼‰ï¼Œ å¹¶ä¸”ä¼šå°† Pod ä»è¯¥èŠ‚ç‚¹é©±é€ï¼ˆå¦‚æœ Pod å·²ç»åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œï¼‰ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾ä½ ç»™ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ äº†å¦‚ä¸‹æ±¡ç‚¹ï¼š

```shell
kubectl taint nodes node1 key1=value1:NoSchedule
kubectl taint nodes node1 key1=value1:NoExecute
kubectl taint nodes node1 key2=value2:NoSchedule
```

å‡å®šæŸä¸ª Pod æœ‰ä¸¤ä¸ªå®¹å¿åº¦ï¼š

```yaml
tolerations:
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoSchedule"
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoExecute"
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸Šè¿° Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°ä¸Šè¿°èŠ‚ç‚¹ï¼Œå› ä¸ºå…¶æ²¡æœ‰å®¹å¿åº¦å’Œç¬¬ä¸‰ä¸ªæ±¡ç‚¹ç›¸åŒ¹é…ã€‚ ä½†æ˜¯å¦‚æœåœ¨ç»™èŠ‚ç‚¹æ·»åŠ ä¸Šè¿°æ±¡ç‚¹ä¹‹å‰ï¼Œè¯¥ Pod å·²ç»åœ¨ä¸Šè¿°èŠ‚ç‚¹è¿è¡Œï¼Œ é‚£ä¹ˆå®ƒè¿˜å¯ä»¥ç»§ç»­è¿è¡Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºç¬¬ä¸‰ä¸ªæ±¡ç‚¹æ˜¯ä¸‰ä¸ªæ±¡ç‚¹ä¸­å”¯ä¸€ä¸èƒ½è¢«è¿™ä¸ª Pod å®¹å¿çš„ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœç»™ä¸€ä¸ªèŠ‚ç‚¹æ·»åŠ äº†ä¸€ä¸ª effect å€¼ä¸º `NoExecute` çš„æ±¡ç‚¹ï¼Œ åˆ™ä»»ä½•ä¸èƒ½å®¹å¿è¿™ä¸ªæ±¡ç‚¹çš„ Pod éƒ½ä¼šé©¬ä¸Šè¢«é©±é€ï¼Œä»»ä½•å¯ä»¥å®¹å¿è¿™ä¸ªæ±¡ç‚¹çš„ Pod éƒ½ä¸ä¼šè¢«é©±é€ã€‚ ä½†æ˜¯ï¼Œå¦‚æœ Pod å­˜åœ¨ä¸€ä¸ª effect å€¼ä¸º `NoExecute` çš„å®¹å¿åº¦æŒ‡å®šäº†å¯é€‰å±æ€§ `tolerationSeconds` çš„å€¼ï¼Œåˆ™è¡¨ç¤ºåœ¨ç»™èŠ‚ç‚¹æ·»åŠ äº†ä¸Šè¿°æ±¡ç‚¹ä¹‹åï¼Œ Pod è¿˜èƒ½ç»§ç»­åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œçš„æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ

```yaml
tolerations:
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoExecute"
  tolerationSeconds: 3600
```

è¿™è¡¨ç¤ºå¦‚æœè¿™ä¸ª Pod æ­£åœ¨è¿è¡Œï¼ŒåŒæ—¶ä¸€ä¸ªåŒ¹é…çš„æ±¡ç‚¹è¢«æ·»åŠ åˆ°å…¶æ‰€åœ¨çš„èŠ‚ç‚¹ï¼Œ é‚£ä¹ˆ Pod è¿˜å°†ç»§ç»­åœ¨èŠ‚ç‚¹ä¸Šè¿è¡Œ 3600 ç§’ï¼Œç„¶åè¢«é©±é€ã€‚ å¦‚æœåœ¨æ­¤ä¹‹å‰ä¸Šè¿°æ±¡ç‚¹è¢«åˆ é™¤äº†ï¼Œåˆ™ Pod ä¸ä¼šè¢«é©±é€ã€‚

## ä½¿ç”¨ä¾‹å­

é€šè¿‡æ±¡ç‚¹å’Œå®¹å¿åº¦ï¼Œå¯ä»¥çµæ´»åœ°è®© Pod **é¿å¼€**æŸäº›èŠ‚ç‚¹æˆ–è€…å°† Pod ä»æŸäº›èŠ‚ç‚¹é©±é€ã€‚ ä¸‹é¢æ˜¯å‡ ä¸ªä½¿ç”¨ä¾‹å­ï¼š

- **ä¸“ç”¨èŠ‚ç‚¹**ï¼šå¦‚æœæƒ³å°†æŸäº›èŠ‚ç‚¹ä¸“é—¨åˆ†é…ç»™ç‰¹å®šçš„ä¸€ç»„ç”¨æˆ·ä½¿ç”¨ï¼Œä½ å¯ä»¥ç»™è¿™äº›èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹ï¼ˆå³ï¼Œ `kubectl taint nodes nodename dedicated=groupName:NoSchedule`ï¼‰ï¼Œ ç„¶åç»™è¿™ç»„ç”¨æˆ·çš„ Pod æ·»åŠ ä¸€ä¸ªç›¸å¯¹åº”çš„å®¹å¿åº¦ ï¼ˆé€šè¿‡ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„**å‡†å…¥æ§åˆ¶å™¨**ï¼Œ å¾ˆå®¹æ˜“å°±èƒ½åšåˆ°ï¼‰ã€‚ æ‹¥æœ‰ä¸Šè¿°å®¹å¿åº¦çš„ Pod å°±èƒ½å¤Ÿè¢«è°ƒåº¦åˆ°ä¸Šè¿°ä¸“ç”¨èŠ‚ç‚¹ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿè¢«è°ƒåº¦åˆ°é›†ç¾¤ä¸­çš„å…¶å®ƒèŠ‚ç‚¹ã€‚ å¦‚æœä½ å¸Œæœ›è¿™äº› Pod åªèƒ½è¢«è°ƒåº¦åˆ°ä¸Šè¿°ä¸“ç”¨èŠ‚ç‚¹ï¼Œ é‚£ä¹ˆä½ è¿˜éœ€è¦ç»™è¿™äº›ä¸“ç”¨èŠ‚ç‚¹å¦å¤–æ·»åŠ ä¸€ä¸ªå’Œä¸Šè¿°æ±¡ç‚¹ç±»ä¼¼çš„ labelï¼ˆä¾‹å¦‚ï¼š`dedicated=groupName`ï¼‰ï¼Œ åŒæ—¶è¿˜è¦åœ¨ä¸Šè¿°å‡†å…¥æ§åˆ¶å™¨ä¸­ç»™ Pod å¢åŠ èŠ‚ç‚¹äº²å’Œæ€§è¦æ±‚ï¼Œè¦æ±‚ä¸Šè¿° Pod åªèƒ½è¢«è°ƒåº¦åˆ°æ·»åŠ äº† `dedicated=groupName` æ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚

- **é…å¤‡äº†ç‰¹æ®Šç¡¬ä»¶çš„èŠ‚ç‚¹**ï¼šåœ¨éƒ¨åˆ†èŠ‚ç‚¹é…å¤‡äº†ç‰¹æ®Šç¡¬ä»¶ï¼ˆæ¯”å¦‚ GPUï¼‰çš„é›†ç¾¤ä¸­ï¼Œ æˆ‘ä»¬å¸Œæœ›ä¸éœ€è¦è¿™ç±»ç¡¬ä»¶çš„ Pod ä¸è¦è¢«è°ƒåº¦åˆ°è¿™äº›ç‰¹æ®ŠèŠ‚ç‚¹ï¼Œä»¥ä¾¿ä¸ºåç»§éœ€è¦è¿™ç±»ç¡¬ä»¶çš„ Pod ä¿ç•™èµ„æºã€‚ è¦è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œå¯ä»¥å…ˆç»™é…å¤‡äº†ç‰¹æ®Šç¡¬ä»¶çš„èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹ ï¼ˆä¾‹å¦‚ `kubectl taint nodes nodename special=true:NoSchedule` æˆ– `kubectl taint nodes nodename special=true:PreferNoSchedule`ï¼‰ï¼Œ ç„¶åç»™ä½¿ç”¨äº†è¿™ç±»ç‰¹æ®Šç¡¬ä»¶çš„ Pod æ·»åŠ ä¸€ä¸ªç›¸åŒ¹é…çš„å®¹å¿åº¦ã€‚ å’Œä¸“ç”¨èŠ‚ç‚¹çš„ä¾‹å­ç±»ä¼¼ï¼Œæ·»åŠ è¿™ä¸ªå®¹å¿åº¦çš„æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨è‡ªå®šä¹‰ **å‡†å…¥æ§åˆ¶å™¨**ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ **æ‰©å±•èµ„æº** æ¥è¡¨ç¤ºç‰¹æ®Šç¡¬ä»¶ï¼Œç»™é…ç½®äº†ç‰¹æ®Šç¡¬ä»¶çš„èŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹æ—¶åŒ…å«æ‰©å±•èµ„æºåç§°ï¼Œ ç„¶åè¿è¡Œä¸€ä¸ª ExtendedResourceToleration å‡†å…¥æ§åˆ¶å™¨ã€‚æ­¤æ—¶ï¼Œå› ä¸ºèŠ‚ç‚¹å·²ç»è¢«è®¾ç½®æ±¡ç‚¹äº†ï¼Œæ²¡æœ‰å¯¹åº”å®¹å¿åº¦çš„ Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°è¿™äº›èŠ‚ç‚¹ã€‚ ä½†å½“ä½ åˆ›å»ºä¸€ä¸ªä½¿ç”¨äº†æ‰©å±•èµ„æºçš„ Pod æ—¶ï¼Œ`ExtendedResourceToleration` å‡†å…¥æ§åˆ¶å™¨ä¼šè‡ªåŠ¨ç»™ Pod åŠ ä¸Šæ­£ç¡®çš„å®¹å¿åº¦ï¼Œè¿™æ · Pod å°±ä¼šè¢«è‡ªåŠ¨è°ƒåº¦åˆ°è¿™äº›é…ç½®äº†ç‰¹æ®Šç¡¬ä»¶çš„èŠ‚ç‚¹ä¸Šã€‚ è¿™ç§æ–¹å¼èƒ½å¤Ÿç¡®ä¿é…ç½®äº†ç‰¹æ®Šç¡¬ä»¶çš„èŠ‚ç‚¹ä¸“é—¨ç”¨äºè¿è¡Œéœ€è¦è¿™äº›ç¡¬ä»¶çš„ Podï¼Œ å¹¶ä¸”ä½ æ— éœ€æ‰‹åŠ¨ç»™è¿™äº› Pod æ·»åŠ å®¹å¿åº¦ã€‚

- **åŸºäºæ±¡ç‚¹çš„é©±é€**ï¼šè¿™æ˜¯åœ¨æ¯ä¸ª Pod ä¸­é…ç½®çš„åœ¨èŠ‚ç‚¹å‡ºç°é—®é¢˜æ—¶çš„é©±é€è¡Œä¸ºï¼Œ æ¥ä¸‹æ¥çš„ç« èŠ‚ä¼šæè¿°è¿™ä¸ªç‰¹æ€§ã€‚

## åŸºäºæ±¡ç‚¹çš„é©±é€

**ç‰¹æ€§çŠ¶æ€ï¼š** `Kubernetes v1.18 [stable]`

å½“æŸç§æ¡ä»¶ä¸ºçœŸæ—¶ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨ä¼šè‡ªåŠ¨ç»™èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹ã€‚å½“å‰å†…ç½®çš„æ±¡ç‚¹åŒ…æ‹¬ï¼š

- `node.kubernetes.io/not-ready`ï¼šèŠ‚ç‚¹æœªå‡†å¤‡å¥½ã€‚è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶å†µ `Ready` çš„å€¼ä¸º "`False`"ã€‚
- `node.kubernetes.io/unreachable`ï¼šèŠ‚ç‚¹æ§åˆ¶å™¨è®¿é—®ä¸åˆ°èŠ‚ç‚¹. è¿™ç›¸å½“äºèŠ‚ç‚¹çŠ¶å†µ `Ready` çš„å€¼ä¸º "`Unknown`"ã€‚
- `node.kubernetes.io/memory-pressure`ï¼šèŠ‚ç‚¹å­˜åœ¨å†…å­˜å‹åŠ›ã€‚
- `node.kubernetes.io/disk-pressure`ï¼šèŠ‚ç‚¹å­˜åœ¨ç£ç›˜å‹åŠ›ã€‚
- `node.kubernetes.io/pid-pressure`ï¼šèŠ‚ç‚¹çš„ PID å‹åŠ›ã€‚
- `node.kubernetes.io/network-unavailable`ï¼šèŠ‚ç‚¹ç½‘ç»œä¸å¯ç”¨ã€‚
- `node.kubernetes.io/unschedulable`ï¼šèŠ‚ç‚¹ä¸å¯è°ƒåº¦ã€‚
- `node.cloudprovider.kubernetes.io/uninitialized`ï¼šå¦‚æœ kubelet å¯åŠ¨æ—¶æŒ‡å®šäº†ä¸€ä¸ªâ€œå¤–éƒ¨â€äº‘å¹³å°é©±åŠ¨ï¼Œ å®ƒå°†ç»™å½“å‰èŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªæ±¡ç‚¹å°†å…¶æ ‡å¿—ä¸ºä¸å¯ç”¨ã€‚åœ¨ cloud-controller-manager çš„ä¸€ä¸ªæ§åˆ¶å™¨åˆå§‹åŒ–è¿™ä¸ªèŠ‚ç‚¹åï¼Œkubelet å°†åˆ é™¤è¿™ä¸ªæ±¡ç‚¹ã€‚

åœ¨èŠ‚ç‚¹è¢«æ’ç©ºæ—¶ï¼ŒèŠ‚ç‚¹æ§åˆ¶å™¨æˆ–è€… kubelet ä¼šæ·»åŠ å¸¦æœ‰ `NoExecute` æ•ˆæœçš„ç›¸å…³æ±¡ç‚¹ã€‚ æ­¤æ•ˆæœè¢«é»˜è®¤æ·»åŠ åˆ° `node.kubernetes.io/not-ready` å’Œ `node.kubernetes.io/unreachable` æ±¡ç‚¹ä¸­ã€‚ å¦‚æœå¼‚å¸¸çŠ¶æ€æ¢å¤æ­£å¸¸ï¼Œkubelet æˆ–èŠ‚ç‚¹æ§åˆ¶å™¨èƒ½å¤Ÿç§»é™¤ç›¸å…³çš„æ±¡ç‚¹ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå½“èŠ‚ç‚¹ä¸å¯è¾¾æ—¶ï¼ŒAPI æœåŠ¡å™¨æ— æ³•ä¸èŠ‚ç‚¹ä¸Šçš„ kubelet è¿›è¡Œé€šä¿¡ã€‚ åœ¨ä¸ API æœåŠ¡å™¨çš„é€šä¿¡è¢«é‡æ–°å»ºç«‹ä¹‹å‰ï¼Œåˆ é™¤ Pod çš„å†³å®šæ— æ³•ä¼ é€’åˆ° kubeletã€‚ åŒæ—¶ï¼Œè¢«è°ƒåº¦è¿›è¡Œåˆ é™¤çš„é‚£äº› Pod å¯èƒ½ä¼šç»§ç»­è¿è¡Œåœ¨åˆ†åŒºåçš„èŠ‚ç‚¹ä¸Šã€‚

> [!TIP]
>
> [ğŸš€ğŸ¼è¯´æ˜ï¼š]
>
> æ§åˆ¶é¢ä¼šé™åˆ¶å‘èŠ‚ç‚¹æ·»åŠ æ–°æ±¡ç‚¹çš„é€Ÿç‡ã€‚è¿™ä¸€é€Ÿç‡é™åˆ¶å¯ä»¥ç®¡ç†å¤šä¸ªèŠ‚ç‚¹åŒæ—¶ä¸å¯è¾¾æ—¶ ï¼ˆä¾‹å¦‚å‡ºç°ç½‘ç»œä¸­æ–­çš„æƒ…å†µï¼‰ï¼Œå¯èƒ½è§¦å‘çš„é©±é€çš„æ•°é‡ã€‚

ä½ å¯ä»¥ä¸º Pod è®¾ç½® `tolerationSeconds`ï¼Œä»¥æŒ‡å®šå½“èŠ‚ç‚¹å¤±æ•ˆæˆ–è€…ä¸å“åº”æ—¶ï¼Œ Pod ç»´ç³»ä¸è¯¥èŠ‚ç‚¹é—´ç»‘å®šå…³ç³»çš„æ—¶é•¿ã€‚

æ¯”å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›åœ¨å‡ºç°ç½‘ç»œåˆ†è£‚äº‹ä»¶æ—¶ï¼Œå¯¹äºä¸€ä¸ªä¸èŠ‚ç‚¹æœ¬åœ°çŠ¶æ€æœ‰ç€æ·±åº¦ç»‘å®šçš„åº”ç”¨è€Œè¨€ï¼Œ ä»ç„¶åœç•™åœ¨å½“å‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€æ®µè¾ƒé•¿çš„æ—¶é—´ï¼Œä»¥ç­‰å¾…ç½‘ç»œæ¢å¤ä»¥é¿å…è¢«é©±é€ã€‚ ä½ ä¸ºè¿™ç§ Pod æ‰€è®¾ç½®çš„å®¹å¿åº¦çœ‹èµ·æ¥å¯èƒ½æ˜¯è¿™æ ·ï¼š

```yaml
tolerations:
- key: "node.kubernetes.io/unreachable"
  operator: "Exists"
  effect: "NoExecute"
  tolerationSeconds: 6000
```

> [!TIP]
>
> [ğŸš€ğŸ¼è¯´æ˜ï¼š]
>
> Kubernetes ä¼šè‡ªåŠ¨ç»™ Pod æ·»åŠ é’ˆå¯¹ `node.kubernetes.io/not-ready` å’Œ `node.kubernetes.io/unreachable` çš„å®¹å¿åº¦ï¼Œä¸”é…ç½® `tolerationSeconds=300`ï¼Œ é™¤éç”¨æˆ·è‡ªèº«æˆ–è€…æŸæ§åˆ¶å™¨æ˜¾å¼è®¾ç½®æ­¤å®¹å¿åº¦ã€‚
>
> è¿™äº›è‡ªåŠ¨æ·»åŠ çš„å®¹å¿åº¦æ„å‘³ç€ Pod å¯ä»¥åœ¨æ£€æµ‹åˆ°å¯¹åº”çš„é—®é¢˜ä¹‹ä¸€æ—¶ï¼Œåœ¨ 5 åˆ†é’Ÿå†…ä¿æŒç»‘å®šåœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚	

DaemonSet ä¸­çš„ Pod è¢«åˆ›å»ºæ—¶ï¼Œ é’ˆå¯¹ä»¥ä¸‹æ±¡ç‚¹è‡ªåŠ¨æ·»åŠ çš„ `NoExecute` çš„å®¹å¿åº¦å°†ä¸ä¼šæŒ‡å®š `tolerationSeconds`ï¼š

- `node.kubernetes.io/unreachable`
- `node.kubernetes.io/not-ready`

è¿™ä¿è¯äº†å‡ºç°ä¸Šè¿°é—®é¢˜æ—¶ DaemonSet ä¸­çš„ Pod æ°¸è¿œä¸ä¼šè¢«é©±é€ã€‚

## åŸºäºèŠ‚ç‚¹çŠ¶æ€æ·»åŠ æ±¡ç‚¹

æ§åˆ¶å¹³é¢ä½¿ç”¨èŠ‚ç‚¹æ§åˆ¶å™¨è‡ªåŠ¨åˆ›å»º ä¸èŠ‚ç‚¹çŠ¶å†µ å¯¹åº”çš„ã€æ•ˆæœä¸º `NoSchedule` çš„æ±¡ç‚¹ã€‚

è°ƒåº¦å™¨åœ¨è¿›è¡Œè°ƒåº¦æ—¶æ£€æŸ¥æ±¡ç‚¹ï¼Œè€Œä¸æ˜¯æ£€æŸ¥èŠ‚ç‚¹çŠ¶å†µã€‚è¿™ç¡®ä¿èŠ‚ç‚¹çŠ¶å†µä¸ä¼šç›´æ¥å½±å“è°ƒåº¦ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœ `DiskPressure` èŠ‚ç‚¹çŠ¶å†µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œåˆ™æ§åˆ¶å¹³é¢æ·»åŠ  `node.kubernetes.io/disk-pressure` æ±¡ç‚¹å¹¶ä¸”ä¸ä¼šè°ƒåº¦æ–°çš„ Pod åˆ°å—å½±å“çš„èŠ‚ç‚¹ã€‚ å¦‚æœ `MemoryPressure` èŠ‚ç‚¹çŠ¶å†µå¤„äºæ´»è·ƒçŠ¶æ€ï¼Œåˆ™æ§åˆ¶å¹³é¢æ·»åŠ  `node.kubernetes.io/memory-pressure` æ±¡ç‚¹ã€‚

å¯¹äºæ–°åˆ›å»ºçš„ Podï¼Œå¯ä»¥é€šè¿‡æ·»åŠ ç›¸åº”çš„ Pod å®¹å¿åº¦æ¥å¿½ç•¥èŠ‚ç‚¹çŠ¶å†µã€‚ æ§åˆ¶å¹³é¢è¿˜åœ¨å…·æœ‰é™¤ `BestEffort` ä¹‹å¤–çš„ QoS ç±»çš„ Pod ä¸Šæ·»åŠ  `node.kubernetes.io/memory-pressure` å®¹å¿åº¦ã€‚ è¿™æ˜¯å› ä¸º Kubernetes å°† `Guaranteed` æˆ– `Burstable` QoS ç±»ä¸­çš„ Podï¼ˆç”šè‡³æ²¡æœ‰è®¾ç½®å†…å­˜è¯·æ±‚çš„ Podï¼‰ è§†ä¸ºèƒ½å¤Ÿåº”å¯¹å†…å­˜å‹åŠ›ï¼Œè€Œæ–°åˆ›å»ºçš„ `BestEffort` Pod ä¸ä¼šè¢«è°ƒåº¦åˆ°å—å½±å“çš„èŠ‚ç‚¹ä¸Šã€‚

DaemonSet æ§åˆ¶å™¨è‡ªåŠ¨ä¸ºæ‰€æœ‰å®ˆæŠ¤è¿›ç¨‹æ·»åŠ å¦‚ä¸‹ `NoSchedule` å®¹å¿åº¦ï¼Œä»¥é˜² DaemonSet å´©æºƒï¼š

- `node.kubernetes.io/memory-pressure`
- `node.kubernetes.io/disk-pressure`
- `node.kubernetes.io/pid-pressure`ï¼ˆ1.14 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
- `node.kubernetes.io/unschedulable`ï¼ˆ1.10 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰
- `node.kubernetes.io/network-unavailable`ï¼ˆ**åªé€‚åˆä¸»æœºç½‘ç»œé…ç½®**ï¼‰

æ·»åŠ ä¸Šè¿°å®¹å¿åº¦ç¡®ä¿äº†å‘åå…¼å®¹ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©è‡ªç”±å‘ DaemonSet æ·»åŠ å®¹å¿åº¦ã€‚