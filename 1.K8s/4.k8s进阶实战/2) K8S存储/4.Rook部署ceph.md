# Rook 

## ğŸ“–å‰è¨€

â€‹	 Rookæ˜¯ä¸€ä¸ªè‡ªæˆ‘ç®¡ç†çš„åˆ†å¸ƒå¼å­˜å‚¨ç¼–æ’ç³»ç»Ÿï¼Œå®ƒæœ¬èº«å¹¶ä¸æ˜¯å­˜å‚¨ç³»ç»Ÿï¼Œåœ¨å­˜å‚¨å’Œ k8sä¹‹å‰æ­å»ºäº†ä¸€ä¸ªæ¡¥æ¢ï¼Œä½¿å­˜å‚¨ç³»ç»Ÿçš„æ­å»ºæˆ–è€…ç»´æŠ¤å˜å¾—ç‰¹åˆ«ç®€å•ï¼ŒRookå°†åˆ†å¸ƒå¼å­˜å‚¨ç³» ç»Ÿè½¬å˜ä¸ºè‡ªæˆ‘ç®¡ç†ã€è‡ªæˆ‘æ‰©å±•ã€è‡ªæˆ‘ä¿®å¤çš„å­˜å‚¨æœåŠ¡ã€‚å®ƒè®©ä¸€äº›å­˜å‚¨çš„æ“ä½œï¼Œæ¯”å¦‚éƒ¨ç½²ã€ é…ç½®ã€æ‰©å®¹ã€å‡çº§ã€è¿ç§»ã€ç¾éš¾æ¢å¤ã€ç›‘è§†å’Œèµ„æºç®¡ç†å˜å¾—è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥å¤„ç†ã€‚å¹¶ä¸” Rookæ”¯æŒCSIï¼Œå¯ä»¥åˆ©ç”¨CSIåšä¸€äº›PVCçš„å¿«ç…§ã€æ‰©å®¹ã€å…‹éš†ç­‰æ“ä½œã€‚

**`æˆ‘ä»¬ä¸ç”Ÿäº§æ°´ï¼Œæˆ‘ä»¬åªæ˜¯å¤§è‡ªç„¶çš„æ¬è¿å·¥`**

------

[TOC]

## Rook æ¶æ„

![image-20250313142820576](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250313142820576.png)

### ç»„ä»¶ä»‹ç»ï¼š

**æ ¸å¿ƒPodåŠŸèƒ½è¯´æ˜**

- **`rook-discover`**ï¼šRookè®¾å¤‡å‘ç°å®ˆæŠ¤è¿›ç¨‹ï¼Œ**è‡ªåŠ¨æ‰«æèŠ‚ç‚¹ä¸Šçš„å­˜å‚¨è®¾å¤‡**ï¼ˆå¦‚ç£ç›˜ã€SSDï¼‰ï¼Œå¹¶å°†ä¿¡æ¯ä¸ŠæŠ¥ç»™Operatorã€‚
- **`rook-ceph-mon`**ï¼šCeph MonitoræœåŠ¡ï¼Œ**ç»´æŠ¤é›†ç¾¤å…ƒæ•°æ®**ï¼ˆå¦‚OSDæ˜ å°„ã€PGçŠ¶æ€ï¼‰ï¼Œ**ç¡®ä¿é›†ç¾¤ä¸€è‡´æ€§**ã€‚
- **`rook-ceph-mgr`**ï¼šCeph ManageræœåŠ¡ï¼Œ**æä¾›ç®¡ç†æ¥å£å’Œç›‘æ§æŒ‡æ ‡**ï¼ˆDashboardã€PrometheusæŒ‡æ ‡ï¼‰ã€‚
- **`rook-ceph-osd`**ï¼šCeph OSDæœåŠ¡ï¼Œ**å®é™…å­˜å‚¨æ•°æ®çš„å®ˆæŠ¤è¿›ç¨‹**ï¼Œæ¯ä¸ªOSDå¯¹åº”ä¸€ä¸ªç‰©ç†è®¾å¤‡ã€‚
- **`rook-ceph-crashcollector`**ï¼šå´©æºƒæ—¥å¿—æ”¶é›†å™¨ï¼Œ**è‡ªåŠ¨æ”¶é›†OSD/Monæ•…éšœæ—¶çš„è¯Šæ–­ä¿¡æ¯**ã€‚
- **`rook-ceph-exporter`**ï¼šæŒ‡æ ‡å¯¼å‡ºå™¨ï¼Œ**å°†Cephé›†ç¾¤æ€§èƒ½æ•°æ®å¯¼å‡ºç»™Prometheus**ã€‚

**CSIç›¸å…³ç»„ä»¶è¯´æ˜**

- **`csi-rbdplugin`**ï¼šRBDå—å­˜å‚¨æ’ä»¶ï¼Œ**æ”¯æŒåŠ¨æ€åˆ›å»º/æŒ‚è½½Ceph RBDå·**ï¼ˆé€‚ç”¨äºæ•°æ®åº“ç­‰åœºæ™¯ï¼‰ã€‚
- **`csi-cephfsplugin`**ï¼šCephFSæ–‡ä»¶å­˜å‚¨æ’ä»¶ï¼Œ**æ”¯æŒåŠ¨æ€åˆ›å»º/æŒ‚è½½CephFSå·**ï¼ˆé€‚ç”¨äºå…±äº«æ–‡ä»¶å­˜å‚¨ï¼‰ã€‚
- **`csi-*-provisioner`**ï¼šå­˜å‚¨ä¾›åº”æ§åˆ¶å™¨ï¼Œ**å¤„ç†å­˜å‚¨å·çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼ˆåˆ›å»º/æ‰©å®¹/åˆ é™¤ï¼‰ã€‚

**è¿ç»´å·¥å…·ç±»è¯´æ˜**

- **`rook-ceph-operator`**ï¼šé›†ç¾¤ç®¡ç†æ ¸å¿ƒï¼Œ**åè°ƒæ‰€æœ‰èµ„æºéƒ¨ç½²å’Œé…ç½®æ›´æ–°**ã€‚
- **`rook-ceph-tools`**ï¼šå·¥å…·Podï¼ˆéœ€æ‰‹åŠ¨åˆ›å»ºï¼‰ï¼Œ**æä¾›`ceph`å‘½ä»¤è¡Œå·¥å…·**ï¼Œç”¨äºé›†ç¾¤è°ƒè¯•ã€‚

```mermaid
graph TD
    A[Operator] --> B[éƒ¨ç½²Mon]
    A --> C[éƒ¨ç½²Mgr]
    A --> D[è§¦å‘Discover]
    D --> E[æ‰«æè®¾å¤‡]
    E --> F[å‘ç°å¯ç”¨è®¾å¤‡]
    F --> G[è§¦å‘OSD Prepare]
    G --> H[åˆå§‹åŒ–è®¾å¤‡]
    H --> I[åˆ›å»ºOSDå®ä¾‹]
    A --> J[éƒ¨ç½²CSIæ’ä»¶]
    J --> K[ä¸ºK8Sæä¾›å­˜å‚¨æœåŠ¡]
```

### åŸºç¡€ç¯å¢ƒ

| name         | IP            | ç£ç›˜             | ceph             |
| ------------ | ------------- | ---------------- | ---------------- |
| k8s-master01 | 192.168.0.105 | nvme0n1          |                  |
| k8s-master02 | 192.168.0.106 | nvme0n1          |                  |
| k8s-master03 | 192.168.0.107 | nvme0n1ã€nvme0n2 | cephå®‰è£…æ‰€åœ¨èŠ‚ç‚¹ |
| k8s-work01   | 192.168.0.115 | nvme0n1ã€nvme0n2 | cephå®‰è£…æ‰€åœ¨èŠ‚ç‚¹ |
| k8s-work02   | 192.168.0.116 | nvme0n1ã€nvme0n2 | cephå®‰è£…æ‰€åœ¨èŠ‚ç‚¹ |

## Rook éƒ¨ç½²

é›†ç¾¤è¿è¡Œåï¼Œåº”ç”¨ç¨‹åºå¯ä»¥**ä½¿ç”¨å—ã€å¯¹è±¡æˆ–æ–‡ä»¶å­˜å‚¨**ã€‚

#### 1ï¼‰å…‹éš† Rook ä»“åº“

```bash
git clone --single-branch --branch v1.16.5 https://github.com/rook/rook.git
```

#### 2ï¼‰ä¸‹è½½é•œåƒ

æŒ‰ç…§åˆ©ç”¨é˜¿é‡Œäº‘ä¸‹è½½å›½å¤–é•œåƒæ–‡æ¡£è¿›è¡Œä¸‹è½½

```bash
ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:3.13.0
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:3.13.0 quay.io/cephcsi/cephcsi:v3.13.0


ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:2.13.0
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:2.13.0 registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.13.0


ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:1.13.1
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:1.13.1 registry.k8s.io/sig-storage/csi-resizer:v1.13.1


ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:5.1.0
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:5.1.0 registry.k8s.io/sig-storage/csi-provisioner:v5.1.0


ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:8.2.0
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:8.2.0 registry.k8s.io/sig-storage/csi-snapshotter:v8.2.0


ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:4.8.0
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:4.8.0 registry.k8s.io/sig-storage/csi-attacher:v4.8.0


ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:1.16.5
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:1.16.5 docker.io/rook/ceph:v1.16.5

ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:2.13.0
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:2.13.0 registry.k8s.io/sig-storage/csi-node-driver-registrar:v2.13.0
```

#### 3ï¼‰ä¿®æ”¹é…ç½®æ–‡ä»¶

ä¿®æ”¹ Rook CSI é•œåƒåœ°å€ï¼ŒåŸæœ¬çš„åœ°å€å¯èƒ½æ˜¯ k8s.io çš„é•œåƒï¼Œä½†æ˜¯ æ— æ³•è¢«å›½å†…è®¿é—®ï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥gcrçš„é•œåƒåˆ°é˜¿é‡Œäº‘é•œåƒä»“åº“

operator æ–‡ ä»¶ ï¼Œ æ–° ç‰ˆ æœ¬ rook é»˜ è®¤ å…³ é—­ äº† è‡ª åŠ¨ å‘ ç° å®¹ å™¨ çš„ éƒ¨ ç½² ï¼Œ å¯ ä»¥ æ‰¾ åˆ°ROOK_ENABLE_DISCOVERY_DAEMON æ”¹æˆ true 

```bash
sed -i -E 's/(ROOK_ENABLE_DISCOVERY_DAEMON:\s*)"false"/\1"true"/g' operator.yaml
#	-Eï¼šå¯ç”¨æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ”¯æŒ \s* åŒ¹é…ä»»æ„æ•°é‡ç©ºæ ¼ï¼‰ 
#	\s*ï¼šåŒ¹é…é”®å€¼ä¹‹é—´çš„ä»»æ„æ•°é‡ç©ºæ ¼ã€‚
#	\1ï¼šä¿ç•™åŸé”®åå’Œå†’å·åçš„æ ¼å¼ï¼Œä»…æ›¿æ¢å€¼éƒ¨åˆ† 

cd rook/deploy/examples
kubectl create namespace rook-ceph
kubectl create -f crds.yaml -f common.yaml -f operator.yaml

[root@K8S-Master01 examples]# kubectl -n rook-ceph get pod
NAME                                  READY   STATUS    RESTARTS   AGE
rook-ceph-operator-67944bdfcc-b7r79   1/1     Running   0          35s
rook-discover-l4cw8                   1/1     Running   0          33s
rook-discover-qf5z8                   1/1     Running   0          33s
[root@K8S-Master01 examples]# kubectl get crd  |grep rook
cephblockpoolradosnamespaces.ceph.rook.io             2025-03-17T09:03:29Z
cephblockpools.ceph.rook.io                           2025-03-17T09:03:29Z
cephbucketnotifications.ceph.rook.io                  2025-03-17T09:03:29Z
cephbuckettopics.ceph.rook.io                         2025-03-17T09:03:29Z
cephclients.ceph.rook.io                              2025-03-17T09:03:29Z
cephclusters.ceph.rook.io                             2025-03-17T09:03:29Z
cephcosidrivers.ceph.rook.io                          2025-03-17T09:03:29Z
cephfilesystemmirrors.ceph.rook.io                    2025-03-17T09:03:29Z
cephfilesystems.ceph.rook.io                          2025-03-17T09:03:29Z
cephfilesystemsubvolumegroups.ceph.rook.io            2025-03-17T09:03:29Z
cephnfses.ceph.rook.io                                2025-03-17T09:03:30Z
cephobjectrealms.ceph.rook.io                         2025-03-17T09:03:30Z
cephobjectstores.ceph.rook.io                         2025-03-17T09:03:30Z
cephobjectstoreusers.ceph.rook.io                     2025-03-17T09:03:30Z
cephobjectzonegroups.ceph.rook.io                     2025-03-17T09:03:30Z
cephobjectzones.ceph.rook.io                          2025-03-17T09:03:30Z
cephrbdmirrors.ceph.rook.io                           2025-03-17T09:03:30Z
```



## ceph éƒ¨ç½²é›†ç¾¤

æ³¨æ„ï¼šæ–°ç‰ˆå¿…é¡»é‡‡ç”¨è£¸ç›˜ï¼Œå³æœªæ ¼å¼åŒ–çš„ç£ç›˜ã€‚å…¶ä¸­ k8s-master03 k8s-node01 node02 æœ‰æ–°åŠ 
çš„ä¸€ä¸ªç£ç›˜ï¼Œå¯ä»¥é€šè¿‡ `lsblk -f `æŸ¥çœ‹æ–°æ·»åŠ çš„ç£ç›˜åç§°ã€‚**å»ºè®®æœ€å°‘ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œå¦åˆ™åé¢çš„è¯•éªŒå¯**
**èƒ½ä¼šå‡ºç°é—®é¢˜**

```bash
[root@K8S-Master03 ~]# lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sr0          11:0    1 1024M  0 rom  
nvme0n1     259:0    0  100G  0 disk 
â”œâ”€nvme0n1p1 259:1    0    1G  0 part /boot
â””â”€nvme0n1p2 259:2    0   99G  0 part 
  â””â”€rl-root 253:0    0   99G  0 lvm  /
nvme0n2     259:3    0   10G  0 disk 					#æ–°åŠ ç£ç›˜ï¼Œç”¨ä½œceph OSD
```

#### 1ï¼‰åˆ›å»ºCephé›†ç¾¤

![image-20250317214421998](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250317214421998.png)

![image-20250317231435218](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250317231435218.png)

![image-20250317231647359](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250317231647359.png)

```bash
# ä¿®æ”¹ä¸Šè¿°é…ç½®
vim rook/deploy/examples/cluster.yaml

# æŒ‰ç…§ä½¿ç”¨é˜¿é‡Œäº‘ä¸‹è½½å¤–ç½‘é•œåƒæ–¹æ³•ä¸‹è½½ï¼šquay.io/ceph/ceph:v19.2.1
ctr images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:19.2.1
ctr images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:19.2.1 quay.io/ceph/ceph:v19.2.1

kubectl create  -f cluster.yaml
kubectl -n rook-ceph get pod
# æŸ¥çœ‹é›†ç¾¤å¥åº·
kubectl -n rook-ceph get cephcluster
```

![image-20250318215801094](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250318215801094.png)

**å¦‚æœç¬¬ä¸€æ¬¡æ²¡æœ‰åˆ›å»ºæˆåŠŸOSDï¼Œå¯æ¸…ç†é‡æ–°å°è¯•**

```bash
# åœæ­¢å½“å‰é›†ç¾¤çš„OSDæœåŠ¡ï¼ˆé¿å…å¹²æ‰°ï¼‰
kubectl -n rook-ceph delete --all pods -l app=rook-ceph-osd
#åˆ é™¤ä¹‹å‰åˆ›å»ºçš„crd
kubectl get crds | grep "ceph.rook.io" | awk '{print $1}' | xargs kubectl delete crd
kubectl get clusterroles | grep "rook" | awk '{print $1}' | xargs kubectl delete clusterrole
kubectl get clusterrolebindings | grep "rook" | awk '{print $1}' | xargs kubectl delete clusterrolebinding
kubectl get roles -n rook-ceph | awk '{print $1}' | xargs kubectl delete role -n rook-ceph
kubectl get rolebindings -n rook-ceph | awk '{print $1}' | xargs kubectl delete rolebinding -n rook-ceph
kubectl get serviceaccounts -n rook-ceph | awk '{print $1}' | xargs kubectl delete serviceaccount -n rook-ceph

# åœ¨æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
sudo rm -rf /var/lib/rook/*
sudo wipefs -a /dev/nvme0n2
sudo dd if=/dev/zero of=/dev/nvme0n2 bs=1M count=1000

sudo reboot  # å¯é€‰ï¼šé‡å¯ç¡®ä¿è®¾å¤‡çŠ¶æ€åˆ·æ–°
```

> [!NOTE]
>
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**osd-x çš„å®¹å™¨å¿…é¡»æ˜¯å­˜åœ¨çš„**ï¼Œä¸”æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœä¸Šè¿° Pod å‡æ­£å¸¸ï¼Œåˆ™è®¤ä¸ºé›†ç¾¤å®‰è£…æˆåŠŸã€‚
> **æ›´å¤šé…ç½®ï¼šhttps://rook.io/docs/rook/v1.6/ceph-cluster-crd.html**



####  2ï¼‰å®‰è£… ceph snapshot æ§åˆ¶å™¨ 

snapshot æ§åˆ¶å™¨çš„éƒ¨ç½²åœ¨é›†ç¾¤å®‰è£…æ—¶çš„ k8s-ha-install é¡¹ç›®ä¸­ï¼Œéœ€è¦åˆ‡æ¢åˆ° 1.20.x åˆ†æ”¯ï¼š

```bash
cd /root/k8s-ha-install/
git checkout manual-installation-v1.20.x 
```

åˆ›å»º snapshot controllerï¼š

```bash
kubectl create -f /root/k8s-ha-install/snapshotter/ -n kube-system
kubectl get po -n kube-system -l app=snapshot-controller


[root@K8S-Master01 examples]# kubectl get po -n kube-system -l app=snapshot-controller
NAME                    READY   STATUS    RESTARTS   AGE
snapshot-controller-0   1/1     Running   0          6m16s
```

#### 3ï¼‰å®‰è£… ceph å®¢æˆ·ç«¯å·¥å…·

```bash
cd /root/rook/deploy/examples/
kubectl  create -f /root/rook/deploy/examples/toolbox.yaml -n rook-ceph 
kubectl get po -n rook-ceph -l app=rook-ceph-tools


[root@K8S-Master01 examples]# kubectl get po -n rook-ceph -l app=rook-ceph-tools
NAME                               READY   STATUS    RESTARTS   AGE
rook-ceph-tools-7b75b967db-ls9t4   1/1     Running   0          6m51s
```

å®¹å™¨å¯åŠ¨åï¼Œå³å¯è¿›å…¥å®¹å™¨å†…éƒ¨æ‰§è¡ŒæœåŠ¡å‘½ä»¤

```bash
[root@k8s-master01 examples]# kubectl -n rook-ceph exec deploy/rook-ceph-tools -- ceph osd stat
3 osds: 3 up (since 7m), 3 in (since 7m); epoch: e16
[root@k8s-master01 examples]# kubectl -n rook-ceph exec deploy/rook-ceph-tools -- ceph -s
  cluster:
    id:     dd96e25d-c610-4fc2-a0aa-41bf4cd9d750
    health: HEALTH_OK
 
  services:
    mon: 3 daemons, quorum a,b,c (age 5m)
    mgr: b(active, since 6m), standbys: a
    osd: 3 osds: 3 up (since 7m), 3 in (since 7m)
 
  data:
    pools:   1 pools, 1 pgs
    objects: 2 objects, 449 KiB
    usage:   82 MiB used, 30 GiB / 30 GiB avail
    pgs:     1 active+clean

å¦‚æœè§‰å¾—æ‰§è¡Œå‘½ä»¤è¿‡é•¿,å¯ä»¥è®¾ç½®åˆ«å
```

å…·ä½“æ–‡æ¡£ï¼šhttps://rook.io/docs/rook/v1.6/ceph-csi-snapshot.html



#### 4ï¼‰å®‰è£…Ceph dashboard

é»˜è®¤æƒ…å†µä¸‹ï¼Œceph dashboardæ˜¯æ‰“å¼€çš„ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªnodePortç±»å‹çš„Serviceæš´éœ²æœåŠ¡ ï¼ˆæ–°ç‰ˆæœ¬è¯¥æ–‡ä»¶é»˜è®¤å­˜åœ¨å¯ä»¥ç›´æ¥åˆ›å»ºï¼‰ï¼š

**æœ‰å­˜åœ¨ä»¥ä¸‹å››ä¸ªç±»å‹çš„ SVC æ–‡ä»¶**ï¼Œå¦‚æœdashboard ä¹‹å‰è®¾ç½®çš„æ˜¯ssl: true é‚£ä¹ˆæ ¹æ®å®é™…æƒ…å†µå»è¿›è¡Œåˆ›å»º

```bash
[root@k8s-master01 examples]# ls dashboard-*
dashboard-external-https.yaml  dashboard-external-http.yaml  dashboard-ingress-https.yaml  dashboard-loadbalancer.yaml
```

åˆ›å»º

```bash
kubectl create -f dashboard-external-http.yaml

[root@k8s-master01 examples]#  kubectl get svc  -n rook-ceph rook-ceph-mgr-dashboard-external-https 
NAME                                     TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
rook-ceph-mgr-dashboard-external-https   NodePort   10.96.211.249   <none>        8443:31983/TCP   80s


#è·å–ç™»é™†å¯†ç 
kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath="{['data']['password']}" | base64 --decode && echo

[root@k8s-master01 examples]# kubectl -n rook-ceph get secret rook-ceph-dashboard-password -o jsonpath="{['data']['password']}" | base64 --decode && echo
?e(Rt^HC}0$(=?;TII8R
```

WEB è®¿é—®

![image-20250318223910263](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250318223910263.png)

## ceph å—å­˜å‚¨çš„ä½¿ç”¨

å—å­˜å‚¨ä¸€èˆ¬ç”¨äºä¸€ä¸ª Pod æŒ‚è½½ä¸€å—å­˜å‚¨ä½¿ç”¨ï¼Œç›¸å½“äºä¸€ä¸ªæœåŠ¡å™¨æ–°æŒ‚äº†ä¸€ä¸ªç›˜ï¼Œåªç»™ä¸€ä¸ªåº”ç”¨ä½¿ç”¨ã€‚
å‚è€ƒæ–‡æ¡£ï¼šhttps://rook.io/docs/rook/v1.6/ceph-block.html

#### 1ï¼‰åˆ›å»º StorageClass å’Œ ceph çš„å­˜å‚¨æ± 

```bash
cd /root/rook/deploy/examples
kubectl create -f csi/rbd/storageclass.yaml -n rook-ceph


[root@k8s-master01 examples]# kubectl get cephblockpool -n rook-ceph
NAME          PHASE   TYPE         FAILUREDOMAIN   AGE
replicapool   Ready   Replicated   host            2m7s
[root@k8s-master01 examples]# kubectl get sc
NAME              PROVISIONER                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
rook-ceph-block   rook-ceph.rbd.csi.ceph.com   Delete          Immediate           true                   2m15s

# æŸ¥çœ‹cephæä¾›çš„å­˜å‚¨é©±åŠ¨
kubectl get csidriver
```

![image-20250319105132838](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250319105132838.png)

Yaml é…ç½®æ–‡ä»¶è§£é‡Š

```yaml
apiVersion: ceph.rook.io/v1
kind: CephBlockPool
metadata:
  name: replicapool          # å­˜å‚¨æ± åç§°
  namespace: rook-ceph       # æ‰€å±å‘½åç©ºé—´ï¼ˆå¿…é¡»ä¸CephClusterä¸€è‡´ï¼‰
spec:
  failureDomain: host        # æ•°æ®å‰¯æœ¬åˆ†å¸ƒç­–ç•¥ï¼ˆæ•…éšœåŸŸçº§åˆ«ï¼‰å…¶ä»–å¯é€‰å€¼ï¼šosdï¼ˆä¸åŒOSDç£ç›˜ï¼‰ã€rackï¼ˆä¸åŒæœºæ¶ï¼‰ã€‚
  replicated:
    size: 3                  # æ•°æ®å‰¯æœ¬æ•°é‡,æ¯ä¸ªæ•°æ®å—ä¿å­˜ 3ä¸ªå‰¯æœ¬ï¼ˆå³åŒä¸€ä»½æ•°æ®åœ¨é›†ç¾¤ä¸­æœ‰3ä»½æ‹·è´ï¼‰ã€‚
    requireSafeReplicaSize: true  # å¼ºåˆ¶å‰¯æœ¬æ•°å¿…é¡»æ»¡è¶³æœ€å°å®‰å…¨è¦æ±‚
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: rook-ceph-block      # å­˜å‚¨ç±»åç§°ï¼ˆåˆ›å»ºPVCæ—¶éœ€æŒ‡å®šï¼‰
provisioner: rook-ceph.rbd.csi.ceph.com  # CSIé©±åŠ¨åç§°
parameters:
  clusterID: rook-ceph       # Cephé›†ç¾¤IDï¼ˆå¿…é¡»ä¸CephClusteråç§°ä¸€è‡´ï¼‰
  pool: replicapool          # ä½¿ç”¨çš„Cephå­˜å‚¨æ± ï¼ˆå³ä¸Šè¿°å®šä¹‰çš„replicapoolï¼‰
  imageFormat: "2"           # RBDé•œåƒæ ¼å¼ç‰ˆæœ¬,ä½¿ç”¨ ç¬¬2ç‰ˆRBDæ ¼å¼ï¼ˆæ”¯æŒæ›´å¤šåŠŸèƒ½å¦‚åŠ¨æ€è°ƒæ•´å¤§å°ï¼‰ã€‚
  imageFeatures: layering    # RBDé•œåƒæ”¯æŒçš„ç‰¹æ€§,æ”¯æŒ åˆ†å±‚å…‹éš†ï¼ˆç”¨äºå¿«ç…§å’Œå…‹éš†åŠŸèƒ½ï¼‰ã€‚
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner  # ä¾›åº”è€…å¯†é’¥åç§°
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph  # å¯†é’¥æ‰€åœ¨å‘½åç©ºé—´
  csi.storage.k8s.io/controller-expand-secret-name: rook-csi-rbd-provisioner  # æ‰©å®¹å­˜å‚¨å·æ—¶ä½¿ç”¨çš„è®¤è¯ä¿¡æ¯åç§°
  csi.storage.k8s.io/controller-expand-secret-namespace: rook-ceph  # å¯†é’¥å‘½åç©ºé—´
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node  # èŠ‚ç‚¹æŒ‚è½½å¯†é’¥åç§°
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph  # å¯†é’¥å‘½åç©ºé—´
  csi.storage.k8s.io/fstype: ext4  # æ–‡ä»¶ç³»ç»Ÿç±»å‹,å­˜å‚¨å·æ ¼å¼åŒ–æ—¶ä½¿ç”¨ ext4æ–‡ä»¶ç³»ç»Ÿï¼ˆå¯é€‰ï¼šxfsã€ext3ç­‰ï¼‰ã€‚
allowVolumeExpansion: true   # å…è®¸é€šè¿‡KubernetesåŠ¨æ€æ‰©å±•å­˜å‚¨å·å¤§å°ã€‚
reclaimPolicy: Delete        # å›æ”¶ç­–ç•¥,åˆ é™¤PVCæ—¶è‡ªåŠ¨åˆ é™¤åº•å±‚RBDé•œåƒï¼ˆå¯é€‰ï¼šRetain ä¿ç•™æ•°æ®ï¼‰ 
```

ä»Dashboardä¸Šå¯ä»¥çœ‹åˆ°åˆšåˆšæ‰€åˆ›å»ºçš„Poolï¼Œå¹¶ä¸”å‰¯æœ¬æ•°é‡æ˜¯æˆ‘ä»¬è®¾ç½®çš„ size: 2

![image-20250319094218541](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250319094218541.png)

#### 2ï¼‰æŒ‚è½½æµ‹è¯•

åˆ›å»ºä¸€ä¸ª MySQL æœåŠ¡

```bash
cd /root/rook/deploy/examples
kubectl create -f mysql.yaml 

kubectl get pvc,pv,po
```

![image-20250319104503122](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250319104503122.png)

![image-20250319104431209](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250319104431209.png)

**Yaml é…ç½®æ–‡ä»¶è§£é‡Š**

> [!NOTE]   
>
> Volume é€šè¿‡ä¸»è¦é…ç½®å‚æ•°ï¼šclaimNameï¼šmysql-pv-claim æŒ‡å®šPVC
>
> PVC é€šè¿‡ä¸»è¦é…ç½®å‚æ•°ï¼šstorageClassName: rook-ceph-block æŒ‡å®šSC

```yaml
apiVersion: v1
kind: Service
metadata:
  name: wordpress-mysql      # æœåŠ¡åç§°
  labels:
    app: wordpress           # æœåŠ¡æ ‡ç­¾ï¼ˆç”¨äºå…³è”åº”ç”¨ï¼‰
spec:
  ports:
    - port: 3306             # æš´éœ²çš„ç«¯å£å·ï¼ˆMySQLé»˜è®¤ç«¯å£ï¼‰
  selector:
    app: wordpress           # é€‰æ‹©å™¨ï¼šåŒ¹é…Podçš„æ ‡ç­¾
    tier: mysql
  clusterIP: None            # ä½¿ç”¨Headless Serviceï¼ˆæ— é›†ç¾¤IPï¼‰
  
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim        # PVCåç§°
  labels:
    app: wordpress
spec:
  storageClassName: rook-ceph-block  # æŒ‡å®šä½¿ç”¨çš„å­˜å‚¨ç±»ï¼ˆéœ€æå‰åˆ›å»ºï¼‰
  accessModes:
    - ReadWriteOnce           # è®¿é—®æ¨¡å¼ï¼šå•èŠ‚ç‚¹è¯»å†™
  resources:
    requests:
      storage: 5Gi           # è¯·æ±‚5Giå­˜å‚¨ç©ºé—´
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress-mysql        # éƒ¨ç½²åç§°
  labels:
    app: wordpress
    tier: mysql
spec:
  selector:
    matchLabels:              # é€‰æ‹©å™¨ï¼šåŒ¹é…Podæ ‡ç­¾
      app: wordpress
      tier: mysql
  strategy:
    type: Recreate           # æ›´æ–°ç­–ç•¥ï¼šå…ˆç»ˆæ­¢æ—§Podå†åˆ›å»ºæ–°Podï¼ˆé˜²æ­¢æ•°æ®å†²çªï¼‰
  template:
    metadata:
      labels:
        app: wordpress
        tier: mysql
    spec:
      containers:
        - image: mysql:5.6    # ä½¿ç”¨MySQL 5.6é•œåƒ
          name: mysql
          env:
            - name: MYSQL_ROOT_PASSWORD  # è®¾ç½®MySQL rootå¯†ç 
              value: changeme            # å®é™…ç¯å¢ƒåº”ä½¿ç”¨Secretç®¡ç†
          ports:
            - containerPort: 3306        # å®¹å™¨æš´éœ²ç«¯å£
              name: mysql
          volumeMounts:
            - name: mysql-persistent-storage
              mountPath: /var/lib/mysql  # MySQLæ•°æ®å­˜å‚¨è·¯å¾„
      volumes:
        - name: mysql-persistent-storage
          persistentVolumeClaim:
            claimName: mysql-pv-claim    # ç»‘å®šåˆ°ä¸Šè¿°PVC
```

pvc ä¼šè¿æ¥åˆšæ‰åˆ›å»ºçš„ `storageClass`ï¼ŒåŠ¨æ€çš„åˆ›å»º `pv` ï¼Œç„¶åè¿æ¥åˆ° ceph åˆ›å»ºå¯¹åº”çš„å­˜å‚¨ä¹‹ååˆ›å»ºã€‚ `pvc` åªéœ€è¦æŒ‡å®š `storageClassName` ä¸ºåˆšæ‰åˆ›å»ºçš„ `StorageClass` åç§°å³å¯è¿æ¥åˆ° rook çš„cephã€‚å¦‚æœæ˜¯ statefulsetï¼Œåªéœ€è¦å°† `volumeTemplateClaim` é‡Œé¢çš„ `Claim` åç§°æ”¹ä¸º `StorageClass` åç§°å³å¯åŠ¨æ€åˆ›å»º Pod

**å®Œæ•´æµç¨‹è¯´æ˜**

**1.å­˜å‚¨åˆ†é…**ï¼š

- å½“PVC `mysql-pv-claim` è¢«åˆ›å»ºæ—¶ï¼ŒRook-Cephä¼šæ ¹æ® `rook-ceph-block` å­˜å‚¨ç±»åŠ¨æ€åˆ›å»ºPVï¼ˆRBDé•œåƒï¼‰ã€‚
- PVCä¸PVç»‘å®šåï¼ŒMySQL Podæ‰èƒ½æŒ‚è½½å­˜å‚¨å·ã€‚

**2.æœåŠ¡è®¿é—®**ï¼š

- å…¶ä»–Podï¼ˆå¦‚WordPressï¼‰å¯é€šè¿‡DNSåç§° `wordpress-mysql` è®¿é—®MySQLæœåŠ¡ã€‚
- Headless Serviceçš„DNSè®°å½•ç›´æ¥æŒ‡å‘MySQL Pod IPï¼Œé€‚ç”¨äºéœ€è¦ç›´æ¥è®¿é—®Podçš„åœºæ™¯ã€‚

**3.æ•°æ®æŒä¹…åŒ–**ï¼š

- MySQLæ•°æ®ä¿å­˜åœ¨ `/var/lib/mysql` ç›®å½•ï¼Œåº•å±‚ç”±Ceph RBDæä¾›é«˜å¯ç”¨å­˜å‚¨ã€‚
- å³ä½¿Podé‡å¯æˆ–è¿ç§»ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚

å¸è½½pv

```bash
[root@k8s-master01 examples]# kubectl delete -f mysql.yaml
service "wordpress-mysql" deleted
persistentvolumeclaim "mysql-pv-claim" deleted
deployment.apps "wordpress-mysql" deleted


[root@k8s-master01 examples]# kubectl get pvc,pv,po
No resources found
```

#### 3ï¼‰StatefulSet åŠ¨æ€å­˜å‚¨

æ™®é€šæƒ…å†µ PVCé€šè¿‡ StorageClass ä¸€æ¬¡åªèƒ½åˆ›ä¸€ä¸ªPVï¼Œä½†æ˜¯ StatefulSet æœ‰çŠ¶æ€çš„æœåŠ¡ä¸é€‚ç”¨äºå…±äº«å­˜å‚¨æ•°æ®ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å¼‚å¸¸ï¼Œæ‰€ä»¥æ¯ä¸ªpoéœ€è¦ä¸€ä¸ªpvã€‚å¯ä»¥é€šè¿‡volumeClaimTemplatesï¼šæ¥å®ç°

```bash
#éƒ¨ç½²
vim sts-sc.yaml
kubectl create -f sts-sc.yaml

kubectl get pvc,pv,po


#å¸è½½
kubectl delete -f sts-sc.yaml
kubectl delete pvc www-web-0,www-web-1,www-web-2
```

![image-20250319171613950](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250319171613950.png)

![image-20250319172717235](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250319172717235.png)

```yaml
# å®šä¹‰ä¸€ä¸ª Service èµ„æº
apiVersion: v1
kind: Service
metadata:
  name: nginx                 # æœåŠ¡åç§°
  labels:
    app: nginx                # æœåŠ¡æ ‡ç­¾ï¼ˆç”¨äºå…³è”åº”ç”¨ï¼‰
spec:
  ports:
  - port: 80                  # æœåŠ¡æš´éœ²ç«¯å£
    name: web                 # ç«¯å£åç§°æ ‡è¯†
  clusterIP: None             # ä½¿ç”¨Headless Serviceï¼ˆæ— é›†ç¾¤IPï¼‰
  selector:
    app: nginx                # é€‰æ‹©å™¨ï¼šåŒ¹é…Podçš„æ ‡ç­¾

---
# å®šä¹‰ä¸€ä¸ª StatefulSet èµ„æº
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web                   # StatefulSetåç§°
spec:
  selector:
    matchLabels:
      app: nginx              # å¿…é¡»ä¸Podæ¨¡æ¿ä¸­çš„æ ‡ç­¾ä¸€è‡´
  serviceName: "nginx"        # å…³è”çš„Headless Serviceåç§°
  replicas: 3                 # å‰¯æœ¬æ•°é‡ï¼ˆåˆ›å»º3ä¸ªPodï¼šweb-0, web-1, web-2ï¼‰
  minReadySeconds: 10         # æ–°Podå°±ç»ªåç­‰å¾…10ç§’æ‰è§†ä¸ºå¯ç”¨
  template:
    metadata:
      labels:
        app: nginx            # Podæ ‡ç­¾ï¼ˆå¿…é¡»ä¸selector.matchLabelsä¸€è‡´ï¼‰
    spec:
      terminationGracePeriodSeconds: 10  # åˆ é™¤Podæ—¶çš„ä¼˜é›…ç»ˆæ­¢ç­‰å¾…æ—¶é—´
      containers:
      - name: nginx
        image: m.daocloud.io/docker.io/library/nginx:latest  # ä½¿ç”¨Nginxé•œåƒ
        ports:
        - containerPort: 80   # å®¹å™¨ç›‘å¬ç«¯å£
          name: web           # ç«¯å£åç§°æ ‡è¯†
        volumeMounts:
        - name: www           # æŒ‚è½½çš„å·åç§°ï¼ˆä¸volumeClaimTemplatesåŒ¹é…ï¼‰
          mountPath: /usr/share/nginx/html  # æŒ‚è½½è·¯å¾„ï¼ˆNginxé»˜è®¤é™æ€æ–‡ä»¶ç›®å½•ï¼‰
  volumeClaimTemplates:       # åŠ¨æ€åˆ›å»ºPVCçš„æ¨¡æ¿ï¼ˆæ¯ä¸ªPodè‡ªåŠ¨ç”Ÿæˆç‹¬ç«‹PVCï¼‰
  - metadata:
      name: www               # PVCåç§°æ¨¡æ¿ï¼ˆæœ€ç»ˆåç§°ï¼šwww-web-0, www-web-1ç­‰ï¼‰
    spec:
      accessModes: [ "ReadWriteOnce" ]  # è®¿é—®æ¨¡å¼ï¼šå•èŠ‚ç‚¹è¯»å†™
      storageClassName: "rook-ceph-block"  # ä½¿ç”¨çš„å­˜å‚¨ç±»ï¼ˆéœ€æå‰åˆ›å»ºï¼‰
      resources:
        requests:
          storage: 1Gi        # æ¯ä¸ªPVCè¯·æ±‚1Giå­˜å‚¨ç©ºé—´
```



## å…±äº«æ–‡ä»¶ç³»ç»Ÿçš„ä½¿ç”¨

å…±äº«æ–‡ä»¶ç³»ç»Ÿä¸€èˆ¬ç”¨äºå¤šä¸ª Pod å…±äº«ä¸€ä¸ªå­˜å‚¨
å®˜æ–¹æ–‡æ¡£ï¼šhttps://rook.io/docs/rook/v1.6/ceph-filesystem.html

#### 1ï¼‰åˆ›å»ºå…±äº«ç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿå’Œ StorageClass

> [!NOTE]
>
> æ–‡ä»¶å­˜å‚¨ä¼šæœ‰åˆ›å»ºMDS ç”¨æ¥å­˜æ”¾å…ƒæ•°æ®ï¼Œå¤šä¸ª MDS èŠ‚ç‚¹å…±äº«å…ƒæ•°æ®ï¼Œé€šè¿‡åŠ¨æ€å­æ ‘åˆ†åŒºå®ç°è´Ÿè½½å‡è¡¡

```bash
cd /root/rook/deploy/examples
kubectl create -f filesystem.yaml
kubectl -n rook-ceph get pod -l app=rook-ceph-mds


kubectl create -f csi/cephfs/storageclass.yaml

[root@k8s-master01 examples]# kubectl get sc
NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           true                   24h
rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           true                   5s
```

![image-20250320094728736](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320094728736.png)

![image-20250320094851340](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320094851340.png)

#### 2ï¼‰nginx æŒ‚è½½æµ‹è¯•

```bash
kubectl create -f nginx.yaml
kubectl get po -l app=nginx

kubectl get pvc,pv,po

vim nginx.yaml
```

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx                 # æœåŠ¡åç§°
  labels:
    app: nginx                # æœåŠ¡æ ‡ç­¾ï¼ˆç”¨äºå…³è”åº”ç”¨ï¼‰
spec:
  ports:
  - port: 80                  # æœåŠ¡æš´éœ²ç«¯å£
    name: web                 # ç«¯å£åç§°æ ‡è¯†
  selector:
    app: nginx                # é€‰æ‹©å™¨ï¼šåŒ¹é…Podçš„æ ‡ç­¾,å°†æµé‡è·¯ç”±åˆ°æ ‡ç­¾ä¸º app: nginx çš„Podã€‚
  type: ClusterIP             # æœåŠ¡ç±»å‹ï¼ˆé»˜è®¤ClusterIPï¼Œä»…é›†ç¾¤å†…è®¿é—®ï¼‰
---
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: nginx-share-pvc       # PVCåç§°
spec:
  storageClassName: rook-cephfs  # ä½¿ç”¨çš„å­˜å‚¨ç±»ï¼ˆéœ€æå‰åˆ›å»ºCephFSå­˜å‚¨ç±»ï¼‰
  accessModes:
  - ReadWriteMany            # è®¿é—®æ¨¡å¼ï¼šå¤šèŠ‚ç‚¹è¯»å†™,å…è®¸å¤šä¸ªPodåŒæ—¶è¯»å†™åŒä¸€ä¸ªå­˜å‚¨å·ï¼ˆé€‚åˆå…±äº«å­˜å‚¨åœºæ™¯ï¼‰
  resources:
    requests:
      storage: 1Gi           # è¯·æ±‚1Giå­˜å‚¨ç©ºé—´
---
apiVersion: apps/v1
kind: Deployment 
metadata:
  name: web                   # éƒ¨ç½²åç§°
spec:
  selector:
    matchLabels:
      app: nginx              # é€‰æ‹©å™¨ï¼šåŒ¹é…Podæ ‡ç­¾
  replicas: 3                 # å‰¯æœ¬æ•°é‡ï¼ˆéƒ¨ç½²3ä¸ªPodï¼‰
  template:
    metadata:
      labels:
        app: nginx            # Podæ ‡ç­¾ï¼ˆå¿…é¡»ä¸selector.matchLabelsä¸€è‡´ï¼‰
    spec:
      containers:
      - name: nginx
        image: m.daocloud.io/docker.io/library/nginx:latest          # ä½¿ç”¨Nginxé•œåƒ
        imagePullPolicy: IfNotPresent  # é•œåƒæ‹‰å–ç­–ç•¥ï¼ˆæœ¬åœ°å­˜åœ¨åˆ™ä¸æ‹‰å–ï¼‰
        ports:
        - containerPort: 80   # å®¹å™¨ç›‘å¬ç«¯å£
          name: web
        volumeMounts:
        - name: www           # æŒ‚è½½çš„å·åç§°
          mountPath: /usr/share/nginx/html  # Nginxé™æ€æ–‡ä»¶ç›®å½•
      volumes:
      - name: www             # å·åç§°ï¼ˆä¸volumeMountsåŒ¹é…ï¼‰
        persistentVolumeClaim:
          claimName: nginx-share-pvc  # ç»‘å®šåˆ°ä¸Šè¿°PVC
```

![image-20250320101251333](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320101251333.png)

#### 3ï¼‰éªŒè¯æ•ˆæœ

![image-20250320103405980](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320103405980.png)





## PVC æ‰©å®¹

> [!CAUTION]                  
>
> æ–‡ä»¶å…±äº«ç±»å‹çš„ PVC æ‰©å®¹éœ€è¦ k8s 1.15+
> å—å­˜å‚¨ç±»å‹çš„ PVC æ‰©å®¹éœ€è¦ k8s 1.16+
>
> 
>
> **åœ¨ Kubernetes ä¸­ï¼ŒPVC çš„ç¼©å®¹åŠŸèƒ½æ˜¯å—é™åˆ¶çš„ã€‚å¤§å¤šæ•°å­˜å‚¨æä¾›å•†ä¸æ”¯æŒ PVC çš„ç¼©å®¹æ“ä½œã€‚å³ä½¿æŸäº›å­˜å‚¨æä¾›å•†æ”¯æŒç¼©å®¹ï¼Œä¹Ÿéœ€è¦æ‰‹åŠ¨å¹²é¢„ï¼Œå¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚å› æ­¤ï¼ŒKubernetes é»˜è®¤ä¸å…è®¸ PVC çš„ç¼©å®¹æ“ä½œã€‚**



#### 1ï¼‰æ‰©å®¹æ–‡ä»¶å…±äº«å‹ PVC 

**å‰ç½®æ¡ä»¶ï¼šéœ€ç¡®ä¿SC å¼€å¯äº†å‚æ•° allowVolumeExpansion: true**

```bash
[root@k8s-master01 examples]# awk '/allowVolumeExpansion/' csi/cephfs/storageclass.yaml
allowVolumeExpansion: true
```

ä¿®æ”¹æ‰©å®¹

```bash
kubectl get pvc,pvc
kubectl edit pvc cephfs-pvc -n kube-system


# æŸ¥çœ‹ä¿®æ”¹è¿‡åçš„å®¹é‡å¤§å°
kubectl get pvc,pvc
```

![image-20250320151651182](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320151651182.png)

#### 2ï¼‰æ‰©å®¹å—å­˜å‚¨

ä¸æ–‡ä»¶ç³»ç»Ÿæ‰©å®¹ä¸€æ ·ï¼Œå…ˆç¡®è®¤scæœ‰æ²¡æœ‰å¼€å¯å…è®¸åŠ¨æ€æ‰©å®¹,ç„¶åç›´æ¥ edit pvè¿›è¡Œå®¹é‡ä¿®æ”¹

```bash
kubectl get pvc,pv,po
kubectl edit pvc mysql-pv-claim
```

![image-20250320153818959](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320153818959.png)

![image-20250320153503573](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320153503573.png)



## PVC å¿«ç…§

#### 1ï¼‰åˆ›å»º snapshotClass

```bash
kubectl create -f csi/rbd/snapshotclass.yaml

[root@k8s-master01 examples]# cat csi/rbd/snapshotclass.yaml
---
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: csi-rbdplugin-snapclass
driver: rook-ceph.rbd.csi.ceph.com # csi-provisioner-name
parameters:
  # Specify a string that identifies your cluster. Ceph CSI supports any
  # unique string. When Ceph CSI is deployed by Rook use the Rook namespace,
  # for example "rook-ceph".
  clusterID: rook-ceph # namespace:cluster
  csi.storage.k8s.io/snapshotter-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/snapshotter-secret-namespace: rook-ceph # namespace:cluster
deletionPolicy: Delete
```

#### 2ï¼‰åˆ›å»ºå¿«ç…§

åˆ›å»ºä¸€äº›æ•°æ®æ¨¡æ‹Ÿç¯å¢ƒ

```bash
kubectl exec -it  wordpress-mysql-cc5fd5cd9-7qd7c -- mkdir /var/lib/mysql/demo{1..3}
kubectl get po,pvc,volumeSnapshotClass


[root@k8s-master01 examples]# vim snapshot.yaml
---
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: rbd-pvc-snapshot
spec:
  volumeSnapshotClassName: csi-rbdplugin-snapclass
  source:
    persistentVolumeClaimName: rbd-pvc
    
    
kubectl create -f  snapshot.yaml    
```

![image-20250320214401478](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320214401478.png)

**æŸ¥çœ‹å¿«ç…§**

```bash
[root@k8s-master01 examples]# kubectl get -f  snapshot.yaml
NAME               READYTOUSE   SOURCEPVC        SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS             SNAPSHOTCONTENT                                    CREATIONTIME   AGE
rbd-pvc-snapshot   true         mysql-pv-claim                           4Gi           csi-rbdplugin-snapclass   snapcontent-0f82a7cd-e84c-409e-80e0-6c54cf047379   4m7s           4m9s
```

#### 3ï¼‰é€šè¿‡å¿«ç…§åˆ›å»º PVC

å¦‚æœæƒ³è¦åˆ›å»ºä¸€ä¸ªå…·æœ‰æŸä¸ªæ•°æ®çš„ PVCï¼Œå¯ä»¥ä»æŸä¸ªå¿«ç…§æ¢å¤

```yaml
cat pvc-restore.yaml
apiVersion: v1  # APIç‰ˆæœ¬å£°æ˜ï¼ˆKubernetesæ ¸å¿ƒAPIï¼‰
kind: PersistentVolumeClaim  # èµ„æºç±»å‹ä¸ºæŒä¹…å·å£°æ˜ï¼ˆPVCï¼‰
metadata:
  name: rbd-pvc-restore  # PVCåç§°ï¼ˆç”¨äºæ ‡è¯†è¯¥å­˜å‚¨å£°æ˜ï¼‰
spec:
  storageClassName: rook-ceph-block  # å­˜å‚¨ç±»åç§°ï¼ˆæŒ‡å‘é¢„å…ˆåˆ›å»ºçš„rook-ceph-blockå­˜å‚¨ç±»ï¼‰
  dataSource:
    name: rbd-pvc-snapshot  # å¼•ç”¨çš„VolumeSnapshotåç§°ï¼ˆéœ€é¢„å…ˆå­˜åœ¨ï¼‰
    kind: VolumeSnapshot  # èµ„æºç±»å‹ä¸ºå­˜å‚¨å¿«ç…§
    apiGroup: snapshot.storage.k8s.io  # å¿«ç…§èµ„æºæ‰€å±çš„APIç»„
  accessModes:
    - ReadWriteOnce  # è®¿é—®æ¨¡å¼é…ç½®ï¼šå•èŠ‚ç‚¹è¯»å†™æŒ‚è½½æ¨¡å¼
  resources:
    requests:
      storage: 4Gi  # å­˜å‚¨ç©ºé—´è¯·æ±‚é‡ï¼ˆå¿…é¡» >= åŸå§‹PVCå®¹é‡ï¼‰
      
 kubectl create -f pvc-restore.yam     
```

![image-20250320221438659](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320221438659.png)

#### 4ï¼‰æ•°æ®æ ¡éªŒ

åˆ›å»ºpodç»‘å®špvcéªŒè¯æ ¡éªŒæ•°æ®

```yaml
vim restore-check-snapshot-rbd.yaml
---
apiVersion: apps/v1  # APIç‰ˆæœ¬å£°æ˜ï¼ˆé€‚ç”¨äºDeploymentèµ„æºï¼‰
kind: Deployment  # èµ„æºç±»å‹ä¸ºDeployment
metadata:
  name: check-snapshot-restore  # Deploymentçš„åç§°
spec:
  selector:
    matchLabels:
      app: check  # åŒ¹é…Podçš„æ ‡ç­¾ï¼Œç”¨äºå…³è”Deploymentå’ŒPod
  strategy:
    type: Recreate  # éƒ¨ç½²ç­–ç•¥ï¼šå…ˆåˆ é™¤æ—§Podï¼Œå†åˆ›å»ºæ–°Pod
  template:         # pod çš„æ¨¡æ¿
    metadata:
      labels:
        app: check  # Podçš„æ ‡ç­¾ï¼Œä¸selectorä¸­çš„æ ‡ç­¾åŒ¹é…
    spec:
      containers:
        - image: m.daocloud.io/docker.io/library/nginx:latest  # ä½¿ç”¨çš„å®¹å™¨é•œåƒ
          name: check  # å®¹å™¨çš„åç§°
          command:
            - sh
            - -c
            - sleep 36000  # å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ï¼šä¼‘çœ 36000ç§’ï¼ˆ10å°æ—¶ï¼‰
          volumeMounts:
            - name: check-mysql-persistent-storage  # æŒ‚è½½çš„å·åç§°
              mountPath: /mnt  # å·æŒ‚è½½åˆ°å®¹å™¨å†…çš„è·¯å¾„
      volumes:
        - name: check-mysql-persistent-storage  # å·çš„åç§°
          persistentVolumeClaim:
            claimName: rbd-pvc-restore  # ä½¿ç”¨çš„PVCåç§°ï¼ˆä»å¿«ç…§æ¢å¤çš„PVCï¼‰
            
 kubectl  create -f restore-check-snapshot-rbd.yaml
 kubectl get -f restore-check-snapshot-rbd.yaml
```

![image-20250320223103903](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250320223103903.png)

#### 5ï¼‰æ–‡ä»¶å…±äº«ç±»å‹å¿«ç…§ 

æ“ä½œæ­¥éª¤å’Œå—å­˜å‚¨ç±»å‹æ— åŒºåˆ«ï¼Œå¯ä»¥å‚è€ƒï¼š
https://rook.io/docs/rook/v1.6/ceph-csi-snapshot.html#cephfs-snapshots



## PVC å…‹éš†

éœ€è¦æ³¨æ„çš„æ˜¯ pvc-clone.yaml çš„ dataSource çš„ name æ˜¯è¢«å…‹éš†çš„ pvc åç§°ï¼Œåœ¨æ­¤æ˜¯ mysql-pvclaimï¼ŒstorageClassName ä¸ºæ–°å»º pvc çš„ storageClass åç§°ï¼Œstorage ä¸èƒ½å°äºä¹‹å‰ pvc çš„å¤§å°ã€‚

```yaml
vim pvc-clone.yaml 
---
apiVersion: v1  # APIç‰ˆæœ¬å£°æ˜ï¼ˆKubernetesæ ¸å¿ƒAPIï¼‰
kind: PersistentVolumeClaim  # èµ„æºç±»å‹ä¸ºæŒä¹…å·å£°æ˜ï¼ˆPVCï¼‰
metadata:
  name: rbd-pvc-clone  # PVCçš„åç§°ï¼ˆç”¨äºæ ‡è¯†è¯¥å…‹éš†PVCï¼‰
spec:
  storageClassName: rook-ceph-block  # å­˜å‚¨ç±»åç§°ï¼ˆæŒ‡å‘é¢„å…ˆåˆ›å»ºçš„rook-ceph-blockå­˜å‚¨ç±»ï¼‰
  dataSource:
    name: mysql-pv-claim  # æ•°æ®æºåç§°ï¼ˆå¼•ç”¨çš„åŸå§‹PVCåç§°ï¼‰
    kind: PersistentVolumeClaim  # æ•°æ®æºç±»å‹ä¸ºPVCï¼ˆè¡¨ç¤ºä»ç°æœ‰PVCå…‹éš†ï¼‰
  accessModes:
    - ReadWriteOnce  # è®¿é—®æ¨¡å¼é…ç½®ï¼šå•èŠ‚ç‚¹è¯»å†™æŒ‚è½½æ¨¡å¼
  resources:
    requests:
      storage: 3Gi  # å­˜å‚¨ç©ºé—´è¯·æ±‚é‡ï¼ˆå¿…é¡» >= åŸå§‹PVCå®¹é‡ï¼‰
      
kubectl create -f pvc-clone.yaml       
```



## ğŸš€æµ‹è¯•æ•°æ®æ¸…ç†

å‚è€ƒé“¾æ¥ï¼šhttps://rook.io/docs/rook/v1.6/ceph-teardown.html

å¦‚æœ Rook è¦ç»§ç»­ä½¿ç”¨ï¼Œå¯ä»¥åªæ¸…ç†åˆ›å»ºçš„ `deployã€podã€pvc` å³å¯ã€‚

**æ¸…ç†æ­¥éª¤:**

#### 1.æ¸…ç†æŒ‚è½½äº† PVC çš„ Pod å’Œ Deployment

- åˆ é™¤æ‰€æœ‰æŒ‚è½½äº† PVC çš„ Podã€Deployment æˆ–å…¶ä»–é«˜çº§èµ„æºã€‚

  ```Bash
  kubectl delete pod <pod-name>
  kubectl delete deployment <deployment-name>
  
  [root@k8s-master01 examples]# kubectl get deploy
  NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
  check-snapshot-restore   1/1     1            1           92m
  wordpress-mysql          1/1     1            1           95m
  [root@k8s-master01 examples]# kubectl delete deploy check-snapshot-restore wordpress-mysql
  deployment.apps "check-snapshot-restore" deleted
  deployment.apps "wordpress-mysql" deleted
  [root@k8s-master01 examples]# kubectl get po
  NAME                                     READY   STATUS        RESTARTS   AGE
  check-snapshot-restore-78f558698-4rqrp   1/1     Terminating   0          89m
  [root@k8s-master01 examples]# kubectl delete po check-snapshot-restore-78f558698-4rqrp
  ```

#### 2.æ¸…ç† PVC

- åˆ é™¤æ‰€æœ‰é€šè¿‡ Ceph StorageClass åˆ›å»ºçš„ PVCã€‚

- æ£€æŸ¥ PV æ˜¯å¦è¢«è‡ªåŠ¨æ¸…ç†ã€‚

  ```Bash
  Bashkubectl delete pvc <pvc-name>
  kubectl get pv  # ç¡®è®¤ PV æ˜¯å¦å·²æ¸…ç†
  
  
  
  [root@k8s-master01 examples]# kubectl get pvc
  NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      VOLUMEATTRIBUTESCLASS   AGE
  mysql-pv-claim    Bound    pvc-dbea43d6-3991-4434-86f7-28707b55f2cb   4Gi        RWO            rook-ceph-block   <unset>                 96m
  rbd-pvc-restore   Bound    pvc-b1ec2323-e0db-486c-95ea-7ad0c3746f1e   4Gi        RWO            rook-ceph-block   <unset>                 100m
  [root@k8s-master01 examples]# kubectl delete pvc mysql-pv-claim rbd-pvc-restore
  persistentvolumeclaim "mysql-pv-claim" deleted
  persistentvolumeclaim "rbd-pvc-restore" deleted
  [root@k8s-master01 examples]# kubectl get pv
  No resources found
  ```

#### 3.æ¸…ç†å¿«ç…§

- åˆ é™¤æ‰€æœ‰ VolumeSnapshot èµ„æºã€‚

  ```Bash
  kubectl delete volumesnapshot <snapshot-name>
  
  
  [root@k8s-master01 examples]# kubectl get volumesnapshot
  NAME               READYTOUSE   SOURCEPVC        SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS             SNAPSHOTCONTENT                                    CREATIONTIME   AGE
  rbd-pvc-snapshot   true         mysql-pv-claim                           4Gi           csi-rbdplugin-snapclass   snapcontent-0f82a7cd-e84c-409e-80e0-6c54cf047379   131m           131m
  [root@k8s-master01 examples]# kubectl delete volumesnapshot rbd-pvc-snapshot
  volumesnapshot.snapshot.storage.k8s.io "rbd-pvc-snapshot" deleted
  
  # åˆ é™¤å¿«ç…§æ§åˆ¶å™¨
  kubectl delete -f /root/k8s-ha-install/snapshotter/ -n kube-system
  ```

#### 4.æ¸…ç†å­˜å‚¨æ± 

- åˆ é™¤å—å­˜å‚¨æ± å’Œæ–‡ä»¶å­˜å‚¨æ± ã€‚

  ```Bash
  #  æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨æ± 
  kubectl -n rook-ceph exec deploy/rook-ceph-tools -- ceph osd pool ls
  
  
  kubectl delete -n rook-ceph cephblockpool replicapool
  kubectl delete -n rook-ceph cephfilesystem myfs
  ```

#### 5.æ¸…ç† StorageClass

- åˆ é™¤ Rook åˆ›å»ºçš„ StorageClassã€‚

  ```Bash
  kubectl delete sc rook-ceph-block rook-cephfs
  
  [root@k8s-master01 examples]# kubectl get sc
  NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
  rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           true                   38h
  rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           true                   14h
  [root@k8s-master01 examples]# kubectl delete sc rook-ceph-block rook-cephfs
  storageclass.storage.k8s.io "rook-ceph-block" deleted
  storageclass.storage.k8s.io "rook-cephfs" deleted
  ```

#### 6.æ¸…ç† Ceph é›†ç¾¤

- åˆ é™¤ CephCluster èµ„æºã€‚

  ```Bash
  kubectl delete -f cluster.yaml
  ```

#### 7.åˆ é™¤ Rook èµ„æº

- åˆ é™¤ Rook çš„ Operatorã€Common å’Œ CRD èµ„æºã€‚

  ```Bash
  kubectl delete -f operator.yaml
  kubectl delete -f common.yaml
  kubectl delete -f crds.yaml
  ```

#### 8.å¤„ç†å¡ä½èµ„æºï¼ˆå¦‚æœ‰ï¼‰

- è‹¥èµ„æºåˆ é™¤å¡ä½ï¼Œå‚è€ƒ Rook å®˜æ–¹æ–‡æ¡£è¿›è¡Œæ•…éšœæ’é™¤ã€‚å¦‚æœç”±äºæŸäº›åŸå› æ“ä½œå‘˜æ— æ³•ç§»é™¤ç»ˆç»“å™¨ï¼ˆä¾‹å¦‚ï¼Œæ“ä½œå‘˜ä¸å†è¿è¡Œï¼‰ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨åˆ é™¤ç»ˆç»“å™¨ï¼š

  ```Bash
  for CRD in $(kubectl get crd -n rook-ceph | awk '/ceph.rook.io/ {print $1}'); do
      kubectl get -n rook-ceph "$CRD" -o name | \
      xargs -I {} kubectl patch {} --type merge -p '{"metadata":{"finalizers": [null]}}'
  done
  ```

å‡ ç§’é’Ÿå†…ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°é›†ç¾¤ CRD å·²è¢«åˆ é™¤ï¼Œå°†ä¸å†é˜»æ­¢å…¶ä»–æ¸…ç†æ“ä½œï¼Œä¾‹å¦‚åˆ é™¤ `rook-ceph` å‘½åç©ºé—´ã€‚

å¦‚æœå‘½åç©ºé—´ä»ç„¶å¤„äºç»ˆæ­¢çŠ¶æ€ï¼Œæ‚¨å¯ä»¥æ£€æŸ¥å“ªäº›èµ„æºæ­£åœ¨é˜»æ­¢åˆ é™¤ï¼Œå¹¶ç§»é™¤æœ€ç»ˆ izers å¹¶åˆ é™¤è¿™äº›èµ„æºï¼Œ

```bash
kubectl api-resources --verbs=list --namespaced -o name \
  | xargs -n 1 kubectl get --show-kind --ignore-not-found -n rook-ceph
```

å¦‚æœåˆ é™¤å¤±è´¥ï¼Œç»ˆç«¯ä¸€ç›´å¡åœ¨åˆ é™¤ä¸­é‚£ä¹ˆåº”è¯¥æ˜¯é…ç½®æœ‰ Finalizers é˜»å¡åˆ é™¤ï¼ŒFinalizer æ˜¯ Kubernetes ä¸­ä¸€ç§æœºåˆ¶ï¼Œç”¨äºåœ¨èµ„æºåˆ é™¤å‰æ‰§è¡Œæ¸…ç†é€»è¾‘ã€‚å¦‚æœ finalizer æœªè¢«é‡Šæ”¾ï¼Œèµ„æºä¼šå¤„äºåˆ é™¤æŒ‚èµ·çŠ¶æ€ã€‚å¯ä»¥é€šè¿‡ `kubectl get configmap rook-ceph-mon-endpoints -n rook-ceph -o yaml | grep finalizers` ç¡®è®¤äº†è¯¥ ConfigMap å­˜åœ¨ `finalizers`

![image-20250321093508407](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250321093508407.png)

```bash
[root@k8s-master01 examples]# kubectl get cephfilesystemsubvolumegroup.ceph.rook.io myfs-csi -n rook-ceph -o yaml | grep finalizers
  finalizers:


kubectl edit cephfilesystemsubvolumegroup.ceph.rook.io myfs-csi -n rook-ceph
```

![image-20250321094012545](./images/4.Rook%E9%83%A8%E7%BD%B2ceph/image-20250321094012545.png)

#### 9.æ¸…ç†æ•°æ®ç›®å½•å’Œç£ç›˜

```bash
rm -rf /var/lib/rook/*
```

#### 10.æ¸…ç†OSD æ‰€ä½¿ç”¨ç£ç›˜

```bash
#!/usr/bin/env bash
DISK="/dev/sdb"

# Zap the disk to a fresh, usable state (zap-all is important, b/c MBR has to be clean)

# You will have to run this step for all disks.
sgdisk --zap-all $DISK

# Clean hdds with dd
dd if=/dev/zero of="$DISK" bs=1M count=100 oflag=direct,dsync

# Clean disks such as ssd with blkdiscard instead of dd
blkdiscard $DISK

# These steps only have to be run once on each node
# If rook sets up osds using ceph-volume, teardown leaves some devices mapped that lock the disks.
ls /dev/mapper/ceph-* | xargs -I% -- dmsetup remove %

# ceph-volume setup can leave ceph-<UUID> directories in /dev and /dev/mapper (unnecessary clutter)
rm -rf /dev/ceph-*
rm -rf /dev/mapper/ceph--*

# Inform the OS of partition table changes
partprobe $DISK
```

å‚è€ƒé“¾æ¥ï¼šhttps://rook.io/docs/rook/v1.6/ceph-teardown.html#delete-the-dataon-hosts
