# Ingress 

## ä¸€ã€Ingress æ¦‚å¿µ

### 1.1 Ingress è¯ç”ŸèƒŒæ™¯

åœ¨ Kubernetes ä¸­ï¼Œä¼ ç»Ÿçš„ Service æš´éœ²æ–¹å¼ï¼ˆå¦‚ NodePortï¼‰å­˜åœ¨ä»¥ä¸‹å±€é™ï¼š

- **åè®®æ”¯æŒæœ‰é™**ï¼šService çš„å®ç°æ–¹å¼ï¼ˆå¦‚ `use_space`ã€`iptables`ã€`ipvs`ï¼‰ä»…æ”¯æŒ 4 å±‚åè®®é€šä¿¡ï¼Œæ— æ³•æ»¡è¶³ 7 å±‚åè®®ï¼ˆå¦‚ HTTPSï¼‰çš„ä»£ç†éœ€æ±‚ï¼Œé™åˆ¶äº†å¤æ‚åº”ç”¨çš„éƒ¨ç½²ã€‚
- **ç«¯å£ç®¡ç†å¤æ‚**ï¼šNodePort éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæš´éœ²æœåŠ¡ç«¯å£ï¼Œéšç€æœåŠ¡æ•°é‡çš„å¢åŠ ï¼Œç«¯å£ç®¡ç†å˜å¾—æå…¶å¤æ‚ä¸”éš¾ä»¥ç»´æŠ¤ã€‚
- **é…ç½®æ›´æ–°ç¹ç**ï¼šéœ€æ‰‹åŠ¨ç»´æŠ¤åå‘ä»£ç†ï¼ˆå¦‚ Nginxï¼‰çš„é…ç½®ï¼Œæ•ˆç‡ä½ä¸‹ã€‚

ä¸ºè§£å†³è¿™äº›é—®é¢˜ï¼ŒIngress åº”è¿è€Œç”Ÿï¼Œæä¾›äº†ä¸€ç§æ›´çµæ´»ã€é«˜æ•ˆçš„æ–¹å¼ï¼Œç”¨äºç®¡ç†å¤–éƒ¨å¯¹é›†ç¾¤å†…éƒ¨æœåŠ¡çš„è®¿é—®ã€‚

```mermaid
flowchart TD
    A[ä¼ ç»ŸæœåŠ¡æš´éœ²ç—›ç‚¹] --> B[NodePortç«¯å£çˆ†ç‚¸]
    A --> C[ç¼ºä¹7å±‚åè®®æ”¯æŒ]
    A --> D[é…ç½®æ›´æ–°ç¹ç]
    B --> E(100+æœåŠ¡éœ€ç®¡ç†300+ç«¯å£)
    C --> F(æ— æ³•å®ç°åŸºäºHost/Pathçš„è·¯ç”±)
    D --> G(éœ€æ‰‹åŠ¨ç»´æŠ¤Nginxé…ç½®)
```



### 1.2 Ingress å’Œ Ingress Controller çš„åŒºåˆ«

#### 1.2.1 Ingress å¯¹è±¡

Ingress æ˜¯ Kubernetes ä¸­çš„ä¸€ä¸ª API å¯¹è±¡ï¼Œé€šè¿‡ YAML æ–‡ä»¶å®šä¹‰è¯·æ±‚å¦‚ä½•è½¬å‘åˆ° Service çš„è§„åˆ™ã€‚å…¶åŠŸèƒ½åŒ…æ‹¬ï¼š

- **å¤–éƒ¨è®¿é—®**ï¼šé€šè¿‡ HTTP æˆ– HTTPS æš´éœ² Serviceï¼Œä¸ºæœåŠ¡æä¾›å¤–éƒ¨ URLã€‚
- **è´Ÿè½½å‡è¡¡**ï¼šå¯¹è¿›å…¥çš„æµé‡è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œæé«˜æœåŠ¡çš„å¯ç”¨æ€§å’Œæ€§èƒ½ã€‚
- **SSL/TLS æ”¯æŒ**ï¼šæä¾›åŠ å¯†èƒ½åŠ›ï¼Œä¿éšœæ•°æ®ä¼ è¾“å®‰å…¨ã€‚
- **åå‘ä»£ç†**ï¼šåŸºäº Host æˆ– Path çš„è§„åˆ™ï¼Œçµæ´»è½¬å‘è¯·æ±‚åˆ°ä¸åŒçš„ Serviceã€‚

Ingress çš„é…ç½®æ–‡ä»¶åŒ…å« apiVersionã€kindã€metadataã€spec ç­‰å…³é”®å­—æ®µã€‚å…¶ä¸­ï¼Œspec å­—æ®µç”¨äºå®šä¹‰è½¬å‘è§„åˆ™ï¼Œå¦‚ tls ç”¨äº HTTPS é…ç½®ï¼Œrule ç”¨äºæŒ‡å®šè¯·æ±‚çš„è·¯ç”±è§„åˆ™ã€‚æ­¤å¤–ï¼Œmetadata.annotations å­—æ®µåœ¨ Ingress é…ç½®ä¸­å æ®é‡è¦åœ°ä½ï¼Œä¸åŒçš„ Ingress Controller å¯ä»¥æ ¹æ® annotations ä¸­çš„å‚æ•°è¿›è¡Œè‡ªå®šä¹‰é…ç½®ã€‚

#### 1.2.2 Ingress Controller

Ingress Controller æ˜¯å…·ä½“å®ç°åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„ç¨‹åºï¼Œè´Ÿè´£è§£æ Ingress å®šä¹‰çš„è§„åˆ™ï¼Œå¹¶æ ¹æ®è¿™äº›è§„åˆ™å®ç°è¯·æ±‚çš„è½¬å‘ã€‚å¸¸è§çš„ Ingress Controller å®ç°æœ‰ï¼š

- **GCE**ï¼šGoogle äº‘çš„ Ingress Controllerã€‚
- **Ingress-Nginx**ï¼šåŸºäº Nginx çš„å®ç°ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä½¿ç”¨å¹¿æ³›ã€‚
- **HAProxy**ï¼šçŸ¥åçš„é«˜æ€§èƒ½åå‘ä»£ç†è½¯ä»¶ã€‚
- **Envoy**ï¼šåŠŸèƒ½ä¸°å¯Œçš„è¾¹ç¼˜ä»£ç†ï¼Œæ”¯æŒå¤æ‚çš„æµé‡ç®¡ç†ã€‚
- **Traefik**ï¼šé«˜åº¦å¯æ‰©å±•å’Œè‡ªåŠ¨åŒ–çš„åå‘ä»£ç†ã€‚

**Ingress Controller çš„å·¥ä½œåŸç†åŒ…æ‹¬ï¼š**

1. **ç›‘æ§ API Server**ï¼šä»¥ Pod çš„å½¢å¼è¿è¡Œï¼Œå†…éƒ¨åŒ…å« Daemon ç¨‹åºå’Œåå‘ä»£ç†ç¨‹åºï¼ˆå¦‚ Nginxï¼‰ã€‚
2. **åŠ¨æ€ç”Ÿæˆé…ç½®**ï¼šæ ¹æ® Ingress å¯¹è±¡çš„é…ç½®ç”Ÿæˆåå‘ä»£ç†é…ç½®æ–‡ä»¶ã€‚
3. **æ›´æ–°é…ç½®**ï¼šå½“é…ç½®å˜åŒ–æ—¶ï¼Œé‡æ–°åŠ è½½ç¨‹åºä»¥åº”ç”¨æ–°é…ç½®ã€‚

#### 1.2.3 å°ç»“

Ingress å’Œ Ingress Controller çš„å…³ç³»ç±»ä¼¼äºè·¯ç”±å™¨ä¸è·¯ç”±è¡¨ã€‚Ingress å¯¹è±¡å®šä¹‰äº†è¯·æ±‚çš„è½¬å‘è§„åˆ™ï¼Œè€Œ Ingress Controller æ‰§è¡Œè¿™äº›è§„åˆ™ï¼Œæ¥æ”¶å¤–éƒ¨è¯·æ±‚å¹¶å°†å…¶è½¬å‘åˆ°ç›¸åº”çš„ Serviceã€‚Ingress Controller æ˜¯å®ç°æµé‡è½¬å‘çš„æ ¸å¿ƒç»„ä»¶ï¼Œè€Œ Ingress å¯¹è±¡åˆ™æ˜¯æŒ‡å¯¼å…¶æ“ä½œçš„é…ç½®æŒ‡å—ã€‚

### 1.3 Ingress ä»‹ç»

Kubernetes æä¾›äº†ä¸‰ç§æš´éœ²æœåŠ¡çš„æ–¹å¼ï¼šLoadBalancer Serviceã€NodePort Service å’Œ Ingressã€‚Ingress çš„ä¼˜åŠ¿åœ¨äºï¼š

- **è§£å†³ Pod æ¼‚ç§»é—®é¢˜**ï¼šService æä¾›ç¨³å®šçš„ IPï¼Œç¡®ä¿å¤–éƒ¨è®¿é—®çš„ç¨³å®šæ€§ã€‚
- **ç®€åŒ–ç«¯å£ç®¡ç†**ï¼šé€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚ Nginxï¼‰ç›‘å¬å•ä¸€ç«¯å£ï¼Œæ ¹æ®åŸŸåæˆ–è·¯å¾„è§„åˆ™è½¬å‘è¯·æ±‚ã€‚
- **åŠ¨æ€æ›´æ–°é…ç½®**ï¼šé€šè¿‡ Ingress å¯¹è±¡å’Œ Controller å®ç°åŠ¨æ€é…ç½®æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

### 1.4 Ingress Controller

Ingress Controller çš„éƒ¨ç½²å’Œé…ç½®éœ€è¦è€ƒè™‘å…¶è¿è¡Œæ–¹å¼å’Œæš´éœ²æ–¹å¼ï¼Œä»¥ç¡®ä¿é«˜æ•ˆå’Œå¯é ã€‚

#### 1.4.1 éƒ¨ç½²æ–¹å¼

1. **Deployment + LoadBalancer æ¨¡å¼**ï¼šé€‚ç”¨äºå…¬æœ‰äº‘ç¯å¢ƒï¼Œä½¿ç”¨ LoadBalancer Service æš´éœ²ï¼Œå¹¶ç»‘å®šå…¬ç½‘åœ°å€ã€‚
2. **Deployment + NodePort æ¨¡å¼**ï¼šé€‚ç”¨äºå›ºå®šèŠ‚ç‚¹çš„ç¯å¢ƒï¼Œä½¿ç”¨ NodePort æš´éœ²æœåŠ¡ã€‚
3. **DaemonSet + HostNetwork æ¨¡å¼**ï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½² Ingress Controllerï¼Œä¼˜åŒ–ç½‘ç»œæ€§èƒ½ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒã€‚

#### 1.4.2 å·¥ä½œåŸç†

Ingress Controller ç›‘æ§ Kubernetes API Serverï¼Œæ„ŸçŸ¥ Ingressã€Serviceã€Endpointã€Secret ç­‰èµ„æºçš„å˜åŒ–ï¼ŒåŠ¨æ€ç”Ÿæˆåå‘ä»£ç†é…ç½®å¹¶åº”ç”¨æ›´æ–°ã€‚

## äºŒã€åŸç†

### 2.1 Ingress Controller å·¥ä½œåŸç†

Ingress Controller é€šè¿‡ç›‘è§† API Server è·å–ç›¸å…³èµ„æºçš„å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°åå‘ä»£ç†é…ç½®æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ reload åº”ç”¨æ–°é…ç½®ã€‚å…¶å·¥ä½œæµç¨‹åŒ…æ‹¬ï¼š

1. ç›‘æ§ Kubernetes API Server çš„ Ingressã€Serviceã€Endpoint ç­‰èµ„æºã€‚
2. æ ¹æ®èµ„æºå˜åŒ–ç”Ÿæˆæ–°çš„é…ç½®æ–‡ä»¶ã€‚
3. å†™å…¥åå‘ä»£ç†æœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰çš„é…ç½®æ–‡ä»¶ã€‚ 
4. *reload* ä»£ç†æœåŠ¡å™¨ï¼Œä½¿æ–°é…ç½®ç”Ÿæ•ˆã€‚

### 2.2 Nginx åå‘ä»£ç†åŸç†

Nginx-Ingress æ ¹æ® Ingress è§„åˆ™ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œå®ç°åŸºäºåŸŸåæˆ–è·¯å¾„çš„è¯·æ±‚è½¬å‘ã€‚å…¶å·¥ä½œæµç¨‹åŒ…æ‹¬ï¼š

1. ç›‘å¬ä¼ å…¥è¯·æ±‚ï¼Œè§£æåŸŸåå’Œè·¯å¾„ã€‚
2. æ ¹æ®é…ç½®æ–‡ä»¶åŒ¹é…è§„åˆ™ï¼Œå°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„ Serviceã€‚
3. åŠ¨æ€æ›´æ–°é…ç½®æ–‡ä»¶ä»¥åº”å¯¹æœåŠ¡å˜åŒ–ã€‚

## ä¸‰ã€éƒ¨ç½²

```mermaid
flowchart TD
    classDef internet fill:#1e3a8a,color:white,stroke:#000;
    classDef dmz fill:#404040,color:white,stroke-width:2;
    classDef gateway fill:#2563eb,color:white,stroke:#10b981,stroke-width:2;
    classDef controller fill:#10b981,color:black,shape:ellipse;
    classDef service fill:#f97316,color:black;
    classDef realServer fill:#854d0e,color:white;

    Internet(("Internet")):::internet
    DMZ[DMZ/ç½‘å…³ F5/SLB/LVS/HAProxy]:::dmz

    subgraph Kubernetes_HostNetwork[Kubernetes HostNetwork]
        direction TB
        
        subgraph Gateway_Nodes[Gateway Nodes]
            Gateway1["Gateway Node<br>80/443"]:::gateway
            Gateway2["Gateway Node<br>80/443"]:::gateway
            Gateway3["Gateway Node<br>80/443"]:::gateway
            
            Gateway1 -->|TCP 80/443| Controller1(Controller):::controller
            Gateway2 -->|TCP 80/443| Controller2(Controller):::controller
            Gateway3 -->|TCP 80/443| Controller3(Controller):::controller
        end

        Services[Services]:::service

        subgraph Real_Servers[Real Servers]
            RealServer1["Real Server"]:::realServer --> Web1[Web] & Backend1[Backend]
            RealServer2["Real Server"]:::realServer --> Web2[Web] & Backend2[Backend]
        end

        Web1 & Web2 & Backend1 & Backend2 --> Services
        Controller1 -->|æœåŠ¡å‘ç°| Services
        Controller2 -->|æœåŠ¡å‘ç°| Services
        Controller3 -->|æœåŠ¡å‘ç°| Services
    end

    Internet -->|HTTPS 443| DMZ
    DMZ -->|TCPé€ä¼ | Gateway1 & Gateway2 & Gateway3

    linkStyle 6,7,8 stroke:#10b981,stroke-width:2px,dasharray:5
    linkStyle 9 stroke:#f97316,stroke-width:2px
```

æµé‡ç”Ÿå‘½å‘¨æœŸï¼š
1. å¤–éƒ¨è¯·æ±‚é€šè¿‡HTTPS 443è¿›å…¥DMZ
2. F5/SLBè¿›è¡ŒTCPå±‚é€ä¼ 
3. Gateway Nodeå®ŒæˆTLSç»ˆç»“
4. ControlleråŒæ­¥Ingressé…ç½®
5. Servicesæ ¹æ®è·¯ç”±è§„åˆ™è¿›è¡Œè´Ÿè½½å‡è¡¡
6. æœ€ç»ˆæµé‡åˆ†å‘åˆ°å…·ä½“Podå®ä¾‹

### 3.1 éƒ¨ç½²helm

#### 3.1.1 ä¸‹è½½ helmäºŒè¿›åˆ¶åŒ…

```bash
wget https://get.helm.sh/helm-v3.16.3-linux-amd64.tar.gz
tar -zxvf helm-v3.16.3-linux-amd64.tar.gz
mv linux-amd64/heml /usr/local/bin/helm
```

#### 3.1.2 helmæ‹‰å–ingress-nginxé•œåƒ

```bash
# æ·»åŠ å®˜æ–¹ä»“åº“
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

# æŸ¥è¯¢ä»“åº“åˆ—è¡¨
helm repo list

# æ›´æ–°æ‰€æœ‰ä»“åº“
helm repo update

# æœç´¢ ingress-nginx ä»“åº“ä¿¡æ¯
helm search repo ingress-nginx
[root@k8s-master01 ~]# helm search repo ingress-nginx
NAME                       	CHART VERSION	APP VERSION	DESCRIPTION                                       
ingress-nginx/ingress-nginx	4.12.0       	1.12.0     	Ingress controller for Kubernetes using NGINX a...

# æ‹‰å–é•œåƒ
helm pull ingress-nginx/ingress-nginx --version 4.12.0
# è§£å‹
tar -zxvf ingress-nginx-4.12.0.tgz
```

### 3.2 éƒ¨ç½²Ingress-nginx

#### 3.2.1 ä¿®æ”¹Ingress-nginx çš„é›†ç¾¤é…ç½®æ–‡ä»¶

##### a) ä¸‹è½½é•œåƒ

æå‰ä¸‹è½½é…ç½®æ–‡ä»¶ä¸­çš„å›½å¤–å®˜æ–¹é•œåƒï¼Œæˆ–è€…ä¿®æ”¹åç§°ä¸ºå›½å†…åœ°å€çš„é•œåƒ

```bash
vim values.yaml
#å®Œæ•´é•œåƒåç§°æ‹¼æ¥ï¼Œå…±æœ‰ä¸‰ä¸ªé•œåƒ
image: registry.k8s.io/ingress-nginx/controller:v1.12.0
image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.5.0
image: registry.k8s.io/defaultbackend-amd64:1.5
---------------------------------------------------------------------------------------------------------------------
# ä½¿ç”¨é˜¿é‡Œäº‘ä¸‹è½½é•œåƒ
ctr -n k8s.io images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:v1.12.0
ctr -n k8s.io images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:v1.12.0 registry.k8s.io/ingress-nginx/controller:v1.12.0


ctr -n k8s.io images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:v1.5.0
ctr -n k8s.io images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:v1.5.0 registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.5.0


ctr -n k8s.io images pull registry.cn-hangzhou.aliyuncs.com/xusx/images:1.5
ctr -n k8s.io images tag registry.cn-hangzhou.aliyuncs.com/xusx/images:1.5 registry.k8s.io/defaultbackend-amd64:1.5
```

![image-20250325151343588](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250325151343588.png)

##### b) é•œåƒçš„ digest å€¼æ³¨é‡Š

```bash
sed -i 's/^\s*digest/#&/' values.yaml


[root@k8s-master01 ingress-nginx]# cat values.yaml |grep digest
#    digest: sha256:e6b8de175acda6ca913891f0f727bca4527e797d52688cbe9fec9040d6f6b6fa
#    digestChroot: sha256:87c88e1c38a6c8d4483c8f70b69e2cca49853bb3ec3124b9b1be648edf139af3
  #     digest: ""
#        digest: sha256:aaafd456bda110628b2d4ca6296f38731a3aaf0bf7581efae824a41c770a8fc4
```



**åŸå› **ï¼šdigest å€¼ç”¨äºæŒ‡å®šé•œåƒçš„å”¯ä¸€å“ˆå¸Œå€¼ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¸éœ€è¦ä½¿ç”¨ digest å€¼ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨æ ‡ç­¾æ¥æ‹‰å–é•œåƒã€‚å¦‚æœä½¿ç”¨å†…ç½‘é•œåƒä»“åº“ä¸”é•œåƒç‰ˆæœ¬ä¸è¯¾ç¨‹ä¸­ä¸ä¸€è‡´ï¼Œå¯èƒ½éœ€è¦æ³¨é‡Šæ‰ digest å€¼ï¼Œä»¥ä¾¿æ­£ç¡®æ‹‰å–é•œåƒã€‚

##### c) hostNetwork è®¾ç½®ä¸º true

```bash
# æŸ¥çœ‹HostNetworkç­–ç•¥
grep -Ev '^\s*(#|$)' values.yaml |grep hostNetwork
  hostNetwork: false

æ›´æ”¹ä¸º true

sed -i 's/hostNetwork: false/hostNetwork: true/g' values.yaml
```

**åŸå› **ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šè·³è¿‡ Kubernetes çš„è™šæ‹Ÿç½‘ç»œå±‚ï¼Œå‡å°‘ NAT è½¬æ¢ï¼Œé™ä½å»¶è¿Ÿã€‚
- **ç«¯å£å ç”¨**ï¼šç›´æ¥ç»‘å®šå®¿ä¸»æœºçš„ `80/443` ç«¯å£ï¼Œæ–¹ä¾¿å¤–éƒ¨æµé‡ç›´è¾¾ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒçš„é«˜æ€§èƒ½éœ€æ±‚ï¼Œä½†éœ€ç¡®ä¿å®¿ä¸»æœºç«¯å£æœªè¢«å ç”¨ã€‚

##### d) dnsPolicy è®¾ç½®ä¸º ClusterFirstWithHostNet

```bash
controller:
  dnsPolicy: ClusterFirstWithHostNet  # å…¼å®¹ hostNetwork çš„ DNS ç­–ç•¥
  
# æ›´æ”¹dnsPolicy
sed -i 's/dnsPolicy: ClusterFirst/dnsPolicy: ClusterFirstWithHostNet/g' values.yaml
```

**åŸå› **ï¼š

- **DNS è§£æå…¼å®¹æ€§**ï¼šå½“ä½¿ç”¨ `hostNetwork` æ—¶ï¼ŒPod é»˜è®¤ä½¿ç”¨å®¿ä¸»æœºçš„ DNS é…ç½®ï¼ˆå¦‚ `/etc/resolv.conf`ï¼‰ï¼Œä½†æ­¤è®¾ç½®å…è®¸åŒæ—¶ä½¿ç”¨ Kubernetes é›†ç¾¤çš„ DNSï¼ˆå¦‚ CoreDNSï¼‰ï¼Œè§£å†³æœåŠ¡å‘ç°é—®é¢˜ã€‚

##### e) NodeSelector æ·»åŠ  ingress: "true"éƒ¨ç½²è‡³æŒ‡å®šèŠ‚ç‚¹,æœ‰ä¸‰ä¸ª nodeSelector

```bash
controller:
  nodeSelector:
    ingress: "true"  # ä»…éƒ¨ç½²åˆ°å¸¦æ­¤æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œæ˜¯å­—ç¬¦ä¸²å¹¶éå¸ƒå°”å€¼ï¼Œæ‰€ä»¥éœ€è¦æ·»åŠ åŒå¼•å·	
```

![image-20250325224932546](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250325224932546.png)

**åŸå› **ï¼š

- **èµ„æºéš”ç¦»**ï¼šå°† Ingress Controller å›ºå®šåˆ°ä¸“ç”¨èŠ‚ç‚¹ï¼Œé¿å…ä¸å…¶ä»–æœåŠ¡ç«äº‰èµ„æºã€‚

- éƒ¨ç½²æ§åˆ¶ï¼šé€šè¿‡æ ‡ç­¾é€‰æ‹©èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼š

  ```Bash
  kubectl label node <node-name> ingress=true
  ```

##### f) ç±»å‹æ›´æ”¹ä¸º kind: DaemonSet

```yaml
controller:
  kind: DaemonSet  # æ›¿ä»£é»˜è®¤çš„ Deployment
```

![image-20250325230243963](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250325230243963.png)

**åŸå› **ï¼š

- **é«˜å¯ç”¨æ€§**ï¼šç»“åˆNodeSelector å®Œæˆç¬¦åˆæ ‡ç­¾çš„æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²ä¸€ä¸ªå®ä¾‹ï¼Œé¿å…å•ç‚¹æ•…éšœã€‚
- **æµé‡å‡è¡¡**ï¼šé…åˆ `hostNetwork`ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç›´æ¥æ¥æ”¶æµé‡ï¼Œæ— éœ€é¢å¤–è´Ÿè½½å‡è¡¡å™¨ã€‚
- **èµ„æºæ¶ˆè€—**ï¼šéœ€æƒè¡¡èŠ‚ç‚¹æ•°é‡å’Œèµ„æºå ç”¨ï¼Œé€‚åˆå¤§è§„æ¨¡é›†ç¾¤ã€‚

##### g) å°† ingress nginx è®¾ç½®ä¸ºé»˜è®¤çš„ ingressClass

```Yaml
controller:
  ingressClassResource:
    name: nginx
    default: true  # è®¾ä¸ºé»˜è®¤ IngressClass
```

![image-20250325230436749](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250325230436749.png)

**åŸå› **ï¼š

- **ç®€åŒ–é…ç½®**ï¼šåˆ›å»º Ingress èµ„æºæ—¶æ— éœ€æ˜¾å¼æŒ‡å®š `ingressClassName`ã€‚
- **ç»Ÿä¸€å…¥å£**ï¼šç¡®ä¿æ‰€æœ‰æœªæŒ‡å®š Class çš„ Ingress è§„åˆ™ç”±è¯¥ Controller å¤„ç†ã€‚

##### h)éƒ¨ç½² ingressï¼Œç»™éœ€è¦éƒ¨ç½² ingress çš„èŠ‚ç‚¹ä¸Šæ‰“æ ‡ç­¾

```bash
# node2 èŠ‚ç‚¹æ‰“ä¸Šæ ‡ç­¾
kubectl label node k8s-master01 ingress=true
# node2 èŠ‚ç‚¹åˆ é™¤æ ‡ç­¾(éå¿…è¦)
# kubectl label node k8s-master01 ingress-
# æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹çš„æ ‡ç­¾
kubectl get nodes --show-labels

#å»é™¤æ±¡ç‚¹
kubectl taint nodes k8s-master01 node-role.kubernetes.io/control-plane:NoSchedule-
```

![image-20250325230751235](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250325230751235.png)

#### 3.2.2 ä½¿ç”¨helmå®‰è£… Ingress-ngixn

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create ns ingress-nginx

# å®‰è£…
helm install ingress-nginx -n ingress-nginx .
# å¸è½½
helm uninstall ingress-nginx -n ingress-nginx
# æŸ¥çœ‹å®‰è£…ä¿¡æ¯
kubectl get po -n ingress-nginx -o wide

[root@k8s-master01 ~]# kubectl get po -n ingress-nginx -o wide
NAME                             READY   STATUS    RESTARTS   AGE   IP              NODE           NOMINATED NODE   READINESS GATES
ingress-nginx-controller-v2n88   1/1     Running   0          25s   192.168.0.105   k8s-master01   <none>           <none>
```



## å››ã€Ingress-Nginxä½¿ç”¨

### 4.1.Ingress-nginx å…¥é—¨ä½¿ç”¨

#### 4.1.1 åˆ›å»ºæ¨¡æ‹Ÿç¯å¢ƒ

åˆ›å»ºä¸€ä¸ªç”¨äºå­¦ä¹  Ingress çš„ Namespaceï¼Œä¹‹åæ‰€æœ‰çš„æ“ä½œéƒ½åœ¨æ­¤ Namespace è¿›è¡Œï¼š

```bash
kubectl create ns study-ingress
```

åˆ›å»ºä¸€ä¸ªnginxæ¨¡æ‹ŸæœåŠ¡,å¹¶ç”¨svcè¿›è¡Œæš´éœ²ç«¯å£

```bash
kubectl create deploy nginx --image=m.daocloud.io/docker.io/library/nginx:latest -n study-ingress

# å°†åä¸º nginx çš„ Deployment æš´éœ²ä¸ºä¸€ä¸ª Kubernetes Serviceï¼Œç›‘å¬ç«¯å£ 80ã€‚
kubectl expose deploy nginx --port 80 -n study-ingress
```

åˆ›å»º Ingress æŒ‡å‘ä¸Šé¢åˆ›å»ºçš„ Service

```yaml
vim web-ingress.yaml 
apiVersion: networking.k8s.io/v1     # æŒ‡å®šä½¿ç”¨çš„ Kubernetes API ç‰ˆæœ¬ï¼ˆnetworking.k8s.io/v1ï¼‰ã€‚
kind: Ingress                       # å®šä¹‰è¿™æ˜¯ä¸€ä¸ª Ingress èµ„æºã€‚
metadata:
  name: nginx-ingress                # Ingress çš„åç§°ã€‚
  namespace: study-ingress            # Ingress æ‰€åœ¨çš„å‘½åç©ºé—´ã€‚
spec:
  rules:
  - host: nginx.test.com              # åŒ¹é…çš„åŸŸåï¼Œæ‰€æœ‰è¯·æ±‚å°†è·¯ç”±åˆ°è¯¥åŸŸåæŒ‡å®šçš„åç«¯æœåŠ¡ã€‚
    http:
      paths:
      - backend:                     # å®šä¹‰åç«¯æœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚
          service:                   # æŒ‡å®šåç«¯æœåŠ¡çš„ç±»å‹ã€‚
            name: nginx              # åç«¯æœåŠ¡çš„åç§°ã€‚
            port:                    # åç«¯æœåŠ¡çš„ç«¯å£å·ã€‚
              number: 80             # æŒ‡å®šåç«¯æœåŠ¡çš„ç«¯å£å·ä¸º 80ã€‚
        path: /                       # å®šä¹‰åŒ¹é…çš„è·¯å¾„ï¼Œ/ è¡¨ç¤ºåŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„ã€‚
        pathType: ImplementationSpecific # å®šä¹‰è·¯å¾„åŒ¹é…çš„ç±»å‹ï¼ŒImplementationSpecific è¡¨ç¤ºä½¿ç”¨ Ingress Controller çš„ç‰¹å®šå®ç°æ–¹å¼ã€‚
        
        
kubectl create -f  web-ingress.yaml     
```

pathType: æŒ‡å®šè¯·æ±‚è·¯å¾„çš„åŒ¹é…æ–¹å¼ï¼Œå†³å®šIngresså¦‚ä½•å°†è¯·æ±‚è·¯ç”±åˆ°åç«¯æœåŠ¡

- **Exact**ï¼šè¡¨ç¤ºåªèƒ½ç²¾ç¡®åŒ¹é…æŒ‡å®šçš„è·¯å¾„ã€‚
- **Prefix**ï¼šè¡¨ç¤ºåŒ¹é…ä»¥æŒ‡å®šè·¯å¾„å¼€å¤´çš„æ‰€æœ‰è¯·æ±‚è·¯å¾„ã€‚
- **ImplementationSpecific**ï¼šè¡¨ç¤ºè·¯å¾„åŒ¹é…æ–¹å¼ç”± Ingress Controller çš„å…·ä½“å®ç°å†³å®šã€‚

#### 4.1.2 è®¿é—®éªŒè¯

**é…ç½®éªŒè¯ï¼š**

è¿›å…¥ingress-nginx å®¹å™¨å†…å‘ç°ï¼Œå·²ç»è‡ªåŠ¨å¯¹åˆšåˆšåˆ›å»ºçš„ ingressæ·»åŠ äº†é…ç½®ä¿¡æ¯ã€‚

```bash
[root@k8s-master01 templates]# kubectl get po -n ingress-nginx
NAME                             READY   STATUS    RESTARTS       AGE
ingress-nginx-controller-v2n88   1/1     Running   8 (127m ago)   10h
[root@k8s-master01 templates]# kubectl get ingress -n study-ingress
NAME            CLASS   HOSTS            ADDRESS   PORTS   AGE
nginx-ingress   nginx   nginx.test.com             80      6m50s
[root@k8s-master01 templates]# kubectl exec -it ingress-nginx-controller-v2n88 -n ingress-nginx -- bash
k8s-master01:/etc/nginx$ grep "nginx.test.com" nginx.conf
	## start server nginx.test.com
		server_name nginx.test.com ;
	## end server nginx.test.com
```

![image-20250326105539278](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326105539278.png)

**è®¿é—®éªŒè¯ï¼š**

æˆ‘ä»¬çš„ Ingress éƒ¨ç½²åœ¨ k8s-master-01 ä¸Šé¢ï¼Œç”¨çš„æ˜¯hostNetworkï¼Œæ‰€ä»¥æˆ‘ä»¬æœ¬åœ°åšä¸‹hostsè§£æè®¿é—®å³å¯ï¼Œæˆ–è€…ä½¿ç”¨curl 

```bash
curl -H "Host:nginx.test.com" 192.168.0.105
```

![image-20250326111043349](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326111043349.png)

![image-20250326110623590](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326110623590.png)

#### 4.1.3 æ—¥å¿—æŸ¥çœ‹

æŸ¥çœ‹æˆ‘ä»¬çš„å‰ç«¯æœåŠ¡æ—¥å¿—

```bash
kubectl logs -f deploy/nginx -n study-ingress
```

![image-20250326111255755](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326111255755.png)

------

### 4.2 åŸŸåé‡å®šå‘ Redirect 

åœ¨ Nginx ä½œä¸ºä»£ç†æœåŠ¡å™¨æ—¶ï¼ŒRedirect å¯ç”¨äºåŸŸåçš„é‡å®šå‘ï¼Œæ¯”å¦‚è®¿é—® old.com è¢«é‡å®šå‘åˆ°new.comã€‚Ingress å¯ä»¥æ›´ç®€å•çš„å®ç° Redirect åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥ç”¨ nginx.redirect.com ä½œä¸ºæ—§åŸŸåï¼Œbaidu.com ä½œä¸ºæ–°åŸŸåè¿›è¡Œæ¼”ç¤ºï¼š

åœ¨å®é™…å·¥ä½œä¸­ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„ï¼Œæ¯”å¦‚å…¬å¸æŸåŸŸåå†³å®šä¸å†ä½¿ç”¨æ›´æ¢ä¸ºæ–°åŸŸåï¼Œä½†æ˜¯æ—§åŸŸåä»ç„¶æœ‰ç”¨æˆ·è®¿é—®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è®¾ç½®åŸŸåé‡å®šå‘ï¼Œç­‰åˆ°ä¸€æ®µæ—¶é—´åï¼Œæ—§çš„åŸŸåå½»åº•æ²¡æœ‰ç”¨æˆ·è®¿é—®çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨å®Œå…¨æŠ›å¼ƒã€‚

**[å®˜æ–¹è¯¦ç»†ä»‹ç»æ–‡æ¡£](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/)**

```yaml
vim redirect.yaml 

apiVersion: networking.k8s.io/v1  # APIç‰ˆæœ¬
kind: Ingress  # èµ„æºç±»å‹ï¼šIngress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com  # æ°¸ä¹…é‡å®šå‘åˆ°ç™¾åº¦
    #nginx.ingress.kubernetes.io/permanent-redirect-code: '301'  # å¯é€‰ï¼šè®¾ç½®é‡å®šå‘çŠ¶æ€ç 
  name: nginx-redirect  # èµ„æºåç§°
  namespace: study-ingress  # æ‰€åœ¨å‘½åç©ºé—´
spec:
  rules:  # è·¯ç”±è§„åˆ™
    - host: nginx.old.com  # åŒ¹é…çš„åŸŸå
      http:
        paths:
          - backend:
              service:
                name: nginx  # åç«¯æœåŠ¡åç§°
                port:
                  number: 80  # åç«¯æœåŠ¡ç«¯å£
            path: /  # åŒ¹é…æ‰€æœ‰è·¯å¾„
            pathType: ImplementationSpecific  # è·¯å¾„åŒ¹é…ç±»å‹
```

**`nginx.ingress.kubernetes.io/permanent-redirect`**

- è¿™ä¸ªæ³¨è§£æŒ‡ç¤º Nginx Ingress æ§åˆ¶å™¨å°†æ‰€æœ‰åŒ¹é…åˆ°çš„è¯·æ±‚æ°¸ä¹…é‡å®šå‘åˆ° `https://www.baidu.com`ã€‚å¦‚æœä½ å¸Œæœ›è¿”å›ä¸åŒçš„çŠ¶æ€ç ï¼ˆæ¯”å¦‚ `302` ä¸´æ—¶é‡å®šå‘ï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ `nginx.ingress.kubernetes.io/permanent-redirect-code` æ¥è®¾ç½®çŠ¶æ€ç ã€‚

```bash
kubectl create -f redirect.yaml 

curl -I -H "Host:nginx.old.com" 192.168.0.105
```

![image-20250326143940715](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326143940715.png)

### 4.3 å‰åç«¯åˆ†ç¦» Rewrite 

ç°ä»£ Web åº”ç”¨ä¸­ï¼Œå‰ç«¯å’Œåç«¯é€šå¸¸ä¼šåˆ†åˆ«æ‰˜ç®¡åœ¨ä¸åŒçš„æœåŠ¡ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨ä¸åŒçš„è·¯å¾„æ¥è®¿é—®ã€‚å‰ç«¯åº”ç”¨é€šå¸¸é€šè¿‡åŸŸåæ ¹è·¯å¾„ï¼ˆ`/`ï¼‰è¿›è¡Œè®¿é—®ï¼Œè€Œåç«¯æœåŠ¡åˆ™ä½¿ç”¨ç±»ä¼¼ `/api-a`ã€`/api-b` æˆ– `/api/payapi` è¿™æ ·çš„è·¯å¾„æ¥æä¾› API æœåŠ¡ã€‚ç„¶è€Œï¼Œå®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå‰ç«¯å’Œåç«¯å¯èƒ½ä¼šå…±äº«ç›¸åŒçš„æ ¹è·¯å¾„ `/`ï¼Œè¿™æ—¶å°±éœ€è¦é€šè¿‡ä»£ç†å’Œè·¯å¾„é‡å†™æ¥åŒºåˆ†å®ƒä»¬ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾åç«¯æœåŠ¡æ²¡æœ‰å•ç‹¬çš„è·¯å¾„è§„åˆ™ï¼Œè€Œæ˜¯é»˜è®¤ä½¿ç”¨ `/` è·¯å¾„æä¾›æœåŠ¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå½“å‰ç«¯å’Œåç«¯éƒ½ä½¿ç”¨ç›¸åŒçš„è·¯å¾„ï¼ˆå¦‚ `/`ï¼‰æ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡è·¯å¾„é‡å†™å°†è¯·æ±‚é‡å®šå‘åˆ°ä¸åŒçš„æœåŠ¡ã€‚Nginx Ingress æ§åˆ¶å™¨æä¾›äº†å¾ˆå¥½çš„è·¯å¾„é‡å†™åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡é…ç½®å°†è®¿é—® `/api-a` çš„è¯·æ±‚è½¬å‘åˆ°åç«¯çš„æ ¹è·¯å¾„ `/` ä¸Šï¼Œä»è€Œå®Œæˆè¯·æ±‚çš„æ­£ç¡®è½¬å‘ã€‚

![image-20250327000350854](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250327000350854.png)

è¿™ä¸ªåœ¨ingress-nginxä¸­æ˜¯å¾ˆå¥½å®ç°çš„æ•ˆæœï¼Œé€šè¿‡Rewrite é‡å†™åœ°å€ï¼Œå°†ç”¨æˆ·è¦è®¿é—®çš„/api-a è½¬å‘åˆ°åç«¯çš„ / è·¯å¾„ä¸Šå³å¯å®ŒæˆæœåŠ¡çš„è®¿é—®

#### 4.3.1 åˆ›å»ºæ¨¡æ‹Ÿç¯å¢ƒ

åˆ›å»ºä¸€ä¸ªåº”ç”¨æ¨¡æ‹Ÿåç«¯æœåŠ¡å¹¶æš´éœ²æœåŠ¡ç«¯å£

```bash
kubectl create deploy backend-api --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:backend-api -n study-ingress

kubectl expose deploy backend-api --port 80 -n study-ingress
```

æŸ¥çœ‹svcçš„IPï¼Œè®¿é—®æµ‹è¯•

```bash
kubectl get svc,deploy -n study-ingress
curl 10.96.126.118/api-a
```

![image-20250326163234304](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326163234304.png)

é€šè¿‡ Ingress Nginx çš„ Rewrite åŠŸèƒ½ï¼Œå°†/api-a é‡å†™ä¸ºâ€œ/â€ï¼Œé…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š
```yaml
vim rewrite.yaml

apiVersion: networking.k8s.io/v1  # æŒ‡å®š Kubernetes ç½‘ç»œèµ„æº API ç‰ˆæœ¬
kind: Ingress  # å®šä¹‰èµ„æºç±»å‹ä¸º Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2  # Nginx è·¯å¾„é‡å†™è§„åˆ™ï¼Œå°†/api-aæ›¿æ¢ä¸º/
  name: backend-api  # Ingress åç§°
  namespace: study-ingress  # æ‰€å±å‘½åç©ºé—´
spec:
  rules:
    - host: nginx.test.com  # è¯·æ±‚ä¸»æœºåä¸º nginx.test.com
      http:
        paths:
          - backend:  # è¯·æ±‚è½¬å‘åˆ°åç«¯æœåŠ¡
              service:
                name: backend-api  # åç«¯æœåŠ¡åç§°
                port:
                  number: 80  # åç«¯æœåŠ¡ç«¯å£
            path: /api-a(/|$)(.*)  # åŒ¹é…æ‰€æœ‰ `/api-a` æˆ– `/api-a/` åçš„è¯·æ±‚è·¯å¾„ï¼Œäº¤ç»™annotationsè¿›è¡Œé‡å†™
            pathType: ImplementationSpecific  # ä½¿ç”¨ Ingress æ§åˆ¶å™¨ç‰¹å®šçš„è·¯å¾„åŒ¹é…
```

- `nginx.ingress.kubernetes.io/rewrite-target: /\$2`ï¼šé‡å†™è§„åˆ™ï¼Œå°† `/api-a` è½¬å‘ä¸º `/`ï¼Œå¹¶ä¿ç•™ `/api-a` åçš„è·¯å¾„éƒ¨åˆ†ï¼ˆé€šè¿‡ `\$2` æ•è·ç»„ï¼‰ã€‚
- `path: /api-a(/|$)(.*)`ï¼šåŒ¹é…æ‰€æœ‰ `/api-a` æˆ– `/api-a/` åçš„è¯·æ±‚è·¯å¾„ã€‚

#### 4.3.2 è®¿é—®éªŒè¯

```bash
[root@k8s-master01 templates]# kubectl create -f rewrite.yaml 
ingress.networking.k8s.io/backend-api created
```

 å†æ¬¡è®¿é—® nginx.test.com/api-a å³å¯è®¿é—®åˆ°åç«¯æœåŠ¡ï¼š

è®¿é—®æˆåŠŸåˆ°åé¢é¡µé¢ï¼Œé‚£ä¹ˆè¿™æ ·å°±å®Œæˆäº†å‰ç«¯é¡µé¢å’Œåç«¯é¡µé¢çš„åˆ†ç¦»

![image-20250326235510085](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250326235510085.png)

### 4.4 é”™è¯¯ä»£ç é‡å®šå‘ 

#### 4.4.1 é€šè¿‡ Helm è¿›è¡Œæ›´æ”¹

ä¿®æ”¹ values.yaml ï¼Œæ›´æ–° ConfigMapï¼š

![image-20250327145913783](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250327145913783.png)

```yaml
  config: 
    apiVersion: v1
    client_max_body_size: 20m
    custom-http-errors: "404,415,503"
```

![image-20250327150138666](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250327150138666.png)

æ›´æ–° Release, æ›´æ–°å Pod ä¼šè‡ªåŠ¨é‡å¯ï¼Œå¹¶ä¸”ä¼šåˆ›å»ºä¸€ä¸ª defaultbackendï¼š

```bash
helm upgrade ingress-nginx -n ingress-nginx .

[root@k8s-master01 ingress-nginx]# kubectl get po -n ingress-nginx
NAME                                           READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-lzn4w                 1/1     Running   0          14m
ingress-nginx-defaultbackend-98848f6d7-jljqt   1/1     Running   0          14m
```

#### 4.4.2 è®¿é—®éªŒè¯

æ›´æ–°å®Œæˆä»¥åè®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢ï¼Œæ¯”å¦‚ä¹‹å‰å®šä¹‰çš„ nginx.test.comã€‚è®¿é—®ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢ 123ï¼Œå°±ä¼šè·³è½¬åˆ° Error Server ä¸­çš„é¡µé¢ï¼š

![image-20250327153020259](./images/6.Ingress%E6%9C%8D%E5%8A%A1%E5%8F%91%E5%B8%83/image-20250327153020259.png)





### 4.5 åŒ¹é…è¯·æ±‚å¤´ 

#### 4.5.1 åˆ›å»ºæ¨¡æ‹Ÿç¯å¢ƒ

éƒ¨ç½²ç§»åŠ¨ç«¯åº”ç”¨ï¼š

```bash
kubectl create deploy phone --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:phone -n study-ingress

kubectl expose deploy phone --port 80 -n study-ingress

kubectl create ingress phone --rule=m.test.com/*=phone:80 -n study-ingress
```

éƒ¨ç½²ç”µè„‘ç«¯åº”ç”¨ï¼š

```bash
kubectl create deploy laptop --image=registry.cnbeijing.aliyuncs.com/dotbalo/nginx:laptop -n study-ingress

kubectl expose deploy laptop --port 80 -n study-ingress

kubectl get po -n study-ingress -l app=laptop
```

åˆ›å»ºç”µè„‘ç«¯çš„ Ingressï¼Œæ³¨æ„ Ingress annotations çš„ nginx.ingress.kubernetes.io/serversnippet é…ç½®ã€‚Snippet é…ç½®æ˜¯ä¸“é—¨ç”¨äºä¸€äº›å¤æ‚çš„ Nginx é…ç½®ï¼Œå’Œ Nginx é…ç½®é€šç”¨ã€‚åŒ¹é…ç§»åŠ¨ç«¯
å®ä¾‹å¦‚ä¸‹ï¼š

```yaml
# vim laptop-ingress.yaml
apiVersion: networking.k8s.io/v1  # æŒ‡å®šKubernetes APIç‰ˆæœ¬
kind: Ingress                     # èµ„æºç±»å‹ä¸ºIngress
metadata:
  annotations:                    # æ³¨è§£é…ç½®åŒºåŸŸ
    nginx.ingress.kubernetes.io/server-snippet: |  # æ³¨å…¥è‡ªå®šä¹‰Nginxé…ç½®ç‰‡æ®µ
      set $agentflag 0;          # å®šä¹‰å˜é‡ç”¨äºè®¾å¤‡æ£€æµ‹
      if ($http_user_agent ~* "(Android|iPhone|Windows Phone|UC|Kindle)" ){  # æ­£åˆ™åŒ¹é…ç§»åŠ¨è®¾å¤‡UA
        set $agentflag 1;        # æ£€æµ‹åˆ°ç§»åŠ¨è®¾å¤‡æ—¶è®¾ç½®æ ‡è®°
      }
      if ( $agentflag = 1 ) {    # åˆ¤æ–­è®¾å¤‡æ ‡è®°
        return 301 http://m.test.com;  # æ‰§è¡Œ301é‡å®šå‘åˆ°ç§»åŠ¨ç«¯åŸŸå
      }
  name: laptop                   # Ingressèµ„æºåç§°
  namespace: study-ingress      # æ‰€å±å‘½åç©ºé—´
spec:
  ingressClassName: nginx		 # æŒ‡å®šä½¿ç”¨nginxç±»å‹çš„Ingressæ§åˆ¶å™¨ 
  rules:                         # è·¯ç”±è§„åˆ™å®šä¹‰
  - host: test.com               # åŒ¹é…çš„åŸŸå
    http:
      paths:
      - backend:                 # åç«¯æœåŠ¡é…ç½®
          service:
            name: laptop         # å…³è”çš„Serviceåç§°
            port:
              number: 80         # Serviceæš´éœ²çš„ç«¯å£
        path: /                  # åŒ¹é…æ ¹è·¯å¾„
        pathType: ImplementationSpecific  # è·¯å¾„åŒ¹é…æ–¹å¼ï¼ˆç”±Ingressæ§åˆ¶å™¨å®ç°å†³å®šï¼‰
```

**ä¸»è¦åŠŸèƒ½è¯´æ˜ï¼š**

1. è®¾å¤‡æ£€æµ‹é‡å®šå‘ï¼šé€šè¿‡ Nginx çš„`$http_user_agent`æ£€æµ‹ç§»åŠ¨ç«¯è®¾å¤‡ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç§»åŠ¨ç«¯åŸŸå
2. åŸºç¡€è·¯ç”±é…ç½®ï¼šå°†æ‰€æœ‰`test.com`åŸŸåçš„è¯·æ±‚è·¯ç”±åˆ°`laptop`æœåŠ¡çš„ 80 ç«¯å£
3. ä½¿ç”¨`ImplementationSpecific`è·¯å¾„ç±»å‹ï¼Œç”± Ingress æ§åˆ¶å™¨å†³å®šå…·ä½“åŒ¹é…é€»è¾‘

#### 4.5.2 è®¿é—®éªŒè¯

éªŒè¯æ–¹æ³•ï¼š

```bash
# æ¡Œé¢ç«¯è®¿é—®æµ‹è¯•
curl -H "Host: test.com" http://192.168.0.105/

# ç§»åŠ¨ç«¯æ¨¡æ‹Ÿè®¿é—®
curl -A "iPhone" -H "Host: test.com" http://192.168.0.105/ -I
# åº”è¿”å›301é‡å®šå‘åˆ°m.test.com
```



ä»¥ä¸‹æ˜¯åŸºäºä½ æä¾›çš„å‚è€ƒå†…å®¹ï¼Œä¸ºä½ çš„ Ingress æ–‡æ¡£æ–°å¢çš„â€œ4.6 é‡‘ä¸é›€å‘å¸ƒå’Œç°åº¦å‘å¸ƒâ€éƒ¨åˆ†ã€‚æˆ‘å·²å°†å…¶æ•´ç†ä¸ºä¸ç°æœ‰æ–‡æ¡£é£æ ¼ä¸€è‡´çš„æ ¼å¼ï¼Œå¹¶ç¡®ä¿å†…å®¹æ¸…æ™°ã€é€»è¾‘è¿è´¯ã€‚å¦‚æœéœ€è¦è¿›ä¸€æ­¥è°ƒæ•´ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼

---

### 4.6 é‡‘ä¸é›€å‘å¸ƒå’Œç°åº¦å‘å¸ƒ

#### ğŸ¦œé‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Releaseï¼‰ä»‹ç»

é‡‘ä¸é›€å‘å¸ƒçš„åå­—æ¥æºäºçŸ¿äº•ä¸­çš„â€œé‡‘ä¸é›€é¢„è­¦â€ï¼šçŸ¿å·¥ä»¬ä¼šå¸¦ä¸€åªé‡‘ä¸é›€ä¸‹çŸ¿äº•ï¼Œå¦‚æœæœ‰æ¯’æ°”ï¼Œé‡‘ä¸é›€ä¼šå…ˆæ­»æ‰ï¼Œä»è€Œè­¦å‘ŠçŸ¿å·¥ä»¬æ’¤ç¦»ã€‚åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œé‡‘ä¸é›€å‘å¸ƒæ˜¯ä¸€ç§é€æ­¥éƒ¨ç½²æ–°ç‰ˆæœ¬çš„ç­–ç•¥ï¼Œç›®çš„æ˜¯åœ¨å°èŒƒå›´å†…æµ‹è¯•æ–°åŠŸèƒ½æˆ–æ›´æ–°ï¼Œé™ä½é£é™©ã€‚

- **æ€ä¹ˆåš**ï¼šæ–°ç‰ˆæœ¬çš„ä»£ç æˆ–åŠŸèƒ½å…ˆéƒ¨ç½²åˆ°ä¸€å°éƒ¨åˆ†ç”¨æˆ·æˆ–æœåŠ¡å™¨ä¸Šï¼ˆæ¯”å¦‚1%çš„ç”¨æˆ·æˆ–å‡ å°æœåŠ¡å™¨ï¼‰ï¼Œè€Œå…¶ä»–ç”¨æˆ·ä»ç„¶ä½¿ç”¨æ—§ç‰ˆæœ¬ã€‚
- **ç›®çš„**ï¼šé€šè¿‡ç›‘æ§è¿™éƒ¨åˆ†â€œå°ç™½é¼ â€çš„ä½¿ç”¨æƒ…å†µï¼ˆå¦‚é”™è¯¯ç‡ã€æ€§èƒ½æŒ‡æ ‡ç­‰ï¼‰ï¼Œæ¥åˆ¤æ–­æ–°ç‰ˆæœ¬æ˜¯å¦ç¨³å®šã€‚
- **å¦‚æœæˆåŠŸ**ï¼šé€æ­¥æ‰©å¤§éƒ¨ç½²èŒƒå›´ï¼Œæœ€ç»ˆè¦†ç›–æ‰€æœ‰ç”¨æˆ·ã€‚
- **å¦‚æœå¤±è´¥**ï¼šå¿«é€Ÿå›æ»šåˆ°æ—§ç‰ˆæœ¬ï¼Œé¿å…å½±å“å¤§å¤šæ•°ç”¨æˆ·ã€‚

**ä¾‹å­**ï¼šå‡è®¾ä½ å¼€å‘äº†ä¸€ä¸ªç½‘ç«™ï¼Œæ–°ç‰ˆæœ¬åŠ äº†ä¸ªåŠŸèƒ½ã€‚ä½ å…ˆè®©1%çš„ç”¨æˆ·çœ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œè§‚å¯Ÿ24å°æ—¶ã€‚å¦‚æœæ²¡é—®é¢˜ï¼Œå°±æ¨å¹¿åˆ°10%ã€50%ï¼Œæœ€å100%ã€‚

#### ğŸ“–ç°åº¦å‘å¸ƒï¼ˆGrayscale Releaseï¼‰ä»‹ç»

ç°åº¦å‘å¸ƒå’Œé‡‘ä¸é›€å‘å¸ƒæœ‰ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†ä¾§é‡ç‚¹ç¨æœ‰ä¸åŒã€‚ç°åº¦å‘å¸ƒæ›´å¼ºè°ƒâ€œç”¨æˆ·åˆ†å±‚â€æˆ–â€œé€æ­¥æ”¾é‡â€ï¼Œæ˜¯ä¸€ç§æ›´å¹¿ä¹‰çš„æ§åˆ¶æ€§å‘å¸ƒæ–¹å¼ã€‚

- **æ€ä¹ˆåš**ï¼šå°†æ–°ç‰ˆæœ¬é€æ­¥æ¨é€ç»™ç‰¹å®šç”¨æˆ·ç¾¤ä½“ï¼ˆæ¯”å¦‚æŒ‰åœ°åŒºã€è®¾å¤‡ç±»å‹ã€ç”¨æˆ·IDç­‰ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§æ¨é€ç»™æ‰€æœ‰äººã€‚
- **ç›®çš„**ï¼šé€šè¿‡æ§åˆ¶å˜é‡ï¼Œè§‚å¯Ÿæ–°ç‰ˆæœ¬åœ¨ä¸åŒäººç¾¤ä¸­çš„è¡¨ç°ï¼ŒåŒæ—¶å‡å°‘æ½œåœ¨é—®é¢˜çš„å½±å“èŒƒå›´ã€‚
- **ç‰¹ç‚¹**ï¼šé€šå¸¸ä¼šç»“åˆA/Bæµ‹è¯•ï¼Œæ¯”è¾ƒæ–°æ—§ç‰ˆæœ¬çš„æ•ˆæœï¼ˆæ¯”å¦‚è½¬åŒ–ç‡ã€ç”¨æˆ·ä½“éªŒç­‰ï¼‰ã€‚
- **çµæ´»æ€§**ï¼šå¯ä»¥æ ¹æ®éœ€æ±‚è°ƒæ•´æ¨é€æ¯”ä¾‹ï¼Œæ¯”å¦‚å…ˆç»™10%ç”¨æˆ·ï¼Œå†ç»™30%ï¼Œæœ€å100%ã€‚

**ä¾‹å­**ï¼šä¸€ä¸ªæ‰‹æœºAppæ›´æ–°äº†ç•Œé¢è®¾è®¡ï¼Œå…ˆæ¨é€ç»™å®‰å“ç”¨æˆ·æµ‹è¯•ï¼Œç¡®è®¤æ²¡é—®é¢˜åå†æ¨ç»™iOSç”¨æˆ·ï¼Œæˆ–è€…å…ˆæ¨ç»™æŸä¸ªåŸå¸‚çš„ç”¨æˆ·ã€‚

**ä¸¤è€…çš„åŒºåˆ«**

- **èŒƒå›´**ï¼šé‡‘ä¸é›€å‘å¸ƒæ›´åƒæ˜¯ç°åº¦å‘å¸ƒçš„ä¸€ç§å…·ä½“å®ç°æ–¹å¼ï¼Œé€šå¸¸è§„æ¨¡æ›´å°ã€æ›´æ—©æœŸã€‚
- **ç›®æ ‡**ï¼šé‡‘ä¸é›€å‘å¸ƒæ›´å…³æ³¨â€œç¨³å®šæ€§æµ‹è¯•â€ï¼Œç°åº¦å‘å¸ƒå¯èƒ½è¿˜åŒ…æ‹¬â€œæ•ˆæœéªŒè¯â€ï¼ˆå¦‚ç”¨æˆ·æ»¡æ„åº¦ï¼‰ã€‚
- **æœ¯è¯­ä½¿ç”¨**ï¼šåœ¨å®é™…ä¸­ï¼Œè¿™ä¸¤ä¸ªè¯æœ‰æ—¶ä¼šè¢«æ··ç”¨ï¼Œä½†æ ¸å¿ƒéƒ½æ˜¯â€œé€æ­¥éƒ¨ç½²ã€é™ä½é£é™©â€ã€‚



é‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Releaseï¼‰å’Œç°åº¦å‘å¸ƒï¼ˆGrayscale Releaseï¼‰æ˜¯ç°ä»£è½¯ä»¶éƒ¨ç½²ä¸­å¸¸ç”¨çš„ç­–ç•¥ï¼Œç”¨äºåœ¨ä¸å½±å“æ‰€æœ‰ç”¨æˆ·çš„æƒ…å†µä¸‹é€æ­¥éªŒè¯æ–°ç‰ˆæœ¬çš„ç¨³å®šæ€§ã€‚Nginx Ingress æ§åˆ¶å™¨é€šè¿‡å…¶çµæ´»çš„é…ç½®ï¼ˆå¦‚ `canary` æ³¨è§£ï¼‰æ”¯æŒè¿™ç§å‘å¸ƒæ–¹å¼ã€‚æœ¬èŠ‚å°†é€šè¿‡åˆ›å»º v1 å’Œ v2 ç‰ˆæœ¬çš„æœåŠ¡ï¼Œæ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Ingress-Nginx å®ç°é‡‘ä¸é›€å‘å¸ƒï¼Œå¹¶å°†éƒ¨åˆ†æµé‡åˆ‡å…¥æ–°ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ã€‚

---

#### 4.6.1 åˆ›å»º v1 ç‰ˆæœ¬ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒçš„ Namespace å’ŒæœåŠ¡ï¼Œç”¨äºéƒ¨ç½² v1 ç‰ˆæœ¬çš„åº”ç”¨ã€‚

```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒçš„ Namespace
kubectl create ns production

# åˆ›å»º v1 ç‰ˆæœ¬çš„ Deployment
kubectl create deploy canary-v1 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v1 -n production

# æš´éœ² v1 ç‰ˆæœ¬çš„æœåŠ¡ç«¯å£
kubectl expose deploy canary-v1 --port 8080 -n production
```

åˆ›å»º Ingress èµ„æºï¼Œå°†æµé‡è·¯ç”±åˆ° v1 ç‰ˆæœ¬çš„æœåŠ¡ï¼š

```yaml
vim canary-v1.yaml

apiVersion: networking.k8s.io/v1  # æŒ‡å®š Kubernetes API ç‰ˆæœ¬ï¼Œè¿™é‡Œæ˜¯ Ingress çš„ v1 ç‰ˆæœ¬
kind: Ingress                     # èµ„æºç±»å‹ï¼Œè¿™é‡Œæ˜¯ Ingressï¼Œç”¨äºç®¡ç†å¤–éƒ¨è®¿é—®æµé‡
metadata:
  name: canary-v1                 # Ingress èµ„æºçš„åç§°
  namespace: production           # èµ„æºæ‰€åœ¨çš„å‘½åç©ºé—´ï¼Œè¿™é‡Œæ˜¯ production
spec:                             # å®šä¹‰ Ingress çš„å…·ä½“é…ç½®
  rules:                          # è·¯ç”±è§„åˆ™åˆ—è¡¨
  - host: canary.test.com         # æŒ‡å®šåŸŸåï¼Œåªæœ‰è®¿é—®è¿™ä¸ªåŸŸåæ—¶æ‰ä¼šåº”ç”¨ä¸‹é¢çš„è§„åˆ™
    http:                         # HTTP åè®®çš„é…ç½®
      paths:                      # è·¯å¾„è§„åˆ™åˆ—è¡¨
      - backend:                  # å®šä¹‰åç«¯æœåŠ¡
          service:                # æŒ‡å®šç›®æ ‡æœåŠ¡
            name: canary-v1       # åç«¯æœåŠ¡çš„åç§°ï¼Œè¿™é‡Œæ˜¯ canary-v1
            port:                 # æœåŠ¡ç«¯å£é…ç½®
              number: 8080        # æœåŠ¡ç›‘å¬çš„ç«¯å£å·ï¼Œè¿™é‡Œæ˜¯ 8080
        path: /                   # åŒ¹é…çš„è·¯å¾„ï¼Œè¿™é‡Œæ˜¯æ ¹è·¯å¾„
        pathType: ImplementationSpecific  # è·¯å¾„åŒ¹é…ç±»å‹ï¼ŒImplementationSpecific è¡¨ç¤ºç”±å…·ä½“å®ç°ï¼ˆå¦‚ Ingress Controllerï¼‰å†³å®šåŒ¹é…æ–¹å¼

kubectl create -f canary-v1.yaml
```

**è®¿é—®éªŒè¯ï¼š**

é€šè¿‡é…ç½®æœ¬åœ° hosts æ–‡ä»¶æˆ–ä½¿ç”¨ curl è®¿é—® `canary.test.com`ï¼Œå³å¯çœ‹åˆ° v1 ç‰ˆæœ¬çš„é¡µé¢ã€‚ä¾‹å¦‚ï¼š

```bash
curl -H "Host:canary.test.com" <k8s-master-ip>
```

è¿”å›å†…å®¹åº”ä¸º `<h1>Canary v1</h1>`ã€‚

#### 4.6.2 åˆ›å»º v2 ç‰ˆæœ¬ï¼ˆé‡‘ä¸é›€ç¯å¢ƒï¼‰

æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª v2 ç‰ˆæœ¬ï¼Œæ¨¡æ‹Ÿé‡‘ä¸é›€ç¯å¢ƒï¼Œç”¨äºæµ‹è¯•æ–°ç‰ˆæœ¬ã€‚

```bash
# åˆ›å»ºé‡‘ä¸é›€ç¯å¢ƒçš„ Namespace
kubectl create ns canary

# åˆ›å»º v2 ç‰ˆæœ¬çš„ Deployment
kubectl create deploy canary-v2 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v2 -n canary

# æš´éœ² v2 ç‰ˆæœ¬çš„æœåŠ¡ç«¯å£
kubectl expose deploy canary-v2 --port 8080 -n canary
```

**è®¿é—®éªŒè¯ï¼š**

æ£€æŸ¥ v2 ç‰ˆæœ¬çš„ Service æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

```bash
kubectl get svc -n canary
# ç¤ºä¾‹è¾“å‡ºï¼š
# NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
# canary-v2  ClusterIP   192.168.181.120  <none>        8080/TCP   2m

curl 192.168.181.120:8080
```

è¿”å›å†…å®¹åº”ä¸º `<h1>Canary v2</h1>`ã€‚

#### 4.6.3 é…ç½®é‡‘ä¸é›€å‘å¸ƒï¼ˆæµé‡åˆ‡åˆ†ï¼‰

ä¸ºäº†å°†éƒ¨åˆ†æµé‡åˆ‡å…¥ v2 ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦ä¸º v2 åˆ›å»ºä¸€ä¸ªå¸¦æœ‰é‡‘ä¸é›€é…ç½®çš„ Ingress èµ„æºã€‚Nginx Ingress æä¾›äº† `nginx.ingress.kubernetes.io/canary` å’Œ `nginx.ingress.kubernetes.io/canary-weight` æ³¨è§£ï¼Œç”¨äºæŒ‡å®šé‡‘ä¸é›€ç¯å¢ƒå’Œæµé‡æƒé‡ã€‚

```yaml
vim canary-v2.yaml

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"         # æ ‡è®°ä¸ºé‡‘ä¸é›€ç¯å¢ƒ
    nginx.ingress.kubernetes.io/canary-weight: "10"    # åˆ†é… 10% æµé‡åˆ° v2
  name: canary-v2
  namespace: canary
spec:
  rules:
  - host: canary.test.com
    http:
      paths:
      - backend:
          service:
            name: canary-v2
            port:
              number: 8080
        path: /
        pathType: ImplementationSpecific

kubectl create -f canary-v2.yaml
```

- **`nginx.ingress.kubernetes.io/canary: "true"`**ï¼šæ ‡è®°è¯¥ Ingress ä¸ºé‡‘ä¸é›€ç¯å¢ƒã€‚
- **`nginx.ingress.kubernetes.io/canary-weight: "10"`**ï¼šå°† 10% çš„æµé‡åˆ†é…ç»™ v2 ç‰ˆæœ¬ï¼Œå‰©ä½™ 90% ç»§ç»­è·¯ç”±åˆ° v1 ç‰ˆæœ¬ï¼ˆå³ v1:v2 = 9:1ï¼‰ã€‚

#### 4.6.4 æµ‹è¯•é‡‘ä¸é›€å‘å¸ƒ

ä¸ºäº†éªŒè¯æµé‡åˆ†é…æ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œå¯ä»¥ä½¿ç”¨è„šæœ¬æ¨¡æ‹Ÿå¤šæ¬¡è¯·æ±‚å¹¶ç»Ÿè®¡ v1 å’Œ v2 çš„è®¿é—®æ¯”ä¾‹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ Ruby è„šæœ¬ç¤ºä¾‹ï¼š

```ruby
# vim test-canary.rb

counts = Hash.new(0)
100.times do
  output = `curl -s -H "Host:canary.test.com" <k8s-master-ip> | grep 'Canary' | awk '{print $2}' | awk -F"<" '{print $1}'`
  counts[output.strip.split.last] += 1
end
puts counts
```

**è¿è¡Œæµ‹è¯•ï¼š**

1. å®‰è£… Rubyï¼ˆå¦‚æœæœªå®‰è£…ï¼‰ï¼š
   ```bash
   yum install ruby -y
   ```

2. æ‰§è¡Œè„šæœ¬å¹¶è§‚å¯Ÿç»“æœï¼š
   ```bash
   ruby test-canary.rb
   ```

   ç¤ºä¾‹è¾“å‡ºï¼š
   ```
   {"v1"=>90, "v2"=>10}
   {"v1"=>92, "v2"=>8}
   {"v1"=>91, "v2"=>9}
   ```

ç»“æœæ˜¾ç¤ºæµé‡å¤§è‡´æŒ‰ 9:1 çš„æ¯”ä¾‹åˆ†é…ï¼Œç¬¦åˆ `canary-weight: "10"` çš„é…ç½®ã€‚

#### 4.6.5 æ³¨æ„äº‹é¡¹

- **è°ƒæ•´æµé‡æƒé‡**ï¼šé€šè¿‡ä¿®æ”¹ `nginx.ingress.kubernetes.io/canary-weight` çš„å€¼ï¼ˆå¦‚ä» "10" è°ƒæ•´ä¸º "50"ï¼‰ï¼Œå¯ä»¥é€æ­¥å¢åŠ  v2 ç‰ˆæœ¬çš„æµé‡ï¼Œæœ€ç»ˆå®ç°å®Œå…¨åˆ‡æ¢ã€‚
- **å›æ»š**ï¼šå¦‚æœ v2 ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œåªéœ€åˆ é™¤ `canary-v2.yaml` çš„ Ingress èµ„æºï¼Œæ‰€æœ‰æµé‡å°†è‡ªåŠ¨å›æ»šåˆ° v1ã€‚
- **å…¶ä»–é‡‘ä¸é›€ç­–ç•¥**ï¼šé™¤äº†åŸºäºæƒé‡çš„æµé‡åˆ†é…ï¼ŒNginx Ingress è¿˜æ”¯æŒåŸºäºè¯·æ±‚å¤´ã€Cookie ç­‰æ¡ä»¶çš„é‡‘ä¸é›€å‘å¸ƒï¼Œå…·ä½“å¯å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/)ã€‚

---



## äº”ã€ç¯å¢ƒæ¸…ç†

æµ‹è¯•æ— è¯¯åï¼Œå¯ä»¥æ¸…ç†ä¹‹å‰çš„å­¦ä¹ æ•°æ®ï¼š
```bash
kubectl delete deploy,svc,ingress -n production --all

kubectl delete deploy,svc,ingress -n canary --all

kubectl delete deploy,svc,ingress -n study-ingress --all

kubectl delete ns study-ingress production canary
```







































